---
date: "2025-01-04"
author: dingyu
draft: false
tags:
- loki
- grafana
- lgtm
- monitoring
categories: ["lgtm"]
title: '[LGTM] Elasticsearch to Loki ì „í™˜ê¸°'
cover:
    image: img/lgtm.png
    relative: true
summary: ë‹¨ìˆœ ì• í”Œë¦¬ì¼€ì´ì…˜ ëª¨ë‹ˆí„°ë§ ëª©ì ì„ ë‘ê³  ë³´ì•˜ì„ ë•Œ.. ê³¼ì—° Elasticsearch ì²˜ëŸ¼ ë¬´ê±°ìš´ ì„œë¹„ìŠ¤ë¥¼ ì‚¬ìš©í•´ì•¼í• ê¹Œ? Lokië¡œ ì „í™˜í•˜ë©´ì„œ ê²ªì€ ì‹œí–‰ì°©ì˜¤ë¥¼ ì†Œê°œí•©ë‹ˆë‹¤
description: This article explores the transition from Elasticsearch to Loki for cost-efficient log management, highlighting key differences in storage, indexing, and query performance. It covers best practices for optimizing Loki's labeling strategy, managing chunk storage, and handling high-cardinality data. Additionally, it provides a step-by-step guide to configuring Grafana dashboards for efficient log analysis, including Raw Logs, Error Logs, TPS (P50/P99), Log Distributions, and Table Views.
comments: true
---

# ì™œ Loki?
ë°±ì—”ë“œ ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ ë¡œê·¸ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì‚¬ìš©ì ë¬¸ì˜ì— ëŒ€í•œ ES ì¿¼ë¦¬ë¥¼ ìˆ˜í–‰í•˜ê±°ë‚˜, ìš´ì˜íŒ€ì— ì‹œê°ì ìœ¼ë¡œ ë¦¬í¬íŠ¸ê°€ ê°€ëŠ¥í•œ Kibana ëŒ€ì‹œë³´ë“œë¥¼ ìì£¼ ì‚¬ìš©í•˜ê³¤ í–ˆë‹¤.

_"ì™œ Lokië¡œ ì „í™˜í•˜ëŠëƒ?"_ ë¼ê³  ë¬»ëŠ”ë‹¤ë©´...  
_"ë¹„ìš©ì ì¸ ì ˆê°ì„ ìœ„í•´ì„œ!"_ ë¼ê³  ë‹µí•  ê²ƒì´ë‹¤.

| í•­ëª©            | Loki ğŸŸ¢                             | Elasticsearch ğŸ”´              |
| ------------- | ----------------------------------- | ----------------------------- |
| **ë°ì´í„° ì €ì¥ ë°©ì‹** | ë©”íƒ€ë°ì´í„°ë§Œ ì €ì¥, ì›ë³¸ ë¡œê·¸ëŠ” Object Storage í™œìš© | ëª¨ë“  ë¡œê·¸ë¥¼ ì¸ë±ì‹±í•˜ì—¬ ì €ì¥               |
| **ê²€ìƒ‰ ë°©ì‹**     | ë¼ë²¨ ê¸°ë°˜ ê²€ìƒ‰                            | ì •êµí•œ í…ìŠ¤íŠ¸ ê²€ìƒ‰ (Full-text search) |
| **ì¸ë±ì‹± ë¹„ìš©**    | ë‚®ìŒ                                  | ë†’ìŒ (ì¸ë±ì‹±ì— CPU, ë©”ëª¨ë¦¬ ë§ì´ ì‚¬ìš©)      |
| **ìŠ¤í† ë¦¬ì§€ ë¹„ìš©**   | ì €ë ´í•¨ (S3, GCS ë“± ì™¸ë¶€ ìŠ¤í† ë¦¬ì§€ í™œìš© ê°€ëŠ¥)       | ë¹„ìŒˆ (Elasticsearch ì „ìš© ë…¸ë“œ í•„ìš”)   |
| **ì„±ëŠ¥**        | ëŒ€ëŸ‰ ë¡œê·¸ ì €ì¥ ì‹œ ì„±ëŠ¥ ìš°ìˆ˜                    | ë¹ ë¥¸ ê²€ìƒ‰ ì†ë„                      |
| **í™•ì¥ì„±**       | ê°„ë‹¨í•œ êµ¬ì„±ìœ¼ë¡œ í™•ì¥ ê°€ëŠ¥                      | í´ëŸ¬ìŠ¤í„° í™•ì¥ì´ ë¹„êµì  ë³µì¡               |
| **ìš´ì˜ ë¶€ë‹´**     | ì ìŒ (ë³„ë„ í´ëŸ¬ìŠ¤í„° ê´€ë¦¬ ë¶€ë‹´ ì—†ìŒ)               | ë†’ìŒ (í´ëŸ¬ìŠ¤í„° ê´€ë¦¬ í•„ìš”)               |
| **ì‚¬ìš© ì‚¬ë¡€**     | ë‹¨ìˆœ ë¡œê·¸ ì €ì¥ ë° ì¡°íšŒ                       | ë³µì¡í•œ ê²€ìƒ‰ ë° ë°ì´í„° ë¶„ì„               |

![](image.png)

live-plex-private-archive

## ê³ ë ¤ì‚¬í•­ ì²´í¬ë¦¬ìŠ¤íŠ¸
- [x]ë³„ë„ì˜ ëŒ€ì‹œë³´ë“œë¥¼ ì™¸ë¶€ì— ì œê³µí•  í•„ìš”ê°€ ì—†ëŠ”ê°€?
- [x]ì´ìŠˆ ë°œìƒ ì‹œ, ë‹¨ìˆœ ë¡œê·¸ ì¡°íšŒ ìš©ë„ë§Œ í•„ìš”í•œê°€?

## Loki ì—°ë™ ì‹œ
> **ë¼ë²¨ ê°’ì´ ë§¤ìš° ë‹¤ì–‘**í•˜ê±°ë‚˜ **ê³ ìœ í•œ ê°’ì´ ë§ì•„ì§€ë©´**, Lokiì˜ **ì¸ë±ì‹± ì‹œìŠ¤í…œì´ ë¹„íš¨ìœ¨ì **ìœ¼ë¡œ ì‘ë™
> - example:Â `user_id`,Â `timestamp`ì™€ ê°™ì´ **ê³ ìœ í•œ ê°’ì´ ìì£¼ ë°”ë€ŒëŠ” í•„ë“œë¥¼ ë¼ë²¨ë¡œ ì§€ì •í•˜ë©´ ì¸ë±ìŠ¤ í¬ê¸°ê°€ ê¸‰ê²©íˆ ì»¤ì§**
> 
> **ê²°ê³¼**:
> - **ì¿¼ë¦¬ ì„±ëŠ¥ ì €í•˜**
> - **ë©”ëª¨ë¦¬ ê³¼ë‹¤ ì‚¬ìš©**
> - **ì €ì¥ ë¹„ìš© ì¦ê°€**

### ê³ ì •ëœ ê°’ ì¤‘ì‹¬ìœ¼ë¡œ ë¼ë²¨ êµ¬ì„±í•˜ê¸°
ë‚®ì€ ì¹´ë””ë„ë¦¬í‹° ìœ ì§€í•˜ê¸° ìœ„í•´ ë¼ë²¨ êµ¬ì„±
- ë¼ë²¨ ê°’ì€ ê°€ëŠ¥í•œ í•œ ê³ ì •ì ì´ê±°ë‚˜ ë³€ê²½ ë²”ìœ„ê°€ ì œí•œëœ ê°’ì„ ì‚¬ìš©
- example
    - **Good** ğŸ˜Š:Â **`region="us-east-1"`,Â `app="payment-service"`**
    - **Bad** ğŸ˜¥: Â **`user_id="12345"`,Â `request_id="abcd-efgh"`**

### í•„í„°ë§ ëª©ì ì— ë§ëŠ” ë¼ë²¨ë§Œ ì‚¬ìš©
ë¼ë²¨ ì„¤ê³„ ì‹œ, ì¶”í›„ ì–´ë– í•œ ë¡œê·¸ í•„ë“œë¡œ ì–´ë– í•œ ëŒ€ì‹œë³´ë“œë¥¼ êµ¬ì„±í•  ê²ƒì¸ì§€ ìƒì„¸í•˜ê²Œ ì„¤ê³„í•œë‹¤
- ë¼ë²¨ì€ ì‹¤ì œ ê²€ìƒ‰, í•„í„°ë§, ë¶„ì„ì— í•„ìš”í•œ ë°ì´í„°ì—ë§Œ ì§€ì •
- ë¶ˆí•„ìš”í•˜ê±°ë‚˜ ë””ë²„ê¹…ë§Œì„ ìœ„í•œ ë¼ë²¨ì€ í”¼í•œë‹¤
- example
    - **Good** ğŸ˜Š: API ìš”ì²­ì— ë”°ë¥¸ ìš”ì²­ ëŸ‰ì— ëŒ€í•œ ì§‘ê³„ê°€ í•„ìš”í•œ ê²½ìš°(TPS, latency ë“±), Request ë‹¹ í•œë²ˆë§Œ ì¡´ì¬í•˜ëŠ” ë¡œê·¸ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì„¤ê³„ â†’ func="LogMiddleware.Log" ì¤‘ latency ì‚¬ìš© â†’ **labelì„ funcë¡œ ë“±ë¡**
    - **Bad** ğŸ˜¥: **latencyë¥¼ labelë¡œ ì§€ì •**

### ë¡œê·¸ ë©”ì‹œì§€ì™€ ë©”íƒ€ë°ì´í„° ë¶„ë¦¬
Labelì€ Raw Logë¥¼ ì‹ë³„í•  ìˆ˜ ìˆëŠ” "Tag"ì™€ ê°€ê¹Œì›€.. ë¼ë²¨ì€ ë©”íƒ€ë°ì´í„°ë¡œë§Œ í™œìš©, ì‹¤ì œ ë™ì ì¸ ê°’ì€ ë¡œê·¸ ë©”ì‹œì§€ ë³¸ë¬¸ì— í¬í•¨
- example
    - **Good ğŸ˜Š: label:func="RestrictionsService" line:member_sn ="12341512321", message="restricted member"**
    - **Bad ğŸ˜¥: **label:member_sn="12341512321" line:message ="restricted member", func="RestrictionsService"**

### ë¼ë²¨ ê°œìˆ˜ ì œí•œ
Label ìì²´ë¥¼ ë§ì´ ì„¤ì •í•œ ê²½ìš°.. ì´ ë˜í•œ ê³  ì¹´ë””ë„ë¦¬í‹°ë¡œ ì¸ë±ìŠ¤ íš¨ìœ¨ì´ ë¹„íš¨ìœ¨ì ì´ë‹¤
- Loki ê³µì‹ ê¶Œì¥ì‚¬í•­ì— ë”°ë¥´ë©´, **ë¼ë²¨ ìˆ˜ëŠ” 20ê°œ ì´í•˜ë¡œ ìœ ì§€**í•˜ëŠ” ê²ƒì´ ì¢‹ìŒ

### ë¼ë²¨ì˜ ìœ ë‹ˆí¬ ê°’ ê°œìˆ˜ ì œí•œ
LokiëŠ” ë¼ë²¨ë‹¹ 1,000ê°œ ë¯¸ë§Œì˜ ìœ ë‹ˆí¬ ê°’ì„ ê¶Œì¥í•©ë‹ˆë‹¤.
ì˜ˆë¥¼ ë“¤ì–´, `status="200"`, `status="500"` ê°™ì€ ì •í•´ì§„ ê°’ì€ ë¬¸ì œì—†ì§€ë§Œ,
`user_id="12345"`, `session_id="abcd-efgh"` ê°™ì€ ê°’ì€ ë¼ë²¨ë¡œ ì‚¬ìš©í•˜ë©´ ì•ˆ ë¨.
- example
- Good ğŸ˜Š: env="production", service="payments", region="us-east-1"
- Bad ğŸ˜¥: user_id="12345", request_id="xyz-789"

### Chunk í¬ê¸°ì™€ ë³´ê´€ ì£¼ê¸° ê³ ë ¤í•˜ê¸°
LokiëŠ” ë¡œê·¸ë¥¼ Chunk ë‹¨ìœ„ë¡œ ì €ì¥í•˜ë©°, ì¼ì • ì£¼ê¸°ë§ˆë‹¤ Object Storageë¡œ Flushing ë¨.
Chunk í¬ê¸°ê°€ ë„ˆë¬´ ì‘ìœ¼ë©´ â†’ ì„±ëŠ¥ì´ ì €í•˜ë˜ê³ , ë„ˆë¬´ í¬ë©´ â†’ ê²€ìƒ‰ ì†ë„ê°€ ëŠë ¤ì§ˆ ìˆ˜ ìˆìŒ.
- chunk_encoding: gzip 
- chunk_target_size: 1MB~2MB (case by case)

## ëŒ€ì‹œë³´ë“œ êµ¬ì„±í•˜ê¸°
1. Variable ì„¤ì •í•˜ê¸°
Variableì˜ ê²½ìš°, ì „ì²´ ë¡œê·¸ì—ì„œ í•„í„°ë¥¼ ì ìš©í•´ì¤˜ì•¼ í•˜ëŠ” ë²ˆê±°ë¡œì›€ì´ ìˆì§€ë§Œ... ë¯¸ë˜ì— ëª¨ë‹ˆí„°ë§ì„ í•˜ê³  ìˆì„ ìì‹ ì—ê²Œ ì„ ì‚¬í•˜ëŠ” ì‘ì€ ì„ ë¬¼ì´ë‹¤

Application ë¡œê·¸ì˜ ê²½ìš°, ì£¼ë¡œ `raw log`ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì¿¼ë¦¬í•˜ê¸° ë•Œë¬¸ì— ë¹ ë¥´ê²Œ í•„í„°ë§ í•  ìˆ˜ ìˆëŠ” labelì„ Variableë¡œ ë‘ëŠ” ê²ƒì´ ì¢‹ë‹¤

`raw log` / `error log`ì—ì„œ í•„í„°ë§ ëœ ë¡œê·¸ ì¤‘ ë¹ ë¥¸ íŒŒì•…ì„ ìœ„í•´ text box filterë¥¼ ë‘ì–´ 2ì°¨ë¡œ ê±¸ëŸ¬ ì£¼ëŠ” ê²ƒì´ ë°”ëŒì§í•  ê²ƒì„!

![](image-1.png)

2. raw log êµ¬ì„±í•˜ê¸°
ì•± ì „ì—­ì—ì„œ ë‚¨ê¸°ëŠ” ë¡œê·¸ë¥¼ ì‰½ê²Œ í™•ì¸í•´ë³´ê¸° ìœ„í•´ ëª¨ë“  ë¡œê·¸ë¥¼ í•œëˆˆì— ë³¼ ìˆ˜ ìˆëŠ” `Logs Visualization`ìœ¼ë¡œ ì‹œì‘í•´ë³´ì

example
```
{_type="loki"} |= `$filter`
```

3. log levelì— ë”°ë¥¸ error log êµ¬ì„±í•˜ê¸°
`raw log`ì—ì„œ duplicateë¥¼ í†µí•´ errorì¸ ë¡œê·¸ë§Œ ë‚¨ê²¨ë³´ì
> ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì— ë”°ë¼ ì—ëŸ¬ì„ì—ë„ ì—ëŸ¬ë¡œ ì²˜ë¦¬í•˜ì§€ ì•ŠëŠ” ì˜ˆì™¸ ì¼€ì´ìŠ¤ê°€ ì¡´ì¬í•œë‹¤. ì´ë¥¼ ìœ ì˜í•˜ì—¬ log levelì„ ë¯¸ë¦¬ ì§€ì •í•˜ì

example
```
{level="error"}
```

4. TPS êµ¬ì„±í•˜ê¸°
ê·¹í•œì˜ ì™„ì„±ë„ëŠ” ì†ë„ì—ì„œ ë“¤ì–´ë‚˜ëŠ” ë²•.. ëŒ€ì‹œë³´ë“œ êµ¬ì„±ì‹œ P50, P99ëŠ” ë§¤ë²ˆ ì±™ê¸°ëŠ” ì§€í‘œì´ë‹¤

Gauge Visualizationìœ¼ë¡œ `quantile_over_time`ì„ ì‚¬ìš©í•˜ì—¬ PXXë¥¼ í™•ì¸í•´ë³´ì.
ë‹¨ ì•„ë˜ì™€ ê°™ì€ ìœ ì˜ ì‚¬í•­ì´ ìˆë‹¤. (prometheusê°€ ì•„ë‹Œ loki+grafanaì— ì´ˆì ì„ ë§ì¶”ì—ˆìœ¼ë‹ˆ ì–‘í•´ë¥¼ êµ¬í•©ë‹ˆë‹¤)
> - Prometheusì²˜ëŸ¼ TSDB(Time-Series Database)ì—ì„œ íš¨ìœ¨ì ìœ¼ë¡œ ë°±ë¶„ìœ„ìˆ˜ë¥¼ ê³„ì‚°í•˜ëŠ” ê²ƒì´ ì•„ë‹˜
> - ëŒ€ëŸ‰ì˜ ë¡œê·¸ë¥¼ ì²˜ë¦¬í•  ê²½ìš° ì„±ëŠ¥ ì €í•˜ ë°œìƒ ê°€ëŠ¥
> - `quantile_over_time` ì—°ì‚°ì´ ë©”ëª¨ë¦¬ ì§‘ì•½ì ì´ë©°, í° ë²”ìœ„ì—ì„œ ì‹¤í–‰ ì‹œ ë¹„ìš©ì´ ë†’ìŒ

example
```
quantile_over_time(0.50, {func="LogMiddleware.Log"} |= `$filter` | json | unwrap latency [$__range]) by (func)
```

5. Labelì— ë”°ë¥¸ Distribution êµ¬ì„±í•˜ê¸°
`Piechart`ëŠ” ì „ë°˜ì ì¸ ë¶„í¬ë„ë¥¼ ì¡°ì‚¬í•˜ê¸°ì— ì•Œë§ë‹¤. ë‹¨, Labelì´ ì§€ì •ë˜ì–´ì•¼ í•˜ê¸°ì— Uniqueí•œ Labelì˜ ë¶„í¬ì¼ ê²½ìš°ì—ë§Œ êµ¬ì„±í•˜ì

example
```
sum by(method) (count_over_time({func="LogMiddleware.Log"} |= `$filter` [$__auto]))
```

6. Tableì„ í†µí•´ Distribution ë° í•„í„°ë§ êµ¬ì„±í•˜ê¸°
`Table`ì€ ì‹œê°ì ìœ¼ë¡œ í•œëˆˆì— ë¶„í¬ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìœ¼ë©° ì•„ë˜ì™€ ê°™ì´ êµ¬ì„±í•  ê²½ìš°, í´ë¦­ì„ í†µí•´ í•´ë‹¹ ë¼ë²¨ì— ëŒ€í•œ ë¡œê·¸ë¥¼ í•„í„°ë§ í•  ìˆ˜ ìˆë‹¤

example
```
sum by(method) (count_over_time({func="LogMiddleware.Log"} |= `$filter` [$__auto]))
```

### ëŒ€ì‹œë³´ë“œ ì™„ì„±ë³¸
![](loki-grafana-dashboard.png)

### REFS
- [6 easy ways to improve your log dashboards with Grafana and Grafana Loki](https://grafana.com/blog/2023/05/18/6-easy-ways-to-improve-your-log-dashboards-with-grafana-and-grafana-loki/)
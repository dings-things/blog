<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>[LGTM] Elasticsearch to Loki Migration Story | Ding's Coding Forge</title>
<meta name=keywords content="loki,grafana,lgtm,monitoring"><meta name=description content="This article explores the transition from Elasticsearch to Loki for cost-efficient log management, highlighting key differences in storage, indexing, and query performance. It covers best practices for optimizing Loki's labeling strategy, managing chunk storage, and handling high-cardinality data. Additionally, it provides a step-by-step guide to configuring Grafana dashboards for efficient log analysis, including Raw Logs, Error Logs, TPS (P50/P99), Log Distributions, and Table Views."><meta name=author content="dingyu"><link rel=canonical href=https://dingyu.dev/en/posts/es-to-loki/><meta name=google-site-verification content="8XY1hI6NVxQIrN7bQbnX-9TG9HHFw5HOQmlb6vcsFdQ"><meta name=yandex-verification content="XYZabc"><meta name=msvalidate.01 content="XYZabc"><link crossorigin=anonymous href=/assets/css/stylesheet.678f9035c217c5346e0b3de5bdc9ebac02c53b0502219858f8653d8d181c97b3.css integrity="sha256-Z4+QNcIXxTRuCz3lvcnrrALFOwUCIZhY+GU9jRgcl7M=" rel="preload stylesheet" as=style><link rel=icon href=https://dingyu.dev/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://dingyu.dev/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://dingyu.dev/favicon-32x32.png><link rel=apple-touch-icon href=https://dingyu.dev/apple-touch-icon.png><link rel=mask-icon href=https://dingyu.dev/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=ko href=https://dingyu.dev/posts/es-to-loki/><link rel=alternate hreflang=en href=https://dingyu.dev/en/posts/es-to-loki/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=G-XH8830R9KK"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-XH8830R9KK")}</script><meta property="og:url" content="https://dingyu.dev/en/posts/es-to-loki/"><meta property="og:site_name" content="Ding's Coding Forge"><meta property="og:title" content="[LGTM] Elasticsearch to Loki Migration Story"><meta property="og:description" content="This article explores the transition from Elasticsearch to Loki for cost-efficient log management, highlighting key differences in storage, indexing, and query performance. It covers best practices for optimizing Loki's labeling strategy, managing chunk storage, and handling high-cardinality data. Additionally, it provides a step-by-step guide to configuring Grafana dashboards for efficient log analysis, including Raw Logs, Error Logs, TPS (P50/P99), Log Distributions, and Table Views."><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-01-04T00:00:00+00:00"><meta property="article:modified_time" content="2025-01-04T00:00:00+00:00"><meta property="article:tag" content="Loki"><meta property="article:tag" content="Grafana"><meta property="article:tag" content="Lgtm"><meta property="article:tag" content="Monitoring"><meta property="og:image" content="https://dingyu.dev/en/posts/es-to-loki/img/lgtm.png"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://dingyu.dev/en/posts/es-to-loki/img/lgtm.png"><meta name=twitter:title content="[LGTM] Elasticsearch to Loki Migration Story"><meta name=twitter:description content="This article explores the transition from Elasticsearch to Loki for cost-efficient log management, highlighting key differences in storage, indexing, and query performance. It covers best practices for optimizing Loki's labeling strategy, managing chunk storage, and handling high-cardinality data. Additionally, it provides a step-by-step guide to configuring Grafana dashboards for efficient log analysis, including Raw Logs, Error Logs, TPS (P50/P99), Log Distributions, and Table Views."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://dingyu.dev/en/posts/"},{"@type":"ListItem","position":2,"name":"[LGTM] Elasticsearch to Loki Migration Story","item":"https://dingyu.dev/en/posts/es-to-loki/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"[LGTM] Elasticsearch to Loki Migration Story","name":"[LGTM] Elasticsearch to Loki Migration Story","description":"This article explores the transition from Elasticsearch to Loki for cost-efficient log management, highlighting key differences in storage, indexing, and query performance. It covers best practices for optimizing Loki's labeling strategy, managing chunk storage, and handling high-cardinality data. Additionally, it provides a step-by-step guide to configuring Grafana dashboards for efficient log analysis, including Raw Logs, Error Logs, TPS (P50/P99), Log Distributions, and Table Views.","keywords":["loki","grafana","lgtm","monitoring"],"articleBody":"Why Loki? In backend applications, we often used Elasticsearch queries to investigate user issues and visualized dashboards using Kibana for operational teams.\nIf asked, ‚ÄúWhy switch to Loki?‚Äù the answer is simple: ‚ÄúTo reduce cost!‚Äù\nCategory Loki üü¢ Elasticsearch üî¥ Storage Model Stores metadata only; raw logs in object storage Indexes and stores all logs Search Method Label-based search Full-text search Indexing Cost Low High (CPU/memory intensive) Storage Cost Cheap (S3/GCS object storage) Expensive (dedicated nodes needed) Performance Efficient for massive log storage Fast for query Scalability Easy to scale with simple configuration Cluster scaling is more complex Ops Overhead Low (no need to manage cluster) High (cluster management required) Use Case Simple log storage and retrieval Complex analysis and search Pre-Migration Checklist No need to expose dashboards to external stakeholders? Do you only need basic log viewing during incidents? Notes When Integrating Loki When labels are too diverse or contain too many unique values, Loki‚Äôs indexing becomes inefficient.\nExample: assigning fields like user_id or timestamp as labels can cause a rapid index size increase. Consequences:\nSlow query performance High memory usage Increased storage cost Use Fixed, Low-Cardinality Labels To keep cardinality low:\nUse static or limited-range values as labels Examples: Good üòä: region=\"us-east-1\", app=\"payment-service\" Bad üò•: user_id=\"12345\", request_id=\"abcd-efgh\" Only Use Labels Relevant to Filtering Design labels based on how you plan to filter/search logs in dashboards:\nUse labels only for data that will be filtered or analyzed Avoid labels used solely for debugging Examples: Good üòä: For tracking TPS/latency, design labels around logs that appear once per request ‚Üí e.g. func=\"LogMiddleware.Log\" Bad üò•: Using latency itself as a label Separate Log Message from Metadata Labels should serve as tags. Dynamic values should go inside the log message.\nExamples: Good üòä: label:func=\"RestrictionsService\", log: member_id=\"12341512321\", message=\"restricted member\" Bad üò•: label:member_id=\"12341512321\", log: message=\"restricted member\", func=\"RestrictionsService\" Limit the Number of Labels Too many labels = high cardinality ‚Üí indexing inefficiency.\nLoki‚Äôs official recommendation: keep labels under 20. Limit Unique Values per Label Loki recommends fewer than 1,000 unique values per label.\nAcceptable: status=\"200\", status=\"500\" Avoid: user_id=\"12345\", session_id=\"abcd-efgh\" Examples: Good üòä: env=\"production\", service=\"payments\", region=\"us-east-1\" Bad üò•: user_id=\"12345\", request_id=\"xyz-789\" Tune Chunk Size and Retention Loki stores logs in chunks and flushes them to object storage periodically.\nToo small chunks ‚Üí low performance Too large chunks ‚Üí slow search Recommended: chunk_encoding: gzip chunk_target_size: 1MB~2MB (adjust as needed) Building the Dashboard 1. Set Up Variables While filtering with Variables adds complexity, it‚Äôs a gift to your future self.\nApplication logs are usually queried using raw log, so choose frequently used filter labels as variables. Also add text box filters to refine the filtered results.\n2. Build Raw Logs Panel Start with a global log viewer using Logs Visualization.\nExample:\n{_type=\"loki\"} |= `$filter` 3. Filter Error Logs by Log Level From raw log, duplicate and filter only error level logs.\nSome business logic might bypass error tagging‚Äîmake sure log levels are properly set.\nExample:\n{level=\"error\"} 4. Track TPS with Quantiles Precision = speed. Use P50, P99 as standard metrics with Gauge Visualization using quantile_over_time.\nNote:\nUnlike Prometheus TSDB, Loki doesn‚Äôt compute percentiles efficiently High volume log ranges may degrade performance quantile_over_time is memory intensive and expensive at large time ranges Example:\nquantile_over_time(0.50, {func=\"LogMiddleware.Log\"} |= `$filter` | json | unwrap latency [$__range]) by (func) 5. Build Distributions by Label Use Piechart to understand overall log distribution.\nLabels must be used, so apply this only to unique label values\nExample:\nsum by(method) (count_over_time({func=\"LogMiddleware.Log\"} |= `$filter` [$__auto])) 6. Use Table to Visualize and Filter Distributions Table is great for at-a-glance inspection. You can make labels clickable for filtering.\nExample:\nsum by(method) (count_over_time({func=\"LogMiddleware.Log\"} |= `$filter` [$__auto])) Final Dashboard References 6 easy ways to improve your log dashboards with Grafana and Grafana Loki ","wordCount":"620","inLanguage":"en","image":"https://dingyu.dev/en/posts/es-to-loki/img/lgtm.png","datePublished":"2025-01-04T00:00:00Z","dateModified":"2025-01-04T00:00:00Z","author":{"@type":"Person","name":"dingyu"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://dingyu.dev/en/posts/es-to-loki/"},"publisher":{"@type":"Organization","name":"Ding's Coding Forge","logo":{"@type":"ImageObject","url":"https://dingyu.dev/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://dingyu.dev/en/ accesskey=h title="Ding's Coding Forge (Alt + H)"><img src=https://dingyu.dev/apple-touch-icon.png alt aria-label=logo height=35>Ding's Coding Forge</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
</button><span class=nav-separator>|</span><div class=lang-select-dropdown><button class=lang-select-dropdown-trigger aria-label=Translations type=button><svg xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 512 512" width="24" height="18"><path d="M478.33 433.6l-90-218a22 22 0 00-40.67.0l-90 218a22 22 0 1040.67 16.79L316.66 406h102.67l18.33 44.39A22 22 0 00458 464a22 22 0 0020.32-30.4zM334.83 362 368 281.65 401.17 362z" fill="currentcolor"/><path d="M267.84 342.92a22 22 0 00-4.89-30.7c-.2-.15-15-11.13-36.49-34.73 39.65-53.68 62.11-114.75 71.27-143.49H330a22 22 0 000-44H214V70a22 22 0 00-44 0v20H54a22 22 0 000 44h197.25c-9.52 26.95-27.05 69.5-53.79 108.36-31.41-41.68-43.08-68.65-43.17-68.87a22 22 0 00-40.58 17c.58 1.38 14.55 34.23 52.86 83.93.92 1.19 1.83 2.35 2.74 3.51-39.24 44.35-77.74 71.86-93.85 80.74a22 22 0 1021.07 38.63c2.16-1.18 48.6-26.89 101.63-85.59 22.52 24.08 38 35.44 38.93 36.1a22 22 0 0030.75-4.9z" fill="currentcolor"/></svg></button><div class=lang-select-dropdown-content><a lang=ko href=https://dingyu.dev/ title=ÌïúÍµ≠Ïñ¥ aria-label=ÌïúÍµ≠Ïñ¥>ÌïúÍµ≠Ïñ¥</a></div></div></div></div><ul id=menu><li><a href=https://dingyu.dev/en/about/ title=About><span>About</span></a></li><li><a href=https://dingyu.dev/en/categories/ title=Categories><span>Categories</span></a></li><li><a href=https://dingyu.dev/en/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://dingyu.dev/en/archives/ title=Archives><span>Archives</span></a></li><li><a href=https://dingyu.dev/en/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://dingyu.dev/en/>Home</a>&nbsp;¬ª&nbsp;<a href=https://dingyu.dev/en/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">[LGTM] Elasticsearch to Loki Migration Story</h1><div class=post-description>This article explores the transition from Elasticsearch to Loki for cost-efficient log management, highlighting key differences in storage, indexing, and query performance. It covers best practices for optimizing Loki's labeling strategy, managing chunk storage, and handling high-cardinality data. Additionally, it provides a step-by-step guide to configuring Grafana dashboards for efficient log analysis, including Raw Logs, Error Logs, TPS (P50/P99), Log Distributions, and Table Views.</div><div class=post-meta><span title='2025-01-04 00:00:00 +0000 UTC'>January 4, 2025</span>&nbsp;¬∑&nbsp;3 min&nbsp;¬∑&nbsp;620 words&nbsp;¬∑&nbsp;dingyu&nbsp;|&nbsp;Translations:<ul class=i18n_list><li><a href=https://dingyu.dev/posts/es-to-loki/>Ko</a></li></ul>&nbsp;|&nbsp;<a href=https://github.com/dings-things/blog/tree/main/content/posts/es-to-loki/index.en.md rel="noopener noreferrer" target=_blank>Suggest Changes</a></div></header><figure class=entry-cover><img loading=eager src=https://dingyu.dev/img/lgtm.png alt></figure><aside id=toc-container class="toc-container wide"><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#why-loki aria-label="Why Loki?">Why Loki?</a><ul><li><a href=#pre-migration-checklist aria-label="Pre-Migration Checklist">Pre-Migration Checklist</a></li><li><a href=#notes-when-integrating-loki aria-label="Notes When Integrating Loki">Notes When Integrating Loki</a><ul><li><a href=#use-fixed-low-cardinality-labels aria-label="Use Fixed, Low-Cardinality Labels">Use Fixed, Low-Cardinality Labels</a></li><li><a href=#only-use-labels-relevant-to-filtering aria-label="Only Use Labels Relevant to Filtering">Only Use Labels Relevant to Filtering</a></li><li><a href=#separate-log-message-from-metadata aria-label="Separate Log Message from Metadata">Separate Log Message from Metadata</a></li><li><a href=#limit-the-number-of-labels aria-label="Limit the Number of Labels">Limit the Number of Labels</a></li><li><a href=#limit-unique-values-per-label aria-label="Limit Unique Values per Label">Limit Unique Values per Label</a></li><li><a href=#tune-chunk-size-and-retention aria-label="Tune Chunk Size and Retention">Tune Chunk Size and Retention</a></li></ul></li><li><a href=#building-the-dashboard aria-label="Building the Dashboard">Building the Dashboard</a><ul><li><a href=#1-set-up-variables aria-label="1. Set Up Variables">1. Set Up Variables</a></li><li><a href=#2-build-raw-logs-panel aria-label="2. Build Raw Logs Panel">2. Build Raw Logs Panel</a></li><li><a href=#3-filter-error-logs-by-log-level aria-label="3. Filter Error Logs by Log Level">3. Filter Error Logs by Log Level</a></li><li><a href=#4-track-tps-with-quantiles aria-label="4. Track TPS with Quantiles">4. Track TPS with Quantiles</a></li><li><a href=#5-build-distributions-by-label aria-label="5. Build Distributions by Label">5. Build Distributions by Label</a></li><li><a href=#6-use-table-to-visualize-and-filter-distributions aria-label="6. Use Table to Visualize and Filter Distributions">6. Use Table to Visualize and Filter Distributions</a></li><li><a href=#final-dashboard aria-label="Final Dashboard">Final Dashboard</a></li><li><a href=#references aria-label=References>References</a></li></ul></li></ul></li></ul></div></details></div></aside><script>let activeElement,elements;window.addEventListener("DOMContentLoaded",function(){checkTocPosition(),elements=document.querySelectorAll("h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]"),activeElement=elements[0];const t=encodeURI(activeElement.getAttribute("id")).toLowerCase();document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active")},!1),window.addEventListener("resize",function(){checkTocPosition()},!1),window.addEventListener("scroll",()=>{activeElement=Array.from(elements).find(e=>{if(getOffsetTop(e)-window.pageYOffset>0&&getOffsetTop(e)-window.pageYOffset<window.innerHeight/2)return e})||activeElement,elements.forEach(e=>{const t=encodeURI(e.getAttribute("id")).toLowerCase();e===activeElement?document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active"):document.querySelector(`.inner ul li a[href="#${t}"]`).classList.remove("active")})},!1);const main=parseInt(getComputedStyle(document.body).getPropertyValue("--article-width"),10),toc=parseInt(getComputedStyle(document.body).getPropertyValue("--toc-width"),10),gap=parseInt(getComputedStyle(document.body).getPropertyValue("--gap"),10);function checkTocPosition(){const e=document.body.scrollWidth;e-main-toc*2-gap*4>0?document.getElementById("toc-container").classList.add("wide"):document.getElementById("toc-container").classList.remove("wide")}function getOffsetTop(e){if(!e.getClientRects().length)return 0;let t=e.getBoundingClientRect(),n=e.ownerDocument.defaultView;return t.top+n.pageYOffset}</script><div class=post-content><h1 id=why-loki>Why Loki?<a hidden class=anchor aria-hidden=true href=#why-loki>#</a></h1><p>In backend applications, we often used Elasticsearch queries to investigate user issues and visualized dashboards using Kibana for operational teams.</p><p>If asked, <em>&ldquo;Why switch to Loki?&rdquo;</em> the answer is simple:
<em>&ldquo;To reduce cost!&rdquo;</em></p><table><thead><tr><th>Category</th><th>Loki üü¢</th><th>Elasticsearch üî¥</th></tr></thead><tbody><tr><td><strong>Storage Model</strong></td><td>Stores metadata only; raw logs in object storage</td><td>Indexes and stores all logs</td></tr><tr><td><strong>Search Method</strong></td><td>Label-based search</td><td>Full-text search</td></tr><tr><td><strong>Indexing Cost</strong></td><td>Low</td><td>High (CPU/memory intensive)</td></tr><tr><td><strong>Storage Cost</strong></td><td>Cheap (S3/GCS object storage)</td><td>Expensive (dedicated nodes needed)</td></tr><tr><td><strong>Performance</strong></td><td>Efficient for massive log storage</td><td>Fast for query</td></tr><tr><td><strong>Scalability</strong></td><td>Easy to scale with simple configuration</td><td>Cluster scaling is more complex</td></tr><tr><td><strong>Ops Overhead</strong></td><td>Low (no need to manage cluster)</td><td>High (cluster management required)</td></tr><tr><td><strong>Use Case</strong></td><td>Simple log storage and retrieval</td><td>Complex analysis and search</td></tr></tbody></table><p><img loading=lazy src=/posts/es-to-loki/image.png></p><h2 id=pre-migration-checklist>Pre-Migration Checklist<a hidden class=anchor aria-hidden=true href=#pre-migration-checklist>#</a></h2><ul><li><input checked disabled type=checkbox> No need to expose dashboards to external stakeholders?</li><li><input checked disabled type=checkbox> Do you only need basic log viewing during incidents?</li></ul><h2 id=notes-when-integrating-loki>Notes When Integrating Loki<a hidden class=anchor aria-hidden=true href=#notes-when-integrating-loki>#</a></h2><blockquote><p>When <strong>labels are too diverse</strong> or contain <strong>too many unique values</strong>, Loki&rsquo;s <strong>indexing becomes inefficient</strong>.</p><ul><li>Example: assigning fields like <code>user_id</code> or <code>timestamp</code> as labels can cause a rapid index size increase.</li></ul><p><strong>Consequences</strong>:</p><ul><li><strong>Slow query performance</strong></li><li><strong>High memory usage</strong></li><li><strong>Increased storage cost</strong></li></ul></blockquote><h3 id=use-fixed-low-cardinality-labels>Use Fixed, Low-Cardinality Labels<a hidden class=anchor aria-hidden=true href=#use-fixed-low-cardinality-labels>#</a></h3><p>To keep cardinality low:</p><ul><li>Use static or limited-range values as labels</li><li>Examples:<ul><li><strong>Good üòä</strong>: <code>region="us-east-1"</code>, <code>app="payment-service"</code></li><li><strong>Bad üò•</strong>: <code>user_id="12345"</code>, <code>request_id="abcd-efgh"</code></li></ul></li></ul><h3 id=only-use-labels-relevant-to-filtering>Only Use Labels Relevant to Filtering<a hidden class=anchor aria-hidden=true href=#only-use-labels-relevant-to-filtering>#</a></h3><p>Design labels based on how you plan to filter/search logs in dashboards:</p><ul><li>Use labels only for data that will be filtered or analyzed</li><li>Avoid labels used solely for debugging</li><li>Examples:<ul><li><strong>Good üòä</strong>: For tracking TPS/latency, design labels around logs that appear once per request ‚Üí e.g. <code>func="LogMiddleware.Log"</code></li><li><strong>Bad üò•</strong>: Using <code>latency</code> itself as a label</li></ul></li></ul><h3 id=separate-log-message-from-metadata>Separate Log Message from Metadata<a hidden class=anchor aria-hidden=true href=#separate-log-message-from-metadata>#</a></h3><p>Labels should serve as tags. Dynamic values should go inside the log message.</p><ul><li>Examples:<ul><li><strong>Good üòä</strong>: <code>label:func="RestrictionsService"</code>, <code>log: member_id="12341512321", message="restricted member"</code></li><li><strong>Bad üò•</strong>: <code>label:member_id="12341512321"</code>, <code>log: message="restricted member", func="RestrictionsService"</code></li></ul></li></ul><h3 id=limit-the-number-of-labels>Limit the Number of Labels<a hidden class=anchor aria-hidden=true href=#limit-the-number-of-labels>#</a></h3><p>Too many labels = high cardinality ‚Üí indexing inefficiency.</p><ul><li>Loki&rsquo;s official recommendation: <strong>keep labels under 20</strong>.</li></ul><h3 id=limit-unique-values-per-label>Limit Unique Values per Label<a hidden class=anchor aria-hidden=true href=#limit-unique-values-per-label>#</a></h3><p>Loki recommends fewer than <strong>1,000 unique values per label</strong>.</p><ul><li>Acceptable: <code>status="200"</code>, <code>status="500"</code></li><li>Avoid: <code>user_id="12345"</code>, <code>session_id="abcd-efgh"</code></li><li>Examples:<ul><li><strong>Good üòä</strong>: <code>env="production"</code>, <code>service="payments"</code>, <code>region="us-east-1"</code></li><li><strong>Bad üò•</strong>: <code>user_id="12345"</code>, <code>request_id="xyz-789"</code></li></ul></li></ul><h3 id=tune-chunk-size-and-retention>Tune Chunk Size and Retention<a hidden class=anchor aria-hidden=true href=#tune-chunk-size-and-retention>#</a></h3><p>Loki stores logs in chunks and flushes them to object storage periodically.</p><ul><li>Too small chunks ‚Üí low performance</li><li>Too large chunks ‚Üí slow search</li><li>Recommended:<ul><li><code>chunk_encoding: gzip</code></li><li><code>chunk_target_size: 1MB~2MB</code> (adjust as needed)</li></ul></li></ul><h2 id=building-the-dashboard>Building the Dashboard<a hidden class=anchor aria-hidden=true href=#building-the-dashboard>#</a></h2><h3 id=1-set-up-variables>1. Set Up Variables<a hidden class=anchor aria-hidden=true href=#1-set-up-variables>#</a></h3><p>While filtering with Variables adds complexity, it‚Äôs a gift to your future self.</p><p>Application logs are usually queried using <code>raw log</code>, so choose frequently used filter labels as variables.
Also add text box filters to refine the filtered results.</p><p><img loading=lazy src=/posts/es-to-loki/image-1.png></p><h3 id=2-build-raw-logs-panel>2. Build Raw Logs Panel<a hidden class=anchor aria-hidden=true href=#2-build-raw-logs-panel>#</a></h3><p>Start with a global log viewer using <code>Logs Visualization</code>.</p><p>Example:</p><pre tabindex=0><code class=language-logql data-lang=logql>{_type=&#34;loki&#34;} |= `$filter`
</code></pre><h3 id=3-filter-error-logs-by-log-level>3. Filter Error Logs by Log Level<a hidden class=anchor aria-hidden=true href=#3-filter-error-logs-by-log-level>#</a></h3><p>From <code>raw log</code>, duplicate and filter only <code>error</code> level logs.</p><blockquote><p>Some business logic might bypass error tagging‚Äîmake sure log levels are properly set.</p></blockquote><p>Example:</p><pre tabindex=0><code class=language-logql data-lang=logql>{level=&#34;error&#34;}
</code></pre><h3 id=4-track-tps-with-quantiles>4. Track TPS with Quantiles<a hidden class=anchor aria-hidden=true href=#4-track-tps-with-quantiles>#</a></h3><p>Precision = speed. Use <code>P50</code>, <code>P99</code> as standard metrics with <code>Gauge Visualization</code> using <code>quantile_over_time</code>.</p><blockquote><p>Note:</p><ul><li>Unlike Prometheus TSDB, Loki doesn&rsquo;t compute percentiles efficiently</li><li>High volume log ranges may degrade performance</li><li><code>quantile_over_time</code> is memory intensive and expensive at large time ranges</li></ul></blockquote><p>Example:</p><pre tabindex=0><code class=language-logql data-lang=logql>quantile_over_time(0.50, {func=&#34;LogMiddleware.Log&#34;} |= `$filter` | json | unwrap latency [$__range]) by (func)
</code></pre><h3 id=5-build-distributions-by-label>5. Build Distributions by Label<a hidden class=anchor aria-hidden=true href=#5-build-distributions-by-label>#</a></h3><p>Use <code>Piechart</code> to understand overall log distribution.</p><blockquote><p>Labels must be used, so apply this only to unique label values</p></blockquote><p>Example:</p><pre tabindex=0><code class=language-logql data-lang=logql>sum by(method) (count_over_time({func=&#34;LogMiddleware.Log&#34;} |= `$filter` [$__auto]))
</code></pre><h3 id=6-use-table-to-visualize-and-filter-distributions>6. Use Table to Visualize and Filter Distributions<a hidden class=anchor aria-hidden=true href=#6-use-table-to-visualize-and-filter-distributions>#</a></h3><p><code>Table</code> is great for at-a-glance inspection. You can make labels clickable for filtering.</p><p>Example:</p><pre tabindex=0><code class=language-logql data-lang=logql>sum by(method) (count_over_time({func=&#34;LogMiddleware.Log&#34;} |= `$filter` [$__auto]))
</code></pre><h3 id=final-dashboard>Final Dashboard<a hidden class=anchor aria-hidden=true href=#final-dashboard>#</a></h3><p><img loading=lazy src=/posts/es-to-loki/loki-grafana-dashboard.png></p><h3 id=references>References<a hidden class=anchor aria-hidden=true href=#references>#</a></h3><ul><li><a href=https://grafana.com/blog/2023/05/18/6-easy-ways-to-improve-your-log-dashboards-with-grafana-and-grafana-loki/>6 easy ways to improve your log dashboards with Grafana and Grafana Loki</a></li></ul></div><footer class=post-footer><ul class=post-tags><li><a href=https://dingyu.dev/en/tags/loki/>Loki</a></li><li><a href=https://dingyu.dev/en/tags/grafana/>Grafana</a></li><li><a href=https://dingyu.dev/en/tags/lgtm/>Lgtm</a></li><li><a href=https://dingyu.dev/en/tags/monitoring/>Monitoring</a></li></ul><nav class=paginav><a class=prev href=https://dingyu.dev/en/posts/go-convention/><span class=title>¬´ Prev</span><br><span>[Go] Go Convention</span>
</a><a class=next href=https://dingyu.dev/en/posts/flink-dynamic-job/><span class=title>Next ¬ª</span><br><span>[EDA] Flink Dynamic Job Case Study</span></a></nav></footer><div id=giscus_thread><script src=https://giscus.app/client.js data-repo=dings-things/blog data-repo-id=R_kgDON9IuAw data-category=Announcements data-category-id=DIC_kwDON9IuA84CnTai data-mapping=og:title data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=bottom data-theme=preferred_color_scheme data-lang=en data-loading=lazy crossorigin=anonymous async></script></div></article></main><footer class=footer><span>&copy; 2025 <a href=https://dingyu.dev/en/>Ding's Coding Forge</a></span> ¬∑
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>
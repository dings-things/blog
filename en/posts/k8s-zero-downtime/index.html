<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>[Infra] Zero-Downtime Kubernetes Deployment Guide | Ding's Coding Forge</title>
<meta name=keywords content="k8s,zero-downtime"><meta name=description content="During our migration from IDC to EKS, we encountered numerous challenges—including security configurations, network settings, databases, and ultimately, application deployments. After each deployment, we frequently faced 502 and 504 errors without a clear solution. Since minimizing downtime was critical, I’ll share how we overcame these 502 and 504 issues."><meta name=author content="dingyu"><link rel=canonical href=https://dingyu.dev/en/posts/k8s-zero-downtime/><meta name=google-site-verification content="8XY1hI6NVxQIrN7bQbnX-9TG9HHFw5HOQmlb6vcsFdQ"><meta name=yandex-verification content="XYZabc"><meta name=msvalidate.01 content="XYZabc"><link crossorigin=anonymous href=/assets/css/stylesheet.678f9035c217c5346e0b3de5bdc9ebac02c53b0502219858f8653d8d181c97b3.css integrity="sha256-Z4+QNcIXxTRuCz3lvcnrrALFOwUCIZhY+GU9jRgcl7M=" rel="preload stylesheet" as=style><link rel=icon href=https://dingyu.dev/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://dingyu.dev/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://dingyu.dev/favicon-32x32.png><link rel=apple-touch-icon href=https://dingyu.dev/apple-touch-icon.png><link rel=mask-icon href=https://dingyu.dev/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=ko href=https://dingyu.dev/posts/k8s-zero-downtime/><link rel=alternate hreflang=en href=https://dingyu.dev/en/posts/k8s-zero-downtime/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=G-XH8830R9KK"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-XH8830R9KK")}</script><meta property="og:url" content="https://dingyu.dev/en/posts/k8s-zero-downtime/"><meta property="og:site_name" content="Ding's Coding Forge"><meta property="og:title" content="[Infra] Zero-Downtime Kubernetes Deployment Guide"><meta property="og:description" content="During our migration from IDC to EKS, we encountered numerous challenges—including security configurations, network settings, databases, and ultimately, application deployments. After each deployment, we frequently faced 502 and 504 errors without a clear solution. Since minimizing downtime was critical, I’ll share how we overcame these 502 and 504 issues."><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-08-16T00:00:00+00:00"><meta property="article:modified_time" content="2024-08-16T00:00:00+00:00"><meta property="article:tag" content="K8s"><meta property="article:tag" content="Zero-Downtime"><meta property="og:image" content="https://dingyu.dev/en/posts/k8s-zero-downtime/img/kubernetes.png"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://dingyu.dev/en/posts/k8s-zero-downtime/img/kubernetes.png"><meta name=twitter:title content="[Infra] Zero-Downtime Kubernetes Deployment Guide"><meta name=twitter:description content="During our migration from IDC to EKS, we encountered numerous challenges—including security configurations, network settings, databases, and ultimately, application deployments. After each deployment, we frequently faced 502 and 504 errors without a clear solution. Since minimizing downtime was critical, I’ll share how we overcame these 502 and 504 issues."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://dingyu.dev/en/posts/"},{"@type":"ListItem","position":2,"name":"[Infra] Zero-Downtime Kubernetes Deployment Guide","item":"https://dingyu.dev/en/posts/k8s-zero-downtime/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"[Infra] Zero-Downtime Kubernetes Deployment Guide","name":"[Infra] Zero-Downtime Kubernetes Deployment Guide","description":"During our migration from IDC to EKS, we encountered numerous challenges—including security configurations, network settings, databases, and ultimately, application deployments. After each deployment, we frequently faced 502 and 504 errors without a clear solution. Since minimizing downtime was critical, I’ll share how we overcame these 502 and 504 issues.","keywords":["k8s","zero-downtime"],"articleBody":"Background After deploying on Kubernetes (k8s), intermittent 502 / 504 errors were observed during load testing. Pods were terminated before completing existing requests, causing 504 Gateway Timeout errors. New Pods were launched while old Pods were terminated, causing 502 Bad Gateway errors. Although rolling updates were happening, it was confirmed that without proper Readiness Probe settings, downtime could occur.\nSetup Install Load Testing Tools bombardier: A simple and easy-to-use Go CLI load testing tool. vegeta: A flexible load tester that allows scripting and provides detailed status code responses. Installation steps are omitted here.\nReadiness Probe A mechanism used to determine whether a Pod is ready to handle traffic.\nEven after a container starts, it might not be ready to handle external traffic until certain initialization tasks are completed.\nTraffic Routing Control:\nKubernetes does not route traffic to a Pod until its Readiness Probe succeeds. Ensures Pods handle requests only after they’re fully initialized. Pod Status Management:\nUntil the probe passes, Kubernetes removes the Pod from the service endpoint. Without a Readiness Probe, 502 errors can occur.\nIf a container receives traffic immediately after startup — before the server is fully initialized — it may respond with a 502 Bad Gateway.\nChanges to deployment.yml ... readinessProbe: httpGet: port: 8080 path: /alive scheme: HTTP initialDelaySeconds: 30 periodSeconds: 30 ... Create a /alive endpoint and configure the probe to accept traffic only after receiving HTTP 200.\nTest bombardier -c 200 -d 3m -l https://{endpoint} Results:\n5XX errors still occur. lifecycle \u0026 preStop What is lifecycle? Kubernetes lifecycle hooks allow execution of commands during certain container states (similar to AOP):\npostStart: Executed immediately after a container starts. preStop: Executed just before container termination. preStop Hook\nUsed to safely detach Pods from services before termination. Helps complete cleanup tasks like closing connections or saving files. Allows graceful shutdown by adding a delay. Even with Readiness Probe configured, without lifecycle settings, intermittent 502 errors could still happen.\nPod termination (SIGTERM) and service deregistration are asynchronous. Pod might still receive traffic but can’t serve requests properly. Thus, setting up:\nService Detach → Handle remaining requests → Terminate Pod Achieves a true graceful shutdown.\nChanges to deployment.yml ... lifecycle: preStop: exec: command: - /bin/sh - -c - sleep 40 # Wait for 40s after detaching from service ... Flow:\nKubernetes sends SIGTERM to Pod. preStop hook (sleep 40) is executed. terminationGracePeriodSeconds countdown starts. Pod terminates after hook and grace period. Test bombardier -c 200 -d 3m -l https://{endpoint} Results:\nReduced but not eliminated 5XX errors. terminationGracePeriodSeconds Pod Shutdown Scenario:\nKubernetes sends SIGTERM. Application can finalize connections and clean up. Grace Period:\nDefined by terminationGracePeriodSeconds. Kubernetes waits for clean termination. Default is 30 seconds. SIGKILL:\nIf the Pod is still alive after the grace period, Kubernetes forcefully kills it. Problem:\npreStop sleep is 40 seconds. Default grace period is 30 seconds. Kubernetes sends SIGKILL before graceful shutdown completes. Changes to deployment.yml ... terminationGracePeriodSeconds: 50 ... Important: Check ALB timeout settings if you’re using AWS Ingress!\nIf terminationGracePeriodSeconds exceeds ALB timeout, 504 Gateway Timeout errors may occur.\nRecommended:\nlifecycle.preStop (40s) \u003c terminationGracePeriodSeconds (50s) \u003c ALB Timeout (60s) Test bombardier -c 200 -d 3m -l https://{endpoint} Results:\nNo 5XX errors observed! References Kakao Tech Blog - Zero Downtime Deployment on Kubernetes Kubernetes Official Docs - Pod Lifecycle ","wordCount":"546","inLanguage":"en","image":"https://dingyu.dev/en/posts/k8s-zero-downtime/img/kubernetes.png","datePublished":"2024-08-16T00:00:00Z","dateModified":"2024-08-16T00:00:00Z","author":{"@type":"Person","name":"dingyu"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://dingyu.dev/en/posts/k8s-zero-downtime/"},"publisher":{"@type":"Organization","name":"Ding's Coding Forge","logo":{"@type":"ImageObject","url":"https://dingyu.dev/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://dingyu.dev/en/ accesskey=h title="Ding's Coding Forge (Alt + H)"><img src=https://dingyu.dev/apple-touch-icon.png alt aria-label=logo height=35>Ding's Coding Forge</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
</button><span class=nav-separator>|</span><div class=lang-select-dropdown><button class=lang-select-dropdown-trigger aria-label=Translations type=button><svg xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 512 512" width="24" height="18"><path d="M478.33 433.6l-90-218a22 22 0 00-40.67.0l-90 218a22 22 0 1040.67 16.79L316.66 406h102.67l18.33 44.39A22 22 0 00458 464a22 22 0 0020.32-30.4zM334.83 362 368 281.65 401.17 362z" fill="currentcolor"/><path d="M267.84 342.92a22 22 0 00-4.89-30.7c-.2-.15-15-11.13-36.49-34.73 39.65-53.68 62.11-114.75 71.27-143.49H330a22 22 0 000-44H214V70a22 22 0 00-44 0v20H54a22 22 0 000 44h197.25c-9.52 26.95-27.05 69.5-53.79 108.36-31.41-41.68-43.08-68.65-43.17-68.87a22 22 0 00-40.58 17c.58 1.38 14.55 34.23 52.86 83.93.92 1.19 1.83 2.35 2.74 3.51-39.24 44.35-77.74 71.86-93.85 80.74a22 22 0 1021.07 38.63c2.16-1.18 48.6-26.89 101.63-85.59 22.52 24.08 38 35.44 38.93 36.1a22 22 0 0030.75-4.9z" fill="currentcolor"/></svg></button><div class=lang-select-dropdown-content><a lang=ko href=https://dingyu.dev/ title=한국어 aria-label=한국어>한국어</a></div></div></div></div><ul id=menu><li><a href=https://dingyu.dev/en/about/ title=About><span>About</span></a></li><li><a href=https://dingyu.dev/en/categories/ title=Categories><span>Categories</span></a></li><li><a href=https://dingyu.dev/en/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://dingyu.dev/en/archives/ title=Archives><span>Archives</span></a></li><li><a href=https://dingyu.dev/en/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://dingyu.dev/en/>Home</a>&nbsp;»&nbsp;<a href=https://dingyu.dev/en/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">[Infra] Zero-Downtime Kubernetes Deployment Guide</h1><div class=post-description>During our migration from IDC to EKS, we encountered numerous challenges—including security configurations, network settings, databases, and ultimately, application deployments. After each deployment, we frequently faced 502 and 504 errors without a clear solution. Since minimizing downtime was critical, I’ll share how we overcame these 502 and 504 issues.</div><div class=post-meta><span title='2024-08-16 00:00:00 +0000 UTC'>August 16, 2024</span>&nbsp;·&nbsp;3 min&nbsp;·&nbsp;546 words&nbsp;·&nbsp;dingyu&nbsp;|&nbsp;Translations:<ul class=i18n_list><li><a href=https://dingyu.dev/posts/k8s-zero-downtime/>Ko</a></li></ul>&nbsp;|&nbsp;<a href=https://github.com/dings-things/blog/tree/main/content/posts/k8s-zero-downtime/index.en.md rel="noopener noreferrer" target=_blank>Suggest Changes</a></div></header><figure class=entry-cover><img loading=eager src=https://dingyu.dev/img/kubernetes.png alt></figure><aside id=toc-container class="toc-container wide"><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#background aria-label=Background>Background</a></li><li><a href=#setup aria-label=Setup>Setup</a><ul><li><a href=#install-load-testing-tools aria-label="Install Load Testing Tools">Install Load Testing Tools</a></li><li><a href=#readiness-probe aria-label="Readiness Probe">Readiness Probe</a><ul><li><a href=#changes-to-deploymentyml aria-label="Changes to deployment.yml">Changes to <code>deployment.yml</code></a></li><li><a href=#test aria-label=Test>Test</a></li></ul></li><li><a href=#lifecycle--prestop aria-label="lifecycle & preStop">lifecycle & preStop</a><ul><li><a href=#changes-to-deploymentyml-1 aria-label="Changes to deployment.yml">Changes to <code>deployment.yml</code></a></li><li><a href=#test-1 aria-label=Test>Test</a></li></ul></li><li><a href=#terminationgraceperiodseconds aria-label=terminationGracePeriodSeconds>terminationGracePeriodSeconds</a><ul><li><a href=#changes-to-deploymentyml-2 aria-label="Changes to deployment.yml">Changes to <code>deployment.yml</code></a></li><li><a href=#test-2 aria-label=Test>Test</a></li><li><a href=#references aria-label=References>References</a></li></ul></li></ul></li></ul></div></details></div></aside><script>let activeElement,elements;window.addEventListener("DOMContentLoaded",function(){checkTocPosition(),elements=document.querySelectorAll("h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]"),activeElement=elements[0];const t=encodeURI(activeElement.getAttribute("id")).toLowerCase();document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active")},!1),window.addEventListener("resize",function(){checkTocPosition()},!1),window.addEventListener("scroll",()=>{activeElement=Array.from(elements).find(e=>{if(getOffsetTop(e)-window.pageYOffset>0&&getOffsetTop(e)-window.pageYOffset<window.innerHeight/2)return e})||activeElement,elements.forEach(e=>{const t=encodeURI(e.getAttribute("id")).toLowerCase();e===activeElement?document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active"):document.querySelector(`.inner ul li a[href="#${t}"]`).classList.remove("active")})},!1);const main=parseInt(getComputedStyle(document.body).getPropertyValue("--article-width"),10),toc=parseInt(getComputedStyle(document.body).getPropertyValue("--toc-width"),10),gap=parseInt(getComputedStyle(document.body).getPropertyValue("--gap"),10);function checkTocPosition(){const e=document.body.scrollWidth;e-main-toc*2-gap*4>0?document.getElementById("toc-container").classList.add("wide"):document.getElementById("toc-container").classList.remove("wide")}function getOffsetTop(e){if(!e.getClientRects().length)return 0;let t=e.getBoundingClientRect(),n=e.ownerDocument.defaultView;return t.top+n.pageYOffset}</script><div class=post-content><h1 id=background>Background<a hidden class=anchor aria-hidden=true href=#background>#</a></h1><ul><li>After deploying on Kubernetes (k8s), intermittent 502 / 504 errors were observed during load testing.</li><li>Pods were terminated before completing existing requests, causing <strong>504 Gateway Timeout</strong> errors.</li><li>New Pods were launched while old Pods were terminated, causing <strong>502 Bad Gateway</strong> errors.</li></ul><p>Although rolling updates were happening, it was confirmed that <strong>without proper Readiness Probe settings, downtime could occur</strong>.</p><hr><h1 id=setup>Setup<a hidden class=anchor aria-hidden=true href=#setup>#</a></h1><h2 id=install-load-testing-tools>Install Load Testing Tools<a hidden class=anchor aria-hidden=true href=#install-load-testing-tools>#</a></h2><ul><li><a href=https://github.com/codesenberg/bombardier>bombardier</a>: A simple and easy-to-use Go CLI load testing tool.</li><li><a href=https://github.com/tsenart/vegeta>vegeta</a>: A flexible load tester that allows scripting and provides detailed status code responses.</li></ul><p>Installation steps are omitted here.</p><hr><h2 id=readiness-probe>Readiness Probe<a hidden class=anchor aria-hidden=true href=#readiness-probe>#</a></h2><blockquote><p>A mechanism used to determine whether a Pod is ready to handle traffic.</p><p>Even after a container starts, it might not be ready to handle external traffic until certain initialization tasks are completed.</p></blockquote><ol><li><p>Traffic Routing Control:</p><ul><li>Kubernetes does not route traffic to a Pod until its Readiness Probe succeeds.</li><li>Ensures Pods handle requests only after they&rsquo;re fully initialized.</li></ul></li><li><p>Pod Status Management:</p><ul><li>Until the probe passes, Kubernetes removes the Pod from the service endpoint.</li></ul></li></ol><p><strong>Without a Readiness Probe, 502 errors can occur.</strong></p><p>If a container receives traffic immediately after startup — before the server is fully initialized — it may respond with a <strong>502 Bad Gateway</strong>.</p><p><img loading=lazy src=/posts/k8s-zero-downtime/1.png></p><h3 id=changes-to-deploymentyml>Changes to <code>deployment.yml</code><a hidden class=anchor aria-hidden=true href=#changes-to-deploymentyml>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nn>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>readinessProbe</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>httpGet</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>8080</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/alive</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>scheme</span><span class=p>:</span><span class=w> </span><span class=l>HTTP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>initialDelaySeconds</span><span class=p>:</span><span class=w> </span><span class=m>30</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>periodSeconds</span><span class=p>:</span><span class=w> </span><span class=m>30</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>...</span><span class=w>
</span></span></span></code></pre></div><p>Create a <code>/alive</code> endpoint and configure the probe to accept traffic only after receiving HTTP 200.</p><h3 id=test>Test<a hidden class=anchor aria-hidden=true href=#test>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>bombardier -c <span class=m>200</span> -d 3m -l https://<span class=o>{</span>endpoint<span class=o>}</span>
</span></span></code></pre></div><p>Results:</p><ul><li>5XX errors still occur.</li></ul><hr><h2 id=lifecycle--prestop>lifecycle & preStop<a hidden class=anchor aria-hidden=true href=#lifecycle--prestop>#</a></h2><blockquote><p><strong>What is lifecycle?</strong>
Kubernetes lifecycle hooks allow execution of commands during certain container states (similar to AOP):</p><ul><li><strong>postStart</strong>: Executed immediately after a container starts.</li><li><strong>preStop</strong>: Executed just before container termination.</li></ul></blockquote><p><strong>preStop Hook</strong></p><ul><li>Used to safely detach Pods from services before termination.</li><li>Helps complete cleanup tasks like closing connections or saving files.</li><li>Allows graceful shutdown by adding a delay.</li></ul><p>Even with Readiness Probe configured, without lifecycle settings, intermittent 502 errors could still happen.</p><ul><li>Pod termination (SIGTERM) and service deregistration are asynchronous.</li><li>Pod might still receive traffic but can&rsquo;t serve requests properly.</li></ul><p>Thus, setting up:</p><ul><li><strong>Service Detach</strong> → <strong>Handle remaining requests</strong> → <strong>Terminate Pod</strong></li></ul><p>Achieves a true graceful shutdown.</p><p><img loading=lazy src=/posts/k8s-zero-downtime/2.png></p><h3 id=changes-to-deploymentyml-1>Changes to <code>deployment.yml</code><a hidden class=anchor aria-hidden=true href=#changes-to-deploymentyml-1>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nn>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>lifecycle</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>preStop</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>exec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>command</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=l>/bin/sh</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- -<span class=l>c</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=l>sleep 40 </span><span class=w> </span><span class=c># Wait for 40s after detaching from service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>...</span><span class=w>
</span></span></span></code></pre></div><p><strong>Flow:</strong></p><ol><li>Kubernetes sends SIGTERM to Pod.</li><li><code>preStop</code> hook (<code>sleep 40</code>) is executed.</li><li><code>terminationGracePeriodSeconds</code> countdown starts.</li><li>Pod terminates after hook and grace period.</li></ol><h3 id=test-1>Test<a hidden class=anchor aria-hidden=true href=#test-1>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>bombardier -c <span class=m>200</span> -d 3m -l https://<span class=o>{</span>endpoint<span class=o>}</span>
</span></span></code></pre></div><p>Results:</p><ul><li>Reduced but not eliminated 5XX errors.</li></ul><hr><h2 id=terminationgraceperiodseconds>terminationGracePeriodSeconds<a hidden class=anchor aria-hidden=true href=#terminationgraceperiodseconds>#</a></h2><blockquote><p><strong>Pod Shutdown Scenario:</strong></p><ul><li>Kubernetes sends SIGTERM.</li><li>Application can finalize connections and clean up.</li></ul><p><strong>Grace Period:</strong></p><ul><li>Defined by <code>terminationGracePeriodSeconds</code>.</li><li>Kubernetes waits for clean termination.</li><li>Default is 30 seconds.</li></ul><p><strong>SIGKILL:</strong></p><ul><li>If the Pod is still alive after the grace period, Kubernetes forcefully kills it.</li></ul></blockquote><p><strong>Problem:</strong></p><ul><li><code>preStop</code> sleep is 40 seconds.</li><li>Default grace period is 30 seconds.</li><li>Kubernetes sends SIGKILL before graceful shutdown completes.</li></ul><p><img loading=lazy src=/posts/k8s-zero-downtime/3.png></p><h3 id=changes-to-deploymentyml-2>Changes to <code>deployment.yml</code><a hidden class=anchor aria-hidden=true href=#changes-to-deploymentyml-2>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nn>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>terminationGracePeriodSeconds</span><span class=p>:</span><span class=w> </span><span class=m>50</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>...</span><span class=w>
</span></span></span></code></pre></div><p><strong>Important:</strong> Check ALB timeout settings if you&rsquo;re using AWS Ingress!</p><p>If <code>terminationGracePeriodSeconds</code> exceeds ALB timeout, <strong>504 Gateway Timeout</strong> errors may occur.</p><p>Recommended:</p><ul><li><code>lifecycle.preStop</code> (40s) &lt; <code>terminationGracePeriodSeconds</code> (50s) &lt; ALB Timeout (60s)</li></ul><h3 id=test-2>Test<a hidden class=anchor aria-hidden=true href=#test-2>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>bombardier -c <span class=m>200</span> -d 3m -l https://<span class=o>{</span>endpoint<span class=o>}</span>
</span></span></code></pre></div><p>Results:</p><ul><li><strong>No 5XX errors</strong> observed!</li></ul><hr><h3 id=references>References<a hidden class=anchor aria-hidden=true href=#references>#</a></h3><ul><li><a href=https://tech.kakao.com/posts/360>Kakao Tech Blog - Zero Downtime Deployment on Kubernetes</a></li><li><a href=https://kubernetes.io/ko/docs/concepts/workloads/pods/pod-lifecycle/>Kubernetes Official Docs - Pod Lifecycle</a></li></ul></div><footer class=post-footer><ul class=post-tags><li><a href=https://dingyu.dev/en/tags/k8s/>K8s</a></li><li><a href=https://dingyu.dev/en/tags/zero-downtime/>Zero-Downtime</a></li></ul><nav class=paginav><a class=prev href=https://dingyu.dev/en/posts/sentry/><span class=title>« Prev</span><br><span>[Third-Party] Integrating Sentry in Go</span>
</a><a class=next href=https://dingyu.dev/en/posts/aws-well-architected/><span class=title>Next »</span><br><span>[Infra] AWS Well Architected</span></a></nav></footer><div id=giscus_thread><script src=https://giscus.app/client.js data-repo=dings-things/blog data-repo-id=R_kgDON9IuAw data-category=Announcements data-category-id=DIC_kwDON9IuA84CnTai data-mapping=og:title data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=bottom data-theme=preferred_color_scheme data-lang=en data-loading=lazy crossorigin=anonymous async></script></div></article></main><footer class=footer><span>&copy; 2025 <a href=https://dingyu.dev/en/>Ding's Coding Forge</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>
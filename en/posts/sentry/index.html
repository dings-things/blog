<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>[Third-Party] Integrating Sentry in Go | Ding's Coding Forge</title>
<meta name=keywords content="go,sentry"><meta name=description content="This post explores how to effectively integrate Sentry into Go projects to enhance error tracking, performance monitoring, and issue management. It covers the importance of structured logging, setting up Sentry alerts, and implementing error capturing using Go's pkg/errors for better stack trace visibility. Additionally, it introduces best practices such as singleton-based initialization, contextual error handling, and panic recovery middleware, ensuring stable and efficient service operations."><meta name=author content="dingyu"><link rel=canonical href=https://dingyu.dev/en/posts/sentry/><meta name=google-site-verification content="8XY1hI6NVxQIrN7bQbnX-9TG9HHFw5HOQmlb6vcsFdQ"><meta name=yandex-verification content="XYZabc"><meta name=msvalidate.01 content="XYZabc"><link crossorigin=anonymous href=/assets/css/stylesheet.ba0de23ad40e17ca82720b577f8ae6ec11a26fb07407316cff70888e344ad129.css integrity="sha256-ug3iOtQOF8qCcgtXf4rm7BGib7B0BzFs/3CIjjRK0Sk=" rel="preload stylesheet" as=style><link rel=icon href=https://dingyu.dev/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://dingyu.dev/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://dingyu.dev/favicon-32x32.png><link rel=apple-touch-icon href=https://dingyu.dev/apple-touch-icon.png><link rel=mask-icon href=https://dingyu.dev/%3Clink%20/%20abs%20url%3E><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=ko href=https://dingyu.dev/posts/sentry/><link rel=alternate hreflang=en href=https://dingyu.dev/en/posts/sentry/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=G-XH8830R9KK"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-XH8830R9KK")}</script><meta property="og:url" content="https://dingyu.dev/en/posts/sentry/"><meta property="og:site_name" content="Ding's Coding Forge"><meta property="og:title" content="[Third-Party] Integrating Sentry in Go"><meta property="og:description" content="This post explores how to effectively integrate Sentry into Go projects to enhance error tracking, performance monitoring, and issue management. It covers the importance of structured logging, setting up Sentry alerts, and implementing error capturing using Go's pkg/errors for better stack trace visibility. Additionally, it introduces best practices such as singleton-based initialization, contextual error handling, and panic recovery middleware, ensuring stable and efficient service operations."><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-09-11T00:00:00+00:00"><meta property="article:modified_time" content="2024-09-11T00:00:00+00:00"><meta property="article:tag" content="Go"><meta property="article:tag" content="Sentry"><meta property="og:image" content="https://dingyu.dev/en/posts/sentry/img/sentry.png"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://dingyu.dev/en/posts/sentry/img/sentry.png"><meta name=twitter:title content="[Third-Party] Integrating Sentry in Go"><meta name=twitter:description content="This post explores how to effectively integrate Sentry into Go projects to enhance error tracking, performance monitoring, and issue management. It covers the importance of structured logging, setting up Sentry alerts, and implementing error capturing using Go's pkg/errors for better stack trace visibility. Additionally, it introduces best practices such as singleton-based initialization, contextual error handling, and panic recovery middleware, ensuring stable and efficient service operations."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://dingyu.dev/en/posts/"},{"@type":"ListItem","position":2,"name":"[Third-Party] Integrating Sentry in Go","item":"https://dingyu.dev/en/posts/sentry/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"[Third-Party] Integrating Sentry in Go","name":"[Third-Party] Integrating Sentry in Go","description":"This post explores how to effectively integrate Sentry into Go projects to enhance error tracking, performance monitoring, and issue management. It covers the importance of structured logging, setting up Sentry alerts, and implementing error capturing using Go's pkg/errors for better stack trace visibility. Additionally, it introduces best practices such as singleton-based initialization, contextual error handling, and panic recovery middleware, ensuring stable and efficient service operations.","keywords":["go","sentry"],"articleBody":"Why Sentry? Traditional log monitoring has limitations such as: Elasticsearch field mapping errors causing dropped log events Need to request system logs from SEs to retrieve stack traces Sentry provides a centralized, visual, and automated error tracking and performance monitoring solution.\nWhat Sentry Provides Exception Capture: Automatically detects and logs application errors with stack trace and context. Transaction Monitoring: Tracks API/web request performance metrics. Tracing: Visualizes end-to-end latency across services and components. Alerting: Integrates with tools like Slack, email to notify devs of issues. Release Tracking: Monitors how errors correlate to new application releases. Alert Rule Examples Issues: Trigger alerts based on type of exception or service. Number of Errors: Trigger when a particular error exceeds a threshold. Users Experiencing Errors: Notify when errors affect multiple users, e.g. 100 users hitting login errors. Client Configuration DSN: Unique key per project for event ingestion. [Settings → Projects → Client Keys] Environment: Differentiate between production, staging, etc. Release: Tag errors by release version. SampleRate / TracesSampleRate: Control event sampling to optimize cost and performance. BeforeSend: Hook to redact sensitive data or conditionally send events. AttachStacktrace: Attach stack traces even for non-errors. ServerName: Identify source server. Transport: Custom HTTP config for timeouts and retries. Init Best Practice err := sentry.Init(sentry.ClientOptions{ Dsn: config.Sentry.DSN, SampleRate: config.Sentry.SampleRate, EnableTracing: config.Sentry.EnableTrace, Debug: config.Sentry.Debug, TracesSampleRate: config.Sentry.TracesSampleRate, Environment: config.Sentry.Environment, AttachStacktrace: true, Transport: \u0026sentry.HTTPSyncTransport{ Timeout: config.Sentry.Timeout }, }) Error Capturing Capture with Context hub := sentry.GetHubFromContext(ctx) if hub == nil { hub = sentry.CurrentHub().Clone() ctx = sentry.SetHubOnContext(ctx, hub) } hub.CaptureException(err) Standard vs. pkg/errors errors.New: no stack trace pkg/errors.Wrap: includes full stack trace Contextual Scopes hub := sentry.GetHubFromContext(r.Context()) if hub == nil { hub = sentry.CurrentHub().Clone() r = r.WithContext(sentry.SetHubOnContext(r.Context(), hub)) } hub.Scope().SetRequest(r) Singleton Initialization type SentryInitializer struct { conf *Config enabled bool mutex sync.RWMutex } func (si *SentryInitializer) Init() error { si.mutex.Lock() defer si.mutex.Unlock() err := sentry.Init(...) si.enabled = true return err } Capturing via Interface type ErrorCapturer interface { CaptureError(ctx context.Context, err error) } func (ec *sentryErrorCapturer) CaptureError(ctx context.Context, err error) { if err == nil { return } if !ec.Enabled() { ec.Init() } hub := sentry.GetHubFromContext(ctx) if hub == nil { hub = sentry.CurrentHub().Clone() ctx = sentry.SetHubOnContext(ctx, hub) } hub.CaptureException(err) } Panic Recovery Middleware func (rm *RecoverMiddleware) Register(h http.Handler) http.Handler { return http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) { hub := sentry.GetHubFromContext(r.Context()) if hub == nil { hub = sentry.CurrentHub().Clone() r = r.WithContext(sentry.SetHubOnContext(r.Context(), hub)) } hub.Scope().SetRequest(r) defer func() { if err := recover(); err != nil { hub.RecoverWithContext(r.Context(), err) // log stack trace, respond 500 } }() h.ServeHTTP(w, r) }) } Summary Sentry simplifies APM and error tracking for Go applications:\nAutomatic stack trace Release correlation Slack/email alerts Low overhead It’s a powerful ally for ensuring observability and reliability in production.\n","wordCount":"449","inLanguage":"en","image":"https://dingyu.dev/en/posts/sentry/img/sentry.png","datePublished":"2024-09-11T00:00:00Z","dateModified":"2024-09-11T00:00:00Z","author":{"@type":"Person","name":"dingyu"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://dingyu.dev/en/posts/sentry/"},"publisher":{"@type":"Organization","name":"Ding's Coding Forge","logo":{"@type":"ImageObject","url":"https://dingyu.dev/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://dingyu.dev/en/ accesskey=h title="Ding's Coding Forge (Alt + H)"><img src=https://dingyu.dev/apple-touch-icon.png alt aria-label=logo height=35>Ding's Coding Forge</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button><ul class=lang-switch><li>|</li><li><a href=https://dingyu.dev/ title=한국어 aria-label=한국어>Ko</a></li></ul></div></div><ul id=menu><li><a href=https://dingyu.dev/en/about/ title=About><span>About</span></a></li><li><a href=https://dingyu.dev/en/categories/ title=Categories><span>Categories</span></a></li><li><a href=https://dingyu.dev/en/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://dingyu.dev/en/archives/ title=Archives><span>Archives</span></a></li><li><a href=https://dingyu.dev/en/search/ title=🔍><span>🔍</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://dingyu.dev/en/>Home</a>&nbsp;»&nbsp;<a href=https://dingyu.dev/en/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">[Third-Party] Integrating Sentry in Go</h1><div class=post-description>This post explores how to effectively integrate Sentry into Go projects to enhance error tracking, performance monitoring, and issue management. It covers the importance of structured logging, setting up Sentry alerts, and implementing error capturing using Go's pkg/errors for better stack trace visibility. Additionally, it introduces best practices such as singleton-based initialization, contextual error handling, and panic recovery middleware, ensuring stable and efficient service operations.</div><div class=post-meta><span title='2024-09-11 00:00:00 +0000 UTC'>September 11, 2024</span>&nbsp;·&nbsp;3 min&nbsp;·&nbsp;449 words&nbsp;·&nbsp;dingyu&nbsp;|&nbsp;Translations:<ul class=i18n_list><li><a href=https://dingyu.dev/posts/sentry/>Ko</a></li></ul>&nbsp;|&nbsp;<a href=https://github.com/dings-things/blog/tree/main/content/posts/sentry/index.en.md rel="noopener noreferrer" target=_blank>Suggest Changes</a></div></header><figure class=entry-cover><img loading=eager src=https://dingyu.dev/img/sentry.png alt></figure><aside id=toc-container class="toc-container wide"><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#why-sentry aria-label="Why Sentry?">Why Sentry?</a></li><li><a href=#what-sentry-provides aria-label="What Sentry Provides">What Sentry Provides</a><ul><li><a href=#alert-rule-examples aria-label="Alert Rule Examples">Alert Rule Examples</a></li></ul></li><li><a href=#client-configuration aria-label="Client Configuration">Client Configuration</a><ul><li><a href=#init-best-practice aria-label="Init Best Practice">Init Best Practice</a></li></ul></li><li><a href=#error-capturing aria-label="Error Capturing">Error Capturing</a><ul><li><a href=#capture-with-context aria-label="Capture with Context">Capture with Context</a></li><li><a href=#standard-vs-pkgerrors aria-label="Standard vs. pkg/errors">Standard vs. pkg/errors</a></li></ul></li><li><a href=#contextual-scopes aria-label="Contextual Scopes">Contextual Scopes</a></li><li><a href=#singleton-initialization aria-label="Singleton Initialization">Singleton Initialization</a></li><li><a href=#capturing-via-interface aria-label="Capturing via Interface">Capturing via Interface</a></li><li><a href=#panic-recovery-middleware aria-label="Panic Recovery Middleware">Panic Recovery Middleware</a></li><li><a href=#summary aria-label=Summary>Summary</a></li></ul></div></details></div></aside><script>let activeElement,elements;window.addEventListener("DOMContentLoaded",function(){checkTocPosition(),elements=document.querySelectorAll("h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]"),activeElement=elements[0];const t=encodeURI(activeElement.getAttribute("id")).toLowerCase();document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active")},!1),window.addEventListener("resize",function(){checkTocPosition()},!1),window.addEventListener("scroll",()=>{activeElement=Array.from(elements).find(e=>{if(getOffsetTop(e)-window.pageYOffset>0&&getOffsetTop(e)-window.pageYOffset<window.innerHeight/2)return e})||activeElement,elements.forEach(e=>{const t=encodeURI(e.getAttribute("id")).toLowerCase();e===activeElement?document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active"):document.querySelector(`.inner ul li a[href="#${t}"]`).classList.remove("active")})},!1);const main=parseInt(getComputedStyle(document.body).getPropertyValue("--article-width"),10),toc=parseInt(getComputedStyle(document.body).getPropertyValue("--toc-width"),10),gap=parseInt(getComputedStyle(document.body).getPropertyValue("--gap"),10);function checkTocPosition(){const e=document.body.scrollWidth;e-main-toc*2-gap*4>0?document.getElementById("toc-container").classList.add("wide"):document.getElementById("toc-container").classList.remove("wide")}function getOffsetTop(e){if(!e.getClientRects().length)return 0;let t=e.getBoundingClientRect(),n=e.ownerDocument.defaultView;return t.top+n.pageYOffset}</script><div class=post-content><h2 id=why-sentry>Why Sentry?<a hidden class=anchor aria-hidden=true href=#why-sentry>#</a></h2><ul><li>Traditional log monitoring has limitations such as:<ul><li>Elasticsearch field mapping errors causing dropped log events</li><li>Need to request system logs from SEs to retrieve stack traces</li></ul></li></ul><p>Sentry provides a centralized, visual, and automated error tracking and performance monitoring solution.</p><h2 id=what-sentry-provides>What Sentry Provides<a hidden class=anchor aria-hidden=true href=#what-sentry-provides>#</a></h2><ol><li><strong>Exception Capture</strong>: Automatically detects and logs application errors with stack trace and context.</li><li><strong>Transaction Monitoring</strong>: Tracks API/web request performance metrics.</li><li><strong>Tracing</strong>: Visualizes end-to-end latency across services and components.</li><li><strong>Alerting</strong>: Integrates with tools like Slack, email to notify devs of issues.</li><li><strong>Release Tracking</strong>: Monitors how errors correlate to new application releases.</li></ol><p><img loading=lazy src=img/1.png></p><h3 id=alert-rule-examples>Alert Rule Examples<a hidden class=anchor aria-hidden=true href=#alert-rule-examples>#</a></h3><ul><li><strong>Issues</strong>: Trigger alerts based on type of exception or service.</li><li><strong>Number of Errors</strong>: Trigger when a particular error exceeds a threshold.</li><li><strong>Users Experiencing Errors</strong>: Notify when errors affect multiple users, e.g. 100 users hitting login errors.</li></ul><p><img loading=lazy src=img/2.png>
<img loading=lazy src=img/3.png>
<img loading=lazy src=img/4.png>
<img loading=lazy src=img/5.png></p><h2 id=client-configuration>Client Configuration<a hidden class=anchor aria-hidden=true href=#client-configuration>#</a></h2><ul><li><strong>DSN</strong>: Unique key per project for event ingestion.<ul><li>[Settings → Projects → Client Keys]</li><li><img loading=lazy src=img/6.png></li></ul></li><li><strong>Environment</strong>: Differentiate between <code>production</code>, <code>staging</code>, etc.</li><li><strong>Release</strong>: Tag errors by release version.</li><li><strong>SampleRate / TracesSampleRate</strong>: Control event sampling to optimize cost and performance.</li><li><strong>BeforeSend</strong>: Hook to redact sensitive data or conditionally send events.</li><li><strong>AttachStacktrace</strong>: Attach stack traces even for non-errors.</li><li><strong>ServerName</strong>: Identify source server.</li><li><strong>Transport</strong>: Custom HTTP config for timeouts and retries.</li></ul><h3 id=init-best-practice>Init Best Practice<a hidden class=anchor aria-hidden=true href=#init-best-practice>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>err</span> <span class=o>:=</span> <span class=nx>sentry</span><span class=p>.</span><span class=nf>Init</span><span class=p>(</span><span class=nx>sentry</span><span class=p>.</span><span class=nx>ClientOptions</span><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>Dsn</span><span class=p>:</span>              <span class=nx>config</span><span class=p>.</span><span class=nx>Sentry</span><span class=p>.</span><span class=nx>DSN</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>SampleRate</span><span class=p>:</span>       <span class=nx>config</span><span class=p>.</span><span class=nx>Sentry</span><span class=p>.</span><span class=nx>SampleRate</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>EnableTracing</span><span class=p>:</span>    <span class=nx>config</span><span class=p>.</span><span class=nx>Sentry</span><span class=p>.</span><span class=nx>EnableTrace</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>Debug</span><span class=p>:</span>            <span class=nx>config</span><span class=p>.</span><span class=nx>Sentry</span><span class=p>.</span><span class=nx>Debug</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>TracesSampleRate</span><span class=p>:</span> <span class=nx>config</span><span class=p>.</span><span class=nx>Sentry</span><span class=p>.</span><span class=nx>TracesSampleRate</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>Environment</span><span class=p>:</span>      <span class=nx>config</span><span class=p>.</span><span class=nx>Sentry</span><span class=p>.</span><span class=nx>Environment</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>AttachStacktrace</span><span class=p>:</span> <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>Transport</span><span class=p>:</span> <span class=o>&amp;</span><span class=nx>sentry</span><span class=p>.</span><span class=nx>HTTPSyncTransport</span><span class=p>{</span> <span class=nx>Timeout</span><span class=p>:</span> <span class=nx>config</span><span class=p>.</span><span class=nx>Sentry</span><span class=p>.</span><span class=nx>Timeout</span> <span class=p>},</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span></code></pre></div><h2 id=error-capturing>Error Capturing<a hidden class=anchor aria-hidden=true href=#error-capturing>#</a></h2><h3 id=capture-with-context>Capture with Context<a hidden class=anchor aria-hidden=true href=#capture-with-context>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>hub</span> <span class=o>:=</span> <span class=nx>sentry</span><span class=p>.</span><span class=nf>GetHubFromContext</span><span class=p>(</span><span class=nx>ctx</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=nx>hub</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>hub</span> <span class=p>=</span> <span class=nx>sentry</span><span class=p>.</span><span class=nf>CurrentHub</span><span class=p>().</span><span class=nf>Clone</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=nx>ctx</span> <span class=p>=</span> <span class=nx>sentry</span><span class=p>.</span><span class=nf>SetHubOnContext</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>hub</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nx>hub</span><span class=p>.</span><span class=nf>CaptureException</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span></code></pre></div><h3 id=standard-vs-pkgerrors>Standard vs. pkg/errors<a hidden class=anchor aria-hidden=true href=#standard-vs-pkgerrors>#</a></h3><ul><li><code>errors.New</code>: no stack trace</li><li><code>pkg/errors.Wrap</code>: includes full stack trace</li></ul><p><img loading=lazy src=img/7.png></p><h2 id=contextual-scopes>Contextual Scopes<a hidden class=anchor aria-hidden=true href=#contextual-scopes>#</a></h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>hub</span> <span class=o>:=</span> <span class=nx>sentry</span><span class=p>.</span><span class=nf>GetHubFromContext</span><span class=p>(</span><span class=nx>r</span><span class=p>.</span><span class=nf>Context</span><span class=p>())</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=nx>hub</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>hub</span> <span class=p>=</span> <span class=nx>sentry</span><span class=p>.</span><span class=nf>CurrentHub</span><span class=p>().</span><span class=nf>Clone</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=nx>r</span> <span class=p>=</span> <span class=nx>r</span><span class=p>.</span><span class=nf>WithContext</span><span class=p>(</span><span class=nx>sentry</span><span class=p>.</span><span class=nf>SetHubOnContext</span><span class=p>(</span><span class=nx>r</span><span class=p>.</span><span class=nf>Context</span><span class=p>(),</span> <span class=nx>hub</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nx>hub</span><span class=p>.</span><span class=nf>Scope</span><span class=p>().</span><span class=nf>SetRequest</span><span class=p>(</span><span class=nx>r</span><span class=p>)</span>
</span></span></code></pre></div><h2 id=singleton-initialization>Singleton Initialization<a hidden class=anchor aria-hidden=true href=#singleton-initialization>#</a></h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>SentryInitializer</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>conf</span> <span class=o>*</span><span class=nx>Config</span>
</span></span><span class=line><span class=cl>  <span class=nx>enabled</span> <span class=kt>bool</span>
</span></span><span class=line><span class=cl>  <span class=nx>mutex</span> <span class=nx>sync</span><span class=p>.</span><span class=nx>RWMutex</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>si</span> <span class=o>*</span><span class=nx>SentryInitializer</span><span class=p>)</span> <span class=nf>Init</span><span class=p>()</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>si</span><span class=p>.</span><span class=nx>mutex</span><span class=p>.</span><span class=nf>Lock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=k>defer</span> <span class=nx>si</span><span class=p>.</span><span class=nx>mutex</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=nx>err</span> <span class=o>:=</span> <span class=nx>sentry</span><span class=p>.</span><span class=nf>Init</span><span class=p>(</span><span class=o>...</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=nx>si</span><span class=p>.</span><span class=nx>enabled</span> <span class=p>=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h2 id=capturing-via-interface>Capturing via Interface<a hidden class=anchor aria-hidden=true href=#capturing-via-interface>#</a></h2><p><img loading=lazy src=img/8.png></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>ErrorCapturer</span> <span class=kd>interface</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nf>CaptureError</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>err</span> <span class=kt>error</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>ec</span> <span class=o>*</span><span class=nx>sentryErrorCapturer</span><span class=p>)</span> <span class=nf>CaptureError</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>err</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=nx>err</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span> <span class=k>return</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>!</span><span class=nx>ec</span><span class=p>.</span><span class=nf>Enabled</span><span class=p>()</span> <span class=p>{</span> <span class=nx>ec</span><span class=p>.</span><span class=nf>Init</span><span class=p>()</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=nx>hub</span> <span class=o>:=</span> <span class=nx>sentry</span><span class=p>.</span><span class=nf>GetHubFromContext</span><span class=p>(</span><span class=nx>ctx</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=nx>hub</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>hub</span> <span class=p>=</span> <span class=nx>sentry</span><span class=p>.</span><span class=nf>CurrentHub</span><span class=p>().</span><span class=nf>Clone</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=nx>ctx</span> <span class=p>=</span> <span class=nx>sentry</span><span class=p>.</span><span class=nf>SetHubOnContext</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>hub</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=nx>hub</span><span class=p>.</span><span class=nf>CaptureException</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h2 id=panic-recovery-middleware>Panic Recovery Middleware<a hidden class=anchor aria-hidden=true href=#panic-recovery-middleware>#</a></h2><p><img loading=lazy src=img/9.png></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>rm</span> <span class=o>*</span><span class=nx>RecoverMiddleware</span><span class=p>)</span> <span class=nf>Register</span><span class=p>(</span><span class=nx>h</span> <span class=nx>http</span><span class=p>.</span><span class=nx>Handler</span><span class=p>)</span> <span class=nx>http</span><span class=p>.</span><span class=nx>Handler</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nx>http</span><span class=p>.</span><span class=nf>HandlerFunc</span><span class=p>(</span><span class=kd>func</span><span class=p>(</span><span class=nx>w</span> <span class=nx>http</span><span class=p>.</span><span class=nx>ResponseWriter</span><span class=p>,</span> <span class=nx>r</span> <span class=o>*</span><span class=nx>http</span><span class=p>.</span><span class=nx>Request</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>hub</span> <span class=o>:=</span> <span class=nx>sentry</span><span class=p>.</span><span class=nf>GetHubFromContext</span><span class=p>(</span><span class=nx>r</span><span class=p>.</span><span class=nf>Context</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>hub</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>hub</span> <span class=p>=</span> <span class=nx>sentry</span><span class=p>.</span><span class=nf>CurrentHub</span><span class=p>().</span><span class=nf>Clone</span><span class=p>()</span>
</span></span><span class=line><span class=cl>      <span class=nx>r</span> <span class=p>=</span> <span class=nx>r</span><span class=p>.</span><span class=nf>WithContext</span><span class=p>(</span><span class=nx>sentry</span><span class=p>.</span><span class=nf>SetHubOnContext</span><span class=p>(</span><span class=nx>r</span><span class=p>.</span><span class=nf>Context</span><span class=p>(),</span> <span class=nx>hub</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nx>hub</span><span class=p>.</span><span class=nf>Scope</span><span class=p>().</span><span class=nf>SetRequest</span><span class=p>(</span><span class=nx>r</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>defer</span> <span class=kd>func</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nb>recover</span><span class=p>();</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>hub</span><span class=p>.</span><span class=nf>RecoverWithContext</span><span class=p>(</span><span class=nx>r</span><span class=p>.</span><span class=nf>Context</span><span class=p>(),</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=c1>// log stack trace, respond 500</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>h</span><span class=p>.</span><span class=nf>ServeHTTP</span><span class=p>(</span><span class=nx>w</span><span class=p>,</span> <span class=nx>r</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>})</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h2 id=summary>Summary<a hidden class=anchor aria-hidden=true href=#summary>#</a></h2><p>Sentry simplifies APM and error tracking for Go applications:</p><ul><li>Automatic stack trace</li><li>Release correlation</li><li>Slack/email alerts</li><li>Low overhead</li></ul><p>It’s a powerful ally for ensuring observability and reliability in production.</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://dingyu.dev/en/tags/go/>Go</a></li><li><a href=https://dingyu.dev/en/tags/sentry/>Sentry</a></li></ul><nav class=paginav><a class=prev href=https://dingyu.dev/en/posts/go-pprof-gc/><span class=title>« Prev</span><br><span>[Go] Tuning GC with pprof</span>
</a><a class=next href=https://dingyu.dev/en/posts/k8s-zero-downtime/><span class=title>Next »</span><br><span>[Infra] Zero-Downtime Kubernetes Deployment Guide</span></a></nav></footer><div id=giscus_thread><script src=https://giscus.app/client.js data-repo=dings-things/blog data-repo-id=R_kgDON9IuAw data-category=Announcements data-category-id=DIC_kwDON9IuA84CnTai data-mapping=og:title data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=bottom data-theme=preferred_color_scheme data-lang=ko data-loading=lazy crossorigin=anonymous async></script></div></article></main><footer class=footer><span>&copy; 2025 <a href=https://dingyu.dev/en/>Ding's Coding Forge</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>
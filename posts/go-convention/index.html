<!doctype html><html lang=ko dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>[Go] Go Convention | Ding's Coding Forge</title>
<meta name=keywords content="go,convention"><meta name=description content="There aren’t many Go developers in Korea, and major IT companies using Go are as rare as unicorns. At my company, we have accumulated our own know-how over the years while developing with Go. Here, I’d like to suggest some key conventions that I believe are useful for maintaining services in the long run."><meta name=author content="dingyu"><link rel=canonical href=https://dingyu.dev/posts/go-convention/><meta name=google-site-verification content="8XY1hI6NVxQIrN7bQbnX-9TG9HHFw5HOQmlb6vcsFdQ"><meta name=yandex-verification content="XYZabc"><meta name=msvalidate.01 content="XYZabc"><link crossorigin=anonymous href=/assets/css/stylesheet.ba0de23ad40e17ca82720b577f8ae6ec11a26fb07407316cff70888e344ad129.css integrity="sha256-ug3iOtQOF8qCcgtXf4rm7BGib7B0BzFs/3CIjjRK0Sk=" rel="preload stylesheet" as=style><link rel=icon href=https://dingyu.dev/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://dingyu.dev/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://dingyu.dev/favicon-32x32.png><link rel=apple-touch-icon href=https://dingyu.dev/apple-touch-icon.png><link rel=mask-icon href=https://dingyu.dev/%3Clink%20/%20abs%20url%3E><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=ko href=https://dingyu.dev/posts/go-convention/><link rel=alternate hreflang=en href=https://dingyu.dev/en/posts/go-convention/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=G-XH8830R9KK"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-XH8830R9KK")}</script><meta property="og:url" content="https://dingyu.dev/posts/go-convention/"><meta property="og:site_name" content="Ding's Coding Forge"><meta property="og:title" content="[Go] Go Convention"><meta property="og:description" content="There aren’t many Go developers in Korea, and major IT companies using Go are as rare as unicorns. At my company, we have accumulated our own know-how over the years while developing with Go. Here, I’d like to suggest some key conventions that I believe are useful for maintaining services in the long run."><meta property="og:locale" content="ko"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-01-12T00:00:00+00:00"><meta property="article:modified_time" content="2025-01-12T00:00:00+00:00"><meta property="article:tag" content="Go"><meta property="article:tag" content="Convention"><meta property="og:image" content="https://dingyu.dev/posts/go-convention/img/go-thumbnail.png"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://dingyu.dev/posts/go-convention/img/go-thumbnail.png"><meta name=twitter:title content="[Go] Go Convention"><meta name=twitter:description content="There aren’t many Go developers in Korea, and major IT companies using Go are as rare as unicorns. At my company, we have accumulated our own know-how over the years while developing with Go. Here, I’d like to suggest some key conventions that I believe are useful for maintaining services in the long run."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://dingyu.dev/posts/"},{"@type":"ListItem","position":2,"name":"[Go] Go Convention","item":"https://dingyu.dev/posts/go-convention/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"[Go] Go Convention","name":"[Go] Go Convention","description":"There aren’t many Go developers in Korea, and major IT companies using Go are as rare as unicorns. At my company, we have accumulated our own know-how over the years while developing with Go. Here, I’d like to suggest some key conventions that I believe are useful for maintaining services in the long run.","keywords":["go","convention"],"articleBody":"배경 서비스 별로 다른 프로젝트 구조 프로젝트 마다 코드 파악이 힘듦 e.g.\nSomeAPI ├── .vscode ├── api ├── build ├── config ├── data ├── db ├── externalservice ├── httpsrv ├── httptest ├── mocks ├── log ├── cli ├── repository ├── util ├── .gitignore ├── .gitlab-ci.yml ├── changelog ├── data.go ├── diag_debug.go ├── diag.go ├── go.mod ├── go.sum ├── main.go ├── Makefile ├── release.conf ├── README.md 공통 컨벤션이 없어 공통 모듈/CI를 사용하기 힘듦 모든 프로젝트에서 사용될 수 있도록 고려할 사항이 많아짐 → 개발 생산성 ↓ 온보딩 과정이 힘듦 신규 합류된 팀원이 Go언어에도 익숙치 않은 상태에서 너무 제각각인 스타일으로 인해 혼란이 옴 팀이 Go 언어 생태계로 전환을 완료했고, 이제는 노하우가 생겼다 생각함 장기적인 운영에서 컨벤션 사용으로 유지보수성 ↑ 신규 프로젝트에서 새로운 프로젝트 구조에 대한 고민을 하는 일, 기존 프로젝트에서 리팩토링의 방향성을 잡기 힘듦 개발 생산성 ↓ 프로젝트 구조 제안 적용이 Must인 부분은 * prefix를 가집니다 (그 외, Optional)\n엔터프라이즈 레벨의 프로젝트가 아닌 MSA를 기준으로 작성됩니다 추후 리팩토링을 하더라도 도메인 단위의 MSA로 물리적인 격리가 진행되기 때문…\n프로젝트 구조 샘플 도메인을 “매치 샘플링\"이라 하였을 때\n. ├── *docs // 프로젝트 별 문서들 │ ├── *swagger.yaml // API 스웨거 문서 │ ├── sequence.md // 비즈니스 시퀀스 다이어그램 │ └── architecture.md // 시스템 아키텍처 다이어그램 ├── *cmd │ └── *main.go // 프로젝트 진입점, DI 주입 ├── pkg // 비즈니스 로직에 종속적이지 않은 패키지 (외부에서 import 하여도 상관없는 모듈) │ ├── file_parser.go │ └── time_convertor.go └── *internal // 외부에 공개되면 안되는 비즈니스 로직 영역 (도메인 영역) ├── *handler │ ├── *v1 │ │ └── sampling_handler.go // 도메인 핸들러 v1 │ ├── v2 │ │ └── sampling_handler.go // 도메인 핸들러 v2 │ ├── server.go // handler가 많을 경우, handler를 등록할 server를 둡니다 │ ├── health_handler.go // v1, v2 공통 핸들러 │ ├── swagger_handler.go // 프로젝트 테스트 용 openapi 핸들러 (CORS 허용) │ └── auth_middleware.go // 미들웨어들 ├── data │ ├── mysqldb.go // DB client 커넥터 │ ├── redis.go // DB client 커넥터 │ ├── feature_event_producer.go // Kafka event producer - xxx_producer │ ├── match_repository.go // ORM 수행 repository (DB client 주입) - xxx_repository │ └── nass_api.go // 외부 API Data Layer - xxx_api ├── *service │ ├── kda_sampler.go // Data layer 혹은 다른 service를 주입 받아 구현 │ ├── match_sampling_usecase.go // service 가 많을 경우, 오케스트레이션 해주는 유즈케이스 구현 │ └── kda_sampler_test.go // 비즈니스 로직의 유닛테스트 ├── logger.go // 애플리케이션 전역에서 사용될 기능 ├── constants.go // 외부에서 참조 되어야 하는 상수 값 정의 └── *config.go // application 설정 파일 ├── *gitlab-ci.yml ├── *go.mod ├── *go.sum └── *README.md // 프로젝트에 대한 배경, 유즈케이스, 설치 방법 기술 구분 필수 여부 설명 예시 docs ✔ 프로젝트 아키텍처, 시퀀스 다이어그램, 스웨거 문서를 관리 - swagger.yaml- sequence.md cmd ✔ 프로젝트 진입점, 실행 가능한 파일 및 스크립트 관리 - main.go- start.sh pkg 애플리케이션에 종속적이지 않은 유틸리티 기능 관리 - time_convertor.go- file_parser.go internal ✔ 외부에 공개되면 안되는 비즈니스 로직(도메인) 영역애플리케이션 전역에서 사용될 기능 담당 - config.go- logger.go- constants.go internal/handler ✔ API라면 API Handler일 것이고 Consumer라면 Consumer Handler 담당- 버저닝은 *필수, HTTP/gRPC/MQ/Kafka 와의 통신을 담당- 미들웨어는 Optional- handler가 여러개일 경우, server 에서 handler를 등록할 수 있도록 합니다 - blacklist_handler.go- alive_handler.go- log_middleware.go- server.go internal/data 3 Tier Architecture 중, Data Layer 영역영속성을 가진 데이터 CRUD 담당(외부 API 또한 해당됨, Kafka 또한 stream에 저장하는 행위로 간주) - event_producer.go- blacklist_repository.go- member_api.go internal/service ✔ 비즈니스 로직을 수행하는 비즈니스 영역- 각각의 서비스는 단일 책임 원칙에 따라 하나의 책임만 수행- 서비스가 다수일 경우, 이를 오케스트레이션 해주는 xxx_usecase로 구현- 서비스 코드의 단위 테스트는 필수 (일부 의존성에 따른 테스트 불가 시 패스) - fraud_detect_usecase.go- fraud_retriever.go- rule_analyzer.go ./ (root) ✔ 프로젝트 실행 및 운영을 위한 파일 영역- 리드미는 필수로 작성 (유즈케이스와 설치 방법은 항상 기술) - gitlab-ci.yml- README.md 상수 컨벤션 기본적으로 카멜케이스와 파스칼케이스를 원칙으로 사용합니다\n→ 하나의 도메인 파일에서 도메인과 관련된 상수가 다른 패키지에 속해 있는 경우, 수정에도 어렵고 추적에도 귀찮음이 동반 됨을 느꼈습니다\n→ 하나의 책임을 지는 파일 내에서 private 상수로서 관리 된다면 유지보수에도 용이할 것이고 코드 파악에도 용이할 것이라 생각합니다\n복수 패키지에서 다수 의존될 여지가 있는 경우 (Pascal) internal layer의 constants.go 파일에 상수 값들을 정의 합니다\npackage internal const ( LanguageCodeKorean = \"ko\" LanguageCodeEnglish = \"en\" LanguageCodeChinese = \"zh_CN\" LanguageCodeJapanese = \"ja\" ) 하나의 패키지 내 혹은 하나의 파일에서 사용할 경우 (Camel) 동일 패키지 내에서는 private 변수에 참조할 수 있습니다\npackage handler const ( // resultSuccess : 성공 응답 resultSuccess = \"true\" // resultFailure : 실패 응답 resultFailure = \"false\" ) 불가피하게 다른 패키지로부터 참조되어야 하는 경우 상수는 private으로, struct의 Public 함수로 참조 될 수 있게 합니다\npackage handler const ( // samplerEndpoint : 매치 샘플링 엔드포인드 samplerEndpoint = \"/v1/:match_id\" ) // Endpoint : 핸들러의 엔드포인트를 반환 func (h *SamplerHandler) Endpoint() string { return samplerEndpoint } 데이터 모델 컨벤션 데이터 모델은 가급적 별도 파일이 아닌, 수행되는 파일에서 정의하여 사용합니다\n→ model을 별도로 지정해 둘 경우, 특정 도메인에 대한 수정이 있을 때 참조된 여러 파일을 수정해야 하는 불편함이 존재합니다\n→ 같은 계층 간의 데이터 이동에 대해서는 파라미터로 주고 받고 다른 레이어 간 통신은 *레이어 간 데이터 모델 컨벤션에 따라 데이터 모델을 주고 받습니다\n→ parameter가 두 개 이상일 경우, 데이터 모델로 만들어 관리합니다\n레이어 간 데이터 모델 컨벤션 handler → service\nrequest → serviceDTO\nfunc (h *Handler) CreateMatch(c *gin.Context) { var req matchRequest if err := c.ShouldBindJSON(\u0026req); err != nil { c.JSON(http.StatusBadRequest, gin.H{\"error\": err.Error()}) return } // Service 호출 err := h.service.Create(req.ToServiceDTO()) // so on } service → data\nserviceDTO → entity\nfunc (b *MatchCreater) Create(match MatchDTO) (int, error) { ... // repository 계층에 MatchEntity 삽입 요청 id, err := b.repository.Insert(match.ToEntity()) if err != nil { return 0, err } return id, nil } data → service\nentity → serviceDTO\nfunc (r *MatchRepository) Insert(entity MatchEntity) (int, error) { // 데이터 레이어에서 UserEntity 가져오기 result, err := s.db.Create(\u0026entity) ... return result.ID, nil } 데이터 모델에서의 조건 검사 모델을 주고 받는 경우, 가독성을 위해 조건 검사는 함수로 실시 합니다\n단위 테스트에 용이 하며, 한눈에 비즈니스 로직을 파악하기 쉬워 집니다\n[AS-IS]\nfunc (b *MatchCreater) Create(match MatchDTO) (int, error) { if strings.HasPrefix(match.Version, \"rc\") \u0026\u0026 match.detail == \"test\" { return } // 비즈니스 로직 } [TO-BE]\nfunc (b *MatchCreater) Create(match MatchDTO) (int, error) { if match.IsTest() { return } // 비즈니스 로직 } 테스트 컨벤션 비즈니스 로직의 테스트는 선택사항이 아닌 필수입니다. 이미 정의된 에러에 대한 테스트케이스는 최대한 상세하고 간결하게 작성합니다.\nDeterministic 비동기 단위 테스트 비동기로 처리하고 결과 값을 확인하지 않거나 time sleep 이후의 로깅을 멈추세요\nDI + Eventually를 통한 flaky test를 방지합니다\n로거 주입 // NewQueue 비즈니스 로직을 수행할 Queue 생성자 func NewQueue( config Config, httpClient *http.Client, logger *zerolog.Logger, ) (queue Queue, err error) { // queue는 Start()를 통해 thread executor가 실행될때에 생성됩니다. queue = Queue{ config: config, client: httpClient, logger: logger, quitChan: make(chan struct{}), } return } 응답 값 테스트 큐 로직 실패 테스트 t.Run(\"큐 처리 실패시, 실패 로깅 테스트\", func(t *testing.T) { // given var buffer bytes.Buffer ... 로거 의존성 주입 // when ... 비동기 작업 수행 event1, err := queue.Push([]byte(validJSON1)) assert.NoError(t, err) event2, err := queue.Push([]byte(validJSON2)) assert.NoError(t, err) // then assert.Eventually(t, func() bool { output := buffer.String() return strings.Contains(output, event1.TraceID().String()) \u0026\u0026 strings.Contains(output, event2.TraceID().String()) \u0026\u0026 strings.Contains(output, `\"success\":false`) }, 1*time.Second, 10*time.Millisecond) }) 큐 로직 성공 테스트 t.Run(\"큐 처리 성공시, 성공 로깅 테스트\", func(t *testing.T) { // given var buffer bytes.Buffer ... 로거 의존성 주입 // when ... 비동기 작업 수행 event1, err := queue.Push([]byte(validJSON1)) assert.NoError(t, err) event2, err := queue.Push([]byte(validJSON2)) assert.NoError(t, err) // then assert.Eventually(t, func() bool { output := buffer.String() return strings.Contains(output, event1.TraceID().String()) \u0026\u0026 strings.Contains(output, event2.TraceID().String()) \u0026\u0026 strings.Contains(output, `\"success\":true`) }, 1*time.Second, 10*time.Millisecond) }) ","wordCount":"1205","inLanguage":"ko","image":"https://dingyu.dev/posts/go-convention/img/go-thumbnail.png","datePublished":"2025-01-12T00:00:00Z","dateModified":"2025-01-12T00:00:00Z","author":{"@type":"Person","name":"dingyu"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://dingyu.dev/posts/go-convention/"},"publisher":{"@type":"Organization","name":"Ding's Coding Forge","logo":{"@type":"ImageObject","url":"https://dingyu.dev/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://dingyu.dev/ accesskey=h title="Ding's Coding Forge (Alt + H)"><img src=https://dingyu.dev/apple-touch-icon.png alt aria-label=logo height=35>Ding's Coding Forge</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button><ul class=lang-switch><li>|</li><li><a href=https://dingyu.dev/en/ title=English aria-label=English>En</a></li></ul></div></div><ul id=menu><li><a href=https://dingyu.dev/about/ title=About><span>About</span></a></li><li><a href=https://dingyu.dev/categories/ title=Categories><span>Categories</span></a></li><li><a href=https://dingyu.dev/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://dingyu.dev/archives/ title=Archives><span>Archives</span></a></li><li><a href=https://dingyu.dev/search/ title="🔍 (Alt + /)" accesskey=/><span>🔍</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://dingyu.dev/>홈</a>&nbsp;»&nbsp;<a href=https://dingyu.dev/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">[Go] Go Convention</h1><div class=post-description>There aren’t many Go developers in Korea, and major IT companies using Go are as rare as unicorns. At my company, we have accumulated our own know-how over the years while developing with Go. Here, I’d like to suggest some key conventions that I believe are useful for maintaining services in the long run.</div><div class=post-meta><span title='2025-01-12 00:00:00 +0000 UTC'>1월 12, 2025</span>&nbsp;·&nbsp;6 분&nbsp;·&nbsp;1205 단어&nbsp;·&nbsp;dingyu&nbsp;|&nbsp;번역:<ul class=i18n_list><li><a href=https://dingyu.dev/en/posts/go-convention/>En</a></li></ul>&nbsp;|&nbsp;<a href=https://github.com/dings-things/blog/tree/main/content/posts/go-convention/index.ko.md rel="noopener noreferrer" target=_blank>Suggest Changes</a></div></header><figure class=entry-cover><img loading=eager src=https://dingyu.dev/img/go-thumbnail.png alt></figure><aside id=toc-container class="toc-container wide"><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>목차</span></summary><div class=inner><ul><li><a href=#%eb%b0%b0%ea%b2%bd aria-label=배경>배경</a></li><li><a href=#%ed%94%84%eb%a1%9c%ec%a0%9d%ed%8a%b8-%ea%b5%ac%ec%a1%b0-%ec%a0%9c%ec%95%88 aria-label="프로젝트 구조 제안">프로젝트 구조 제안</a><ul><li><a href=#%ed%94%84%eb%a1%9c%ec%a0%9d%ed%8a%b8-%ea%b5%ac%ec%a1%b0-%ec%83%98%ed%94%8c aria-label="프로젝트 구조 샘플">프로젝트 구조 샘플</a></li><li><a href=#%ec%83%81%ec%88%98-%ec%bb%a8%eb%b2%a4%ec%85%98 aria-label="상수 컨벤션">상수 컨벤션</a><ul><li><a href=#%eb%b3%b5%ec%88%98-%ed%8c%a8%ed%82%a4%ec%a7%80%ec%97%90%ec%84%9c-%eb%8b%a4%ec%88%98-%ec%9d%98%ec%a1%b4%eb%90%a0-%ec%97%ac%ec%a7%80%ea%b0%80-%ec%9e%88%eb%8a%94-%ea%b2%bd%ec%9a%b0-pascal aria-label="복수 패키지에서 다수 의존될 여지가 있는 경우 (Pascal)">복수 패키지에서 다수 의존될 여지가 있는 경우 (Pascal)</a></li><li><a href=#%ed%95%98%eb%82%98%ec%9d%98-%ed%8c%a8%ed%82%a4%ec%a7%80-%eb%82%b4-%ed%98%b9%ec%9d%80-%ed%95%98%eb%82%98%ec%9d%98-%ed%8c%8c%ec%9d%bc%ec%97%90%ec%84%9c-%ec%82%ac%ec%9a%a9%ed%95%a0-%ea%b2%bd%ec%9a%b0-camel aria-label="하나의 패키지 내 혹은 하나의 파일에서 사용할 경우 (Camel)">하나의 패키지 내 혹은 하나의 파일에서 사용할 경우 (Camel)</a></li><li><a href=#%eb%b6%88%ea%b0%80%ed%94%bc%ed%95%98%ea%b2%8c-%eb%8b%a4%eb%a5%b8-%ed%8c%a8%ed%82%a4%ec%a7%80%eb%a1%9c%eb%b6%80%ed%84%b0-%ec%b0%b8%ec%a1%b0%eb%90%98%ec%96%b4%ec%95%bc-%ed%95%98%eb%8a%94-%ea%b2%bd%ec%9a%b0 aria-label="불가피하게 다른 패키지로부터 참조되어야 하는 경우">불가피하게 다른 패키지로부터 참조되어야 하는 경우</a></li></ul></li><li><a href=#%eb%8d%b0%ec%9d%b4%ed%84%b0-%eb%aa%a8%eb%8d%b8-%ec%bb%a8%eb%b2%a4%ec%85%98 aria-label="데이터 모델 컨벤션">데이터 모델 컨벤션</a><ul><li><a href=#%eb%a0%88%ec%9d%b4%ec%96%b4-%ea%b0%84-%eb%8d%b0%ec%9d%b4%ed%84%b0-%eb%aa%a8%eb%8d%b8-%ec%bb%a8%eb%b2%a4%ec%85%98 aria-label="레이어 간 데이터 모델 컨벤션">레이어 간 데이터 모델 컨벤션</a></li><li><a href=#%eb%8d%b0%ec%9d%b4%ed%84%b0-%eb%aa%a8%eb%8d%b8%ec%97%90%ec%84%9c%ec%9d%98-%ec%a1%b0%ea%b1%b4-%ea%b2%80%ec%82%ac aria-label="데이터 모델에서의 조건 검사">데이터 모델에서의 조건 검사</a></li></ul></li><li><a href=#%ed%85%8c%ec%8a%a4%ed%8a%b8-%ec%bb%a8%eb%b2%a4%ec%85%98 aria-label="테스트 컨벤션">테스트 컨벤션</a><ul><li><a href=#deterministic-%eb%b9%84%eb%8f%99%ea%b8%b0-%eb%8b%a8%ec%9c%84-%ed%85%8c%ec%8a%a4%ed%8a%b8 aria-label="Deterministic 비동기 단위 테스트">Deterministic 비동기 단위 테스트</a></li></ul></li></ul></li></ul></div></details></div></aside><script>let activeElement,elements;window.addEventListener("DOMContentLoaded",function(){checkTocPosition(),elements=document.querySelectorAll("h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]"),activeElement=elements[0];const t=encodeURI(activeElement.getAttribute("id")).toLowerCase();document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active")},!1),window.addEventListener("resize",function(){checkTocPosition()},!1),window.addEventListener("scroll",()=>{activeElement=Array.from(elements).find(e=>{if(getOffsetTop(e)-window.pageYOffset>0&&getOffsetTop(e)-window.pageYOffset<window.innerHeight/2)return e})||activeElement,elements.forEach(e=>{const t=encodeURI(e.getAttribute("id")).toLowerCase();e===activeElement?document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active"):document.querySelector(`.inner ul li a[href="#${t}"]`).classList.remove("active")})},!1);const main=parseInt(getComputedStyle(document.body).getPropertyValue("--article-width"),10),toc=parseInt(getComputedStyle(document.body).getPropertyValue("--toc-width"),10),gap=parseInt(getComputedStyle(document.body).getPropertyValue("--gap"),10);function checkTocPosition(){const e=document.body.scrollWidth;e-main-toc*2-gap*4>0?document.getElementById("toc-container").classList.add("wide"):document.getElementById("toc-container").classList.remove("wide")}function getOffsetTop(e){if(!e.getClientRects().length)return 0;let t=e.getBoundingClientRect(),n=e.ownerDocument.defaultView;return t.top+n.pageYOffset}</script><div class=post-content><h1 id=배경>배경<a hidden class=anchor aria-hidden=true href=#배경>#</a></h1><hr><ul><li>서비스 별로 다른 프로젝트 구조<ul><li>프로젝트 마다 코드 파악이 힘듦</li></ul></li></ul><p>e.g.</p><pre tabindex=0><code>SomeAPI
├── .vscode
├── api
├── build
├── config
├── data
├── db
├── externalservice
├── httpsrv
├── httptest
├── mocks
├── log
├── cli
├── repository
├── util
├── .gitignore
├── .gitlab-ci.yml
├── changelog
├── data.go
├── diag_debug.go
├── diag.go
├── go.mod
├── go.sum
├── main.go
├── Makefile
├── release.conf
├── README.md
</code></pre><ul><li>공통 컨벤션이 없어 공통 모듈/CI를 사용하기 힘듦<ul><li>모든 프로젝트에서 사용될 수 있도록 고려할 사항이 많아짐 → 개발 생산성 ↓</li></ul></li><li>온보딩 과정이 힘듦<ul><li>신규 합류된 팀원이 Go언어에도 익숙치 않은 상태에서 너무 제각각인 스타일으로 인해 혼란이 옴</li></ul></li><li>팀이 Go 언어 생태계로 전환을 완료했고, 이제는 노하우가 생겼다 생각함<ul><li>장기적인 운영에서 컨벤션 사용으로 유지보수성 ↑ </li></ul></li><li>신규 프로젝트에서 새로운 프로젝트 구조에 대한 고민을 하는 일, 기존 프로젝트에서 리팩토링의 방향성을 잡기 힘듦<ul><li>개발 생산성 ↓</li></ul></li></ul><h1 id=프로젝트-구조-제안>프로젝트 구조 제안<a hidden class=anchor aria-hidden=true href=#프로젝트-구조-제안>#</a></h1><hr><p>적용이 <strong>Must</strong>인 부분은 * prefix를 가집니다 (그 외, Optional)</p><blockquote><p>엔터프라이즈 레벨의 프로젝트가 아닌 MSA를 기준으로 작성됩니다
추후 리팩토링을 하더라도 도메인 단위의 MSA로 물리적인 격리가 진행되기 때문&mldr;</p></blockquote><h2 id=프로젝트-구조-샘플>프로젝트 구조 샘플<a hidden class=anchor aria-hidden=true href=#프로젝트-구조-샘플>#</a></h2><p>도메인을 &ldquo;매치 샘플링"이라 하였을 때</p><pre tabindex=0><code>.
├── *docs                         // 프로젝트 별 문서들
│   ├── *swagger.yaml             // API 스웨거 문서
│   ├── sequence.md               // 비즈니스 시퀀스 다이어그램
│   └── architecture.md           // 시스템 아키텍처 다이어그램
├── *cmd
│   └── *main.go                  // 프로젝트 진입점, DI 주입
├── pkg                           // 비즈니스 로직에 종속적이지 않은 패키지 (외부에서 import 하여도 상관없는 모듈)
│   ├── file_parser.go
│   └── time_convertor.go
└── *internal                     // 외부에 공개되면 안되는 비즈니스 로직 영역 (도메인 영역)
    ├── *handler
    │   ├── *v1
    │   │   └── sampling_handler.go         // 도메인 핸들러 v1
    │   ├── v2
    │   │   └── sampling_handler.go         // 도메인 핸들러 v2
    │   ├── server.go                       // handler가 많을 경우, handler를 등록할 server를 둡니다
    │   ├── health_handler.go               // v1, v2 공통 핸들러
    │   ├── swagger_handler.go              // 프로젝트 테스트 용 openapi 핸들러 (CORS 허용)
    │   └── auth_middleware.go              // 미들웨어들
    ├── data
    │   ├── mysqldb.go                      // DB client 커넥터
    │   ├── redis.go                        // DB client 커넥터
    │   ├── feature_event_producer.go       // Kafka event producer - xxx_producer
    │   ├── match_repository.go             // ORM 수행 repository (DB client 주입) - xxx_repository
    │   └── nass_api.go                     // 외부 API Data Layer - xxx_api
    ├── *service
    │   ├── kda_sampler.go                  // Data layer 혹은 다른 service를 주입 받아 구현
    │   ├── match_sampling_usecase.go       // service 가 많을 경우, 오케스트레이션 해주는 유즈케이스 구현
    │   └── kda_sampler_test.go             // 비즈니스 로직의 유닛테스트
    ├── logger.go                           // 애플리케이션 전역에서 사용될 기능
    ├── constants.go                        // 외부에서 참조 되어야 하는 상수 값 정의
    └── *config.go                          // application 설정 파일
├── *gitlab-ci.yml
├── *go.mod
├── *go.sum
└── *README.md                    // 프로젝트에 대한 배경, 유즈케이스, 설치 방법 기술
</code></pre><p><img loading=lazy src=/posts/go-convention/layered-architecture.png></p><table><thead><tr><th>구분</th><th>필수 여부</th><th>설명</th><th>예시</th></tr></thead><tbody><tr><td><strong>docs</strong></td><td>✔</td><td>프로젝트 아키텍처, 시퀀스 다이어그램, 스웨거 문서를 관리</td><td>- swagger.yaml- sequence.md</td></tr><tr><td><strong>cmd</strong></td><td>✔</td><td>프로젝트 진입점, 실행 가능한 파일 및 스크립트 관리</td><td>- main.go- start.sh</td></tr><tr><td><strong>pkg</strong></td><td></td><td>애플리케이션에 종속적이지 않은 유틸리티 기능 관리</td><td>- time_convertor.go- file_parser.go</td></tr><tr><td><strong>internal</strong></td><td>✔</td><td>외부에 공개되면 안되는 비즈니스 로직(도메인) 영역애플리케이션 전역에서 사용될 기능 담당</td><td>- config.go- logger.go- constants.go</td></tr><tr><td><strong>internal/</strong><strong>handler</strong></td><td>✔</td><td>API라면 API Handler일 것이고 Consumer라면 Consumer Handler 담당- 버저닝은 *필수, HTTP/gRPC/MQ/Kafka 와의 통신을 담당- 미들웨어는 Optional- handler가 여러개일 경우, server 에서 handler를 등록할 수 있도록 합니다</td><td>- blacklist_handler.go- alive_handler.go- log_middleware.go- server.go</td></tr><tr><td><strong>internal/</strong><strong>data</strong></td><td></td><td>3 Tier Architecture 중, Data Layer 영역영속성을 가진 데이터 CRUD 담당(외부 API 또한 해당됨, Kafka 또한 stream에 저장하는 행위로 간주)</td><td>- event_producer.go- blacklist_repository.go- member_api.go</td></tr><tr><td><strong>internal/</strong><strong>service</strong></td><td>✔</td><td>비즈니스 로직을 수행하는 비즈니스 영역- 각각의 서비스는 단일 책임 원칙에 따라 하나의 책임만 수행- 서비스가 다수일 경우, 이를 오케스트레이션 해주는 xxx_usecase로 구현- 서비스 코드의 단위 테스트는 필수 (일부 의존성에 따른 테스트 불가 시 패스)</td><td>- fraud_detect_usecase.go- fraud_retriever.go- rule_analyzer.go</td></tr><tr><td><strong>./ (root)</strong></td><td>✔</td><td>프로젝트 실행 및 운영을 위한 파일 영역- 리드미는 필수로 작성 (유즈케이스와 설치 방법은 항상 기술)</td><td>- gitlab-ci.yml- README.md</td></tr></tbody></table><h2 id=상수-컨벤션>상수 컨벤션<a hidden class=anchor aria-hidden=true href=#상수-컨벤션>#</a></h2><p>기본적으로 카멜케이스와 파스칼케이스를 원칙으로 사용합니다</p><p>→ 하나의 도메인 파일에서 도메인과 관련된 상수가 다른 패키지에 속해 있는 경우, 수정에도 어렵고 추적에도 귀찮음이 동반 됨을 느꼈습니다</p><p>→ 하나의 책임을 지는 파일 내에서 private 상수로서 관리 된다면 유지보수에도 용이할 것이고 코드 파악에도 용이할 것이라 생각합니다</p><h3 id=복수-패키지에서-다수-의존될-여지가-있는-경우-pascal>복수 패키지에서 다수 의존될 여지가 있는 경우 (Pascal)<a hidden class=anchor aria-hidden=true href=#복수-패키지에서-다수-의존될-여지가-있는-경우-pascal>#</a></h3><p>internal layer의 constants.go 파일에 상수 값들을 정의 합니다</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>internal</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>const</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=nx>LanguageCodeKorean</span>   <span class=p>=</span> <span class=s>&#34;ko&#34;</span>
</span></span><span class=line><span class=cl>	<span class=nx>LanguageCodeEnglish</span>  <span class=p>=</span> <span class=s>&#34;en&#34;</span>
</span></span><span class=line><span class=cl>	<span class=nx>LanguageCodeChinese</span>  <span class=p>=</span> <span class=s>&#34;zh_CN&#34;</span>
</span></span><span class=line><span class=cl>	<span class=nx>LanguageCodeJapanese</span> <span class=p>=</span> <span class=s>&#34;ja&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span></code></pre></div><h3 id=하나의-패키지-내-혹은-하나의-파일에서-사용할-경우-camel>하나의 패키지 내 혹은 하나의 파일에서 사용할 경우 (Camel)<a hidden class=anchor aria-hidden=true href=#하나의-패키지-내-혹은-하나의-파일에서-사용할-경우-camel>#</a></h3><p>동일 패키지 내에서는 private 변수에 참조할 수 있습니다</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>handler</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>const</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=c1>// resultSuccess : 성공 응답</span>
</span></span><span class=line><span class=cl>	<span class=nx>resultSuccess</span> <span class=p>=</span> <span class=s>&#34;true&#34;</span>
</span></span><span class=line><span class=cl>	<span class=c1>// resultFailure : 실패 응답</span>
</span></span><span class=line><span class=cl>	<span class=nx>resultFailure</span> <span class=p>=</span> <span class=s>&#34;false&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span></code></pre></div><h3 id=불가피하게-다른-패키지로부터-참조되어야-하는-경우>불가피하게 다른 패키지로부터 참조되어야 하는 경우<a hidden class=anchor aria-hidden=true href=#불가피하게-다른-패키지로부터-참조되어야-하는-경우>#</a></h3><p>상수는 private으로, struct의 Public 함수로 참조 될 수 있게 합니다</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>handler</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>const</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=c1>// samplerEndpoint : 매치 샘플링 엔드포인드</span>
</span></span><span class=line><span class=cl>	<span class=nx>samplerEndpoint</span> <span class=p>=</span> <span class=s>&#34;/v1/:match_id&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Endpoint : 핸들러의 엔드포인트를 반환</span>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>h</span> <span class=o>*</span><span class=nx>SamplerHandler</span><span class=p>)</span> <span class=nf>Endpoint</span><span class=p>()</span> <span class=kt>string</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>samplerEndpoint</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h2 id=데이터-모델-컨벤션>데이터 모델 컨벤션<a hidden class=anchor aria-hidden=true href=#데이터-모델-컨벤션>#</a></h2><p>데이터 모델은 가급적 별도 파일이 아닌, 수행되는 파일에서 정의하여 사용합니다</p><p>→ model을 별도로 지정해 둘 경우, 특정 도메인에 대한 수정이 있을 때 참조된 여러 파일을 수정해야 하는 불편함이 존재합니다</p><p>→ 같은 계층 간의 데이터 이동에 대해서는 파라미터로 주고 받고 다른 레이어 간 통신은 *레이어 간 데이터 모델 컨벤션에 따라 데이터 모델을 주고 받습니다</p><p>→ parameter가 두 개 이상일 경우, 데이터 모델로 만들어 관리합니다</p><h3 id=레이어-간-데이터-모델-컨벤션>레이어 간 데이터 모델 컨벤션<a hidden class=anchor aria-hidden=true href=#레이어-간-데이터-모델-컨벤션>#</a></h3><p><strong>handler → service</strong></p><p>request → serviceDTO</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>h</span> <span class=o>*</span><span class=nx>Handler</span><span class=p>)</span> <span class=nf>CreateMatch</span><span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>gin</span><span class=p>.</span><span class=nx>Context</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>var</span> <span class=nx>req</span> <span class=nx>matchRequest</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>c</span><span class=p>.</span><span class=nf>ShouldBindJSON</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>req</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>c</span><span class=p>.</span><span class=nf>JSON</span><span class=p>(</span><span class=nx>http</span><span class=p>.</span><span class=nx>StatusBadRequest</span><span class=p>,</span> <span class=nx>gin</span><span class=p>.</span><span class=nx>H</span><span class=p>{</span><span class=s>&#34;error&#34;</span><span class=p>:</span> <span class=nx>err</span><span class=p>.</span><span class=nf>Error</span><span class=p>()})</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Service 호출</span>
</span></span><span class=line><span class=cl>    <span class=nx>err</span> <span class=o>:=</span> <span class=nx>h</span><span class=p>.</span><span class=nx>service</span><span class=p>.</span><span class=nf>Create</span><span class=p>(</span><span class=nx>req</span><span class=p>.</span><span class=nf>ToServiceDTO</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=c1>// so on</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p><strong>service → data</strong></p><p>serviceDTO → entity</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>b</span> <span class=o>*</span><span class=nx>MatchCreater</span><span class=p>)</span> <span class=nf>Create</span><span class=p>(</span><span class=nx>match</span> <span class=nx>MatchDTO</span><span class=p>)</span> <span class=p>(</span><span class=kt>int</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=c1>// repository 계층에 MatchEntity 삽입 요청</span>
</span></span><span class=line><span class=cl>    <span class=nx>id</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>b</span><span class=p>.</span><span class=nx>repository</span><span class=p>.</span><span class=nf>Insert</span><span class=p>(</span><span class=nx>match</span><span class=p>.</span><span class=nf>ToEntity</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=mi>0</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>id</span><span class=p>,</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p><strong>data → service</strong></p><p>entity → serviceDTO</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>r</span> <span class=o>*</span><span class=nx>MatchRepository</span><span class=p>)</span> <span class=nf>Insert</span><span class=p>(</span><span class=nx>entity</span> <span class=nx>MatchEntity</span><span class=p>)</span> <span class=p>(</span><span class=kt>int</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 데이터 레이어에서 UserEntity 가져오기</span>
</span></span><span class=line><span class=cl>    <span class=nx>result</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>s</span><span class=p>.</span><span class=nx>db</span><span class=p>.</span><span class=nf>Create</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>entity</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>result</span><span class=p>.</span><span class=nx>ID</span><span class=p>,</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h3 id=데이터-모델에서의-조건-검사>데이터 모델에서의 조건 검사<a hidden class=anchor aria-hidden=true href=#데이터-모델에서의-조건-검사>#</a></h3><p>모델을 주고 받는 경우, 가독성을 위해 조건 검사는 함수로 실시 합니다</p><p>단위 테스트에 용이 하며, 한눈에 비즈니스 로직을 파악하기 쉬워 집니다</p><p>[AS-IS]</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>b</span> <span class=o>*</span><span class=nx>MatchCreater</span><span class=p>)</span> <span class=nf>Create</span><span class=p>(</span><span class=nx>match</span> <span class=nx>MatchDTO</span><span class=p>)</span> <span class=p>(</span><span class=kt>int</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>strings</span><span class=p>.</span><span class=nf>HasPrefix</span><span class=p>(</span><span class=nx>match</span><span class=p>.</span><span class=nx>Version</span><span class=p>,</span> <span class=s>&#34;rc&#34;</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=nx>match</span><span class=p>.</span><span class=nx>detail</span> <span class=o>==</span> <span class=s>&#34;test&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=c1>// 비즈니스 로직</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>[TO-BE]</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>b</span> <span class=o>*</span><span class=nx>MatchCreater</span><span class=p>)</span> <span class=nf>Create</span><span class=p>(</span><span class=nx>match</span> <span class=nx>MatchDTO</span><span class=p>)</span> <span class=p>(</span><span class=kt>int</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>match</span><span class=p>.</span><span class=nf>IsTest</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=c1>// 비즈니스 로직</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h2 id=테스트-컨벤션>테스트 컨벤션<a hidden class=anchor aria-hidden=true href=#테스트-컨벤션>#</a></h2><p>비즈니스 로직의 테스트는 선택사항이 아닌 필수입니다.
이미 정의된 에러에 대한 테스트케이스는 최대한 상세하고 간결하게 작성합니다.</p><h3 id=deterministic-비동기-단위-테스트>Deterministic 비동기 단위 테스트<a hidden class=anchor aria-hidden=true href=#deterministic-비동기-단위-테스트>#</a></h3><p>비동기로 처리하고 결과 값을 확인하지 않거나 <code>time sleep</code> 이후의 로깅을 멈추세요</p><p><code>DI + Eventually</code>를 통한 <strong>flaky test를 방지</strong>합니다</p><ol><li>로거 주입</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// NewQueue 비즈니스 로직을 수행할 Queue 생성자</span>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>NewQueue</span><span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=nx>config</span> <span class=nx>Config</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=nx>httpClient</span> <span class=o>*</span><span class=nx>http</span><span class=p>.</span><span class=nx>Client</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=nx>logger</span> <span class=o>*</span><span class=nx>zerolog</span><span class=p>.</span><span class=nx>Logger</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>)</span> <span class=p>(</span><span class=nx>queue</span> <span class=nx>Queue</span><span class=p>,</span> <span class=nx>err</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=c1>// queue는 Start()를 통해 thread executor가 실행될때에 생성됩니다.</span>
</span></span><span class=line><span class=cl>	<span class=nx>queue</span> <span class=p>=</span> <span class=nx>Queue</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>config</span><span class=p>:</span>   <span class=nx>config</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>client</span><span class=p>:</span>   <span class=nx>httpClient</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>logger</span><span class=p>:</span>   <span class=nx>logger</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>quitChan</span><span class=p>:</span> <span class=nb>make</span><span class=p>(</span><span class=kd>chan</span> <span class=kd>struct</span><span class=p>{}),</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><ol start=2><li>응답 값 테스트</li></ol><ul><li>큐 로직 실패 테스트</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>t</span><span class=p>.</span><span class=nf>Run</span><span class=p>(</span><span class=s>&#34;큐 처리 실패시, 실패 로깅 테스트&#34;</span><span class=p>,</span> <span class=kd>func</span><span class=p>(</span><span class=nx>t</span> <span class=o>*</span><span class=nx>testing</span><span class=p>.</span><span class=nx>T</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=c1>// given</span>
</span></span><span class=line><span class=cl>    <span class=kd>var</span> <span class=nx>buffer</span> <span class=nx>bytes</span><span class=p>.</span><span class=nx>Buffer</span>
</span></span><span class=line><span class=cl>	<span class=o>...</span> <span class=nx>로거</span> <span class=nx>의존성</span> <span class=nx>주입</span>   
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// when</span>
</span></span><span class=line><span class=cl>	<span class=o>...</span> <span class=nx>비동기</span> <span class=nx>작업</span> <span class=nx>수행</span>
</span></span><span class=line><span class=cl>    <span class=nx>event1</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>queue</span><span class=p>.</span><span class=nf>Push</span><span class=p>([]</span><span class=nb>byte</span><span class=p>(</span><span class=nx>validJSON1</span><span class=p>))</span>
</span></span><span class=line><span class=cl> 	<span class=nx>assert</span><span class=p>.</span><span class=nf>NoError</span><span class=p>(</span><span class=nx>t</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span> 
</span></span><span class=line><span class=cl>    <span class=nx>event2</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>queue</span><span class=p>.</span><span class=nf>Push</span><span class=p>([]</span><span class=nb>byte</span><span class=p>(</span><span class=nx>validJSON2</span><span class=p>))</span> 
</span></span><span class=line><span class=cl>  	<span class=nx>assert</span><span class=p>.</span><span class=nf>NoError</span><span class=p>(</span><span class=nx>t</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span> 
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// then</span>
</span></span><span class=line><span class=cl>	<span class=nx>assert</span><span class=p>.</span><span class=nf>Eventually</span><span class=p>(</span><span class=nx>t</span><span class=p>,</span> <span class=kd>func</span><span class=p>()</span> <span class=kt>bool</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>output</span> <span class=o>:=</span> <span class=nx>buffer</span><span class=p>.</span><span class=nf>String</span><span class=p>()</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>strings</span><span class=p>.</span><span class=nf>Contains</span><span class=p>(</span><span class=nx>output</span><span class=p>,</span> <span class=nx>event1</span><span class=p>.</span><span class=nf>TraceID</span><span class=p>().</span><span class=nf>String</span><span class=p>())</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>			<span class=nx>strings</span><span class=p>.</span><span class=nf>Contains</span><span class=p>(</span><span class=nx>output</span><span class=p>,</span> <span class=nx>event2</span><span class=p>.</span><span class=nf>TraceID</span><span class=p>().</span><span class=nf>String</span><span class=p>())</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>			<span class=nx>strings</span><span class=p>.</span><span class=nf>Contains</span><span class=p>(</span><span class=nx>output</span><span class=p>,</span> <span class=s>`&#34;success&#34;:false`</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>},</span> <span class=mi>1</span><span class=o>*</span><span class=nx>time</span><span class=p>.</span><span class=nx>Second</span><span class=p>,</span> <span class=mi>10</span><span class=o>*</span><span class=nx>time</span><span class=p>.</span><span class=nx>Millisecond</span><span class=p>)</span> 
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span></code></pre></div><ul><li>큐 로직 성공 테스트</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>t</span><span class=p>.</span><span class=nf>Run</span><span class=p>(</span><span class=s>&#34;큐 처리 성공시, 성공 로깅 테스트&#34;</span><span class=p>,</span> <span class=kd>func</span><span class=p>(</span><span class=nx>t</span> <span class=o>*</span><span class=nx>testing</span><span class=p>.</span><span class=nx>T</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=c1>// given</span>
</span></span><span class=line><span class=cl>    <span class=kd>var</span> <span class=nx>buffer</span> <span class=nx>bytes</span><span class=p>.</span><span class=nx>Buffer</span>
</span></span><span class=line><span class=cl>	<span class=o>...</span> <span class=nx>로거</span> <span class=nx>의존성</span> <span class=nx>주입</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// when</span>
</span></span><span class=line><span class=cl>	<span class=o>...</span> <span class=nx>비동기</span> <span class=nx>작업</span> <span class=nx>수행</span>
</span></span><span class=line><span class=cl>    <span class=nx>event1</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>queue</span><span class=p>.</span><span class=nf>Push</span><span class=p>([]</span><span class=nb>byte</span><span class=p>(</span><span class=nx>validJSON1</span><span class=p>))</span>
</span></span><span class=line><span class=cl> 	<span class=nx>assert</span><span class=p>.</span><span class=nf>NoError</span><span class=p>(</span><span class=nx>t</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span> 
</span></span><span class=line><span class=cl>    <span class=nx>event2</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>queue</span><span class=p>.</span><span class=nf>Push</span><span class=p>([]</span><span class=nb>byte</span><span class=p>(</span><span class=nx>validJSON2</span><span class=p>))</span> 
</span></span><span class=line><span class=cl>  	<span class=nx>assert</span><span class=p>.</span><span class=nf>NoError</span><span class=p>(</span><span class=nx>t</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span> 
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// then</span>
</span></span><span class=line><span class=cl>	<span class=nx>assert</span><span class=p>.</span><span class=nf>Eventually</span><span class=p>(</span><span class=nx>t</span><span class=p>,</span> <span class=kd>func</span><span class=p>()</span> <span class=kt>bool</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>output</span> <span class=o>:=</span> <span class=nx>buffer</span><span class=p>.</span><span class=nf>String</span><span class=p>()</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>strings</span><span class=p>.</span><span class=nf>Contains</span><span class=p>(</span><span class=nx>output</span><span class=p>,</span> <span class=nx>event1</span><span class=p>.</span><span class=nf>TraceID</span><span class=p>().</span><span class=nf>String</span><span class=p>())</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>			<span class=nx>strings</span><span class=p>.</span><span class=nf>Contains</span><span class=p>(</span><span class=nx>output</span><span class=p>,</span> <span class=nx>event2</span><span class=p>.</span><span class=nf>TraceID</span><span class=p>().</span><span class=nf>String</span><span class=p>())</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>			<span class=nx>strings</span><span class=p>.</span><span class=nf>Contains</span><span class=p>(</span><span class=nx>output</span><span class=p>,</span> <span class=s>`&#34;success&#34;:true`</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>},</span> <span class=mi>1</span><span class=o>*</span><span class=nx>time</span><span class=p>.</span><span class=nx>Second</span><span class=p>,</span> <span class=mi>10</span><span class=o>*</span><span class=nx>time</span><span class=p>.</span><span class=nx>Millisecond</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span></code></pre></div></div><footer class=post-footer><ul class=post-tags><li><a href=https://dingyu.dev/tags/go/>Go</a></li><li><a href=https://dingyu.dev/tags/convention/>Convention</a></li></ul><nav class=paginav><a class=prev href=https://dingyu.dev/posts/grpc/><span class=title>« 이전 페이지</span><br><span>[Protocol] RPC... 그리고 GRPC 톺아보기</span>
</a><a class=next href=https://dingyu.dev/posts/es-to-loki/><span class=title>다음 페이지 »</span><br><span>[LGTM] Elasticsearch to Loki 전환기</span></a></nav></footer><div id=giscus_thread><script src=https://giscus.app/client.js data-repo=dings-things/blog data-repo-id=R_kgDON9IuAw data-category=Announcements data-category-id=DIC_kwDON9IuA84CnTai data-mapping=og:title data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=bottom data-theme=preferred_color_scheme data-lang=ko data-loading=lazy crossorigin=anonymous async></script></div></article></main><footer class=footer><span>&copy; 2025 <a href=https://dingyu.dev/>Ding's Coding Forge</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="복사";function s(){t.innerHTML="복사 완료!",setTimeout(()=>{t.innerHTML="복사"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>
<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>[Infra] ì¿ ë²„ë„¤í‹±ìŠ¤ ë¬´ì¤‘ë‹¨ ë°°í¬ ì„¤ì •í•˜ê¸° | Ding's Coding Forge</title>
<meta name=keywords content="k8s,zero-downtime"><meta name=description content="During our migration from IDC to EKS, we encountered numerous challengesâ€”including security configurations, network settings, databases, and ultimately, application deployments. After each deployment, we frequently faced 502 and 504 errors without a clear solution. Since minimizing downtime was critical, Iâ€™ll share how we overcame these 502 and 504 issues."><meta name=author content="dingyu"><link rel=canonical href=https://dingyu.dev/posts/k8s-zero-downtime/><meta name=google-site-verification content="8XY1hI6NVxQIrN7bQbnX-9TG9HHFw5HOQmlb6vcsFdQ"><meta name=yandex-verification content="XYZabc"><meta name=msvalidate.01 content="XYZabc"><link crossorigin=anonymous href=/assets/css/stylesheet.e27650c63b614184e0a53cd99f9c1786874e85906dabc733988929727960aa8d.css integrity="sha256-4nZQxjthQYTgpTzZn5wXhodOhZBtq8czmIkpcnlgqo0=" rel="preload stylesheet" as=style><link rel=icon href=https://dingyu.dev/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://dingyu.dev/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://dingyu.dev/favicon-32x32.png><link rel=apple-touch-icon href=https://dingyu.dev/apple-touch-icon.png><link rel=mask-icon href=https://dingyu.dev/%3Clink%20/%20abs%20url%3E><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://dingyu.dev/posts/k8s-zero-downtime/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=G-XH8830R9KK"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-XH8830R9KK")}</script><meta property="og:url" content="https://dingyu.dev/posts/k8s-zero-downtime/"><meta property="og:site_name" content="Ding's Coding Forge"><meta property="og:title" content="[Infra] ì¿ ë²„ë„¤í‹±ìŠ¤ ë¬´ì¤‘ë‹¨ ë°°í¬ ì„¤ì •í•˜ê¸°"><meta property="og:description" content="During our migration from IDC to EKS, we encountered numerous challengesâ€”including security configurations, network settings, databases, and ultimately, application deployments. After each deployment, we frequently faced 502 and 504 errors without a clear solution. Since minimizing downtime was critical, Iâ€™ll share how we overcame these 502 and 504 issues."><meta property="og:locale" content="en-us"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-08-16T00:00:00+00:00"><meta property="article:modified_time" content="2024-08-16T00:00:00+00:00"><meta property="article:tag" content="K8s"><meta property="article:tag" content="Zero-Downtime"><meta property="og:image" content="https://dingyu.dev/posts/k8s-zero-downtime/img/kubernetes.png"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://dingyu.dev/posts/k8s-zero-downtime/img/kubernetes.png"><meta name=twitter:title content="[Infra] ì¿ ë²„ë„¤í‹±ìŠ¤ ë¬´ì¤‘ë‹¨ ë°°í¬ ì„¤ì •í•˜ê¸°"><meta name=twitter:description content="During our migration from IDC to EKS, we encountered numerous challengesâ€”including security configurations, network settings, databases, and ultimately, application deployments. After each deployment, we frequently faced 502 and 504 errors without a clear solution. Since minimizing downtime was critical, Iâ€™ll share how we overcame these 502 and 504 issues."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://dingyu.dev/posts/"},{"@type":"ListItem","position":2,"name":"[Infra] ì¿ ë²„ë„¤í‹±ìŠ¤ ë¬´ì¤‘ë‹¨ ë°°í¬ ì„¤ì •í•˜ê¸°","item":"https://dingyu.dev/posts/k8s-zero-downtime/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"[Infra] ì¿ ë²„ë„¤í‹±ìŠ¤ ë¬´ì¤‘ë‹¨ ë°°í¬ ì„¤ì •í•˜ê¸°","name":"[Infra] ì¿ ë²„ë„¤í‹±ìŠ¤ ë¬´ì¤‘ë‹¨ ë°°í¬ ì„¤ì •í•˜ê¸°","description":"During our migration from IDC to EKS, we encountered numerous challengesâ€”including security configurations, network settings, databases, and ultimately, application deployments. After each deployment, we frequently faced 502 and 504 errors without a clear solution. Since minimizing downtime was critical, Iâ€™ll share how we overcame these 502 and 504 issues.","keywords":["k8s","zero-downtime"],"articleBody":"ë°°ê²½ k8s í™˜ê²½ Deploy í›„, ë¶€í•˜í…ŒìŠ¤íŠ¸ ê³¼ì •ì—ì„œ ê°„í—ì ìœ¼ë¡œ 502 / 504 ì—ëŸ¬ ë°œìƒ í™•ì¸ Podë“¤ì´ êµì²´ ë˜ë©´ì„œ ê¸°ì¡´ ìš”ì²­ì— ëŒ€í•œ ì‘ë‹µì„ ë°˜í™˜í•˜ì§€ ëª»í•œ ì±„ ì¢…ë£Œ ë¨ â†’ 504 Gateway Timeout ì‹ ê·œ Podì´ ì˜¬ë¼ê°€ê³  ëŒ€ì²´ë˜ëŠ” Podì´ Terminate ë¨ â†’ 502 Bad Gateway ë¡¤ë§ì—…ë°ì´íŠ¸ê°€ ì§„í–‰ë˜ì§€ë§Œ Readiness Probe ì„¤ì • ì—†ì´ëŠ” ìˆœë‹¨ì´ ë°œìƒí•  ì—¬ì§€ê°€ ìˆìŒì„ í™•ì¸\nì„¤ì • ë¶€í•˜í…ŒìŠ¤íŠ¸ íˆ´ ì„¤ì¹˜ bombardier : ì‰½ê³  ê°„í¸í•œ go cli ë¶€í•˜í…ŒìŠ¤íŠ¸ íˆ´ vegeta : ìŠ¤í¬ë¦½íŠ¸ ì‘ì„±ìœ¼ë¡œ ë³´ë‹¤ ìœ ì—°í•œ ìš”ì²­ ê°€ëŠ¥, status code ë¥¼ ìƒì„¸íˆ ì‘ë‹µí•˜ëŠ” íˆ´\nê° íˆ´ì˜ ìì„¸í•œ ì„¤ì¹˜ ê³¼ì •ì€ ìƒëµ í•©ë‹ˆë‹¤.\nReadniess Probe Podì´ ì„œë¹„ìŠ¤ íŠ¸ë˜í”½ì„ ì²˜ë¦¬í•  ì¤€ë¹„ê°€ ë˜ì—ˆëŠ”ì§€ë¥¼ íŒë‹¨í•˜ëŠ” ë° ì‚¬ìš©ë˜ëŠ” ë©”ì»¤ë‹ˆì¦˜\níŠ¹ì • ì»¨í…Œì´ë„ˆê°€ ì‹œì‘ëœ í›„ì—ë„ ì¼ë¶€ ì‘ì—…ì´ ì™„ë£Œë  ë•Œê¹Œì§€ ì™¸ë¶€ íŠ¸ë˜í”½ì„ ì²˜ë¦¬í•  ì¤€ë¹„ê°€ ë˜ì§€ ì•Šì•˜ì„ ìˆ˜ ìˆê¸° ë•Œë¬¸ì— ì´ë¥¼ í™•ì¸í•˜ëŠ” ì—­í• ì„ í•¨\níŠ¸ë˜í”½ ë¼ìš°íŒ… ì œì–´: Readiness Probeê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë  ë•Œê¹Œì§€ KubernetesëŠ” í•´ë‹¹ Podìœ¼ë¡œ íŠ¸ë˜í”½ì„ ë¼ìš°íŒ…í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ì´ëŠ” Podì´ ì¤€ë¹„ë˜ì§€ ì•Šì€ ìƒíƒœì—ì„œ ìš”ì²­ì„ ì²˜ë¦¬í•˜ì§€ ì•Šë„ë¡ ë³´ì¥í•©ë‹ˆë‹¤. ì¤€ë¹„ê°€ ì™„ë£Œëœ í›„ì—ë§Œ íŠ¸ë˜í”½ì´ Podìœ¼ë¡œ ë¼ìš°íŒ…ë˜ê¸° ë•Œë¬¸ì—, Podì´ ì˜¬ë°”ë¥´ê²Œ ì„¤ì •ë˜ê³  í•„ìš”í•œ ë¦¬ì†ŒìŠ¤ë¥¼ í™•ë³´í•œ ìƒíƒœì—ì„œë§Œ ìš”ì²­ì„ ì²˜ë¦¬í•˜ê²Œ ë©ë‹ˆë‹¤. Podì˜ ìƒíƒœ í™•ì¸: Readiness ProbeëŠ” íŠ¹ì • ì¡°ê±´ì´ ì¶©ì¡±ë  ë•Œê¹Œì§€ Kubernetesì— Podì´ íŠ¸ë˜í”½ì„ ë°›ì„ ì¤€ë¹„ê°€ ë˜ì§€ ì•Šì•˜ë‹¤ê³  ì•Œë¦¬ë©°, ì¤€ë¹„ê°€ ì™„ë£Œëœ í›„ì—ëŠ” íŠ¸ë˜í”½ì„ ë°›ì„ ì¤€ë¹„ê°€ ë˜ì—ˆìŒì„ ì•Œë¦½ë‹ˆë‹¤. Podì´ ì¤€ë¹„ë˜ì§€ ì•Šì€ ê²½ìš°, KubernetesëŠ” Podì„ ì„œë¹„ìŠ¤ì˜ ì—”ë“œí¬ì¸íŠ¸ì—ì„œ ì œê±°í•©ë‹ˆë‹¤. 502ê°€ ë°œìƒí•˜ëŠ” ì›ì¸ ì¤‘ í•˜ë‚˜ì´ë‹¤\nReadiness Probeë¥¼ ì§€ì •í•˜ì§€ ì•Šì€ ê²½ìš°, ì»¨í…Œì´ë„ˆê°€ ì˜¬ë¼ê°€ëŠ” ì‹œì ì—ì„œ íŠ¸ë˜í”½ì´ ë“¤ì–´ì˜¤ê²Œ ëœë‹¤.\nì´ë•Œì—, Pod ë‚´ë¶€ì˜ ì„œë²„ ì´ˆê¸°í™”ê°€ ì™„ì „íˆ ë˜ì§€ ì•Šì€ ì‹œì ì—ì„œ ìš”ì²­ì´ ì˜¨ ê²½ìš° â†’ 502 Bad Gatewayë¥¼ ì‘ë‹µí•œë‹¤\ndeployment.yml ìˆ˜ì • ì‚¬í•­ ... readinessProbe: httpGet: port: 8080 path: /alive scheme: HTTP initialDelaySeconds: 30 periodSeconds: 30 ... Healthcheck ì‘ë‹µìš© Endpointë¥¼ ìƒì„±í•´ë‘ê³  ì‘ë‹µ ìƒíƒœì½”ë“œê°€ 200ìœ¼ë¡œ ëŒì•„ì˜¤ë©´ ìš”ì²­ì„ ë°›ëŠ” í˜•ì‹ìœ¼ë¡œ ì„¤ì •\ní…ŒìŠ¤íŠ¸ bombardier -c 200 -d 3m -l https://{endpoint} [================================================================================================================] 3m0s Done! Statistics Avg Stdev Max Reqs/sec 4205.76 1250.10 16927.12 Latency 47.81ms 10.16ms 2.07s Latency Distribution 50% 45.08ms 75% 49.77ms 90% 57.60ms 95% 64.29ms 99% 81.95ms HTTP codes: 1xx - 0, 2xx - 0, 3xx - 0, 4xx - 753060, 5xx - 12 others - 0 Throughput: 3.24MB/s ì—¬ì „íˆ 5XX ì—ëŸ¬ëŠ” ì¡´ì¬í•œë‹¤.\nlifecycle \u0026 preStop lifecycle ì„¤ì •ì´ë€? ì»¨í…Œì´ë„ˆì˜ ìƒëª…ì£¼ê¸° ë™ì•ˆ íŠ¹ì • ì‹œì ì— ì‹¤í–‰ë  ì‘ì—…ì„ ì •ì˜í•  ìˆ˜ ìˆëŠ” Kubernetesì˜ êµ¬ì„± ì˜µì…˜ (AOPì™€ ìœ ì‚¬â€¦í•˜ë‹¤ëŠ” ìƒê°)\npostStart: ì»¨í…Œì´ë„ˆê°€ ì‹œì‘ëœ ì§í›„ì— ì‹¤í–‰ë©ë‹ˆë‹¤. ì»¨í…Œì´ë„ˆê°€ ì‹œì‘ëœ í›„ ì¶”ê°€ì ì¸ ì´ˆê¸°í™” ì‘ì—…ì„ ìˆ˜í–‰í•˜ëŠ” ë° ì‚¬ìš© preStop: ì»¨í…Œì´ë„ˆê°€ ì¢…ë£Œë˜ê¸° ì§ì „ì— ì‹¤í–‰ë©ë‹ˆë‹¤. ì¢…ë£Œ ì „ì— í•„ìš”í•œ ì‘ì—…ì„ ìˆ˜í–‰í•˜ë„ë¡ ì„¤ì • ê°€ëŠ¥ preStop preStop í›…ì€ ì»¨í…Œì´ë„ˆê°€ ì¢…ë£Œë  ë•Œ ì‹¤í–‰ë˜ëŠ” ìŠ¤í¬ë¦½íŠ¸ë‚˜ ëª…ë ¹ì–´ë¥¼ ì§€ì •. ì´ í›…ì€ ì»¨í…Œì´ë„ˆê°€ ì¢…ë£Œë˜ê¸° ì „ì— ë°˜ë“œì‹œ ìˆ˜í–‰í•´ì•¼ í•˜ëŠ” ì‘ì—…ì´ ìˆì„ ë•Œ ë§¤ìš° ìœ ìš©\níŠ¸ë˜í”½ ë¶„ë¦¬: Podì´ ì¢…ë£Œë˜ê¸° ì „ì— í•´ë‹¹ Podì„ ì„œë¹„ìŠ¤ íŠ¸ë˜í”½ì—ì„œ ì•ˆì „í•˜ê²Œ ë¶„ë¦¬í•˜ê¸° ìœ„í•´ ì‚¬ìš©ë©ë‹ˆë‹¤. ì •ë¦¬ ì‘ì—…: ì¢…ë£Œ ì „ì— ë¦¬ì†ŒìŠ¤ ì •ë¦¬, ì—°ê²° ì¢…ë£Œ, íŒŒì¼ ì €ì¥ ë“±ì˜ ì‘ì—…ì„ ìˆ˜í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ëŒ€ê¸° ì‹œê°„ ì„¤ì •: ì»¨í…Œì´ë„ˆê°€ ì‹¤ì œë¡œ ì¢…ë£Œë˜ê¸° ì „ì— ì¼ì • ì‹œê°„ ë™ì•ˆ ëŒ€ê¸°í•˜ë„ë¡ ì„¤ì •í•˜ì—¬, í´ë¼ì´ì–¸íŠ¸ì™€ì˜ ì—°ê²°ì´ ì™„ì „íˆ ì¢…ë£Œë˜ë„ë¡ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì•ì„œ ì„¤ì •í•œ Readiness Probe ì„¤ì • ì´í›„ì—ë„, lifecycle ì„¤ì •ì„ í•˜ì§€ ì•ŠëŠ”ë‹¤ë©´ ê°„í—ì ì¸ 502 ì—ëŸ¬ê°€ ë°œìƒë  ìˆ˜ ìˆë‹¤\níŒŒë“œëŠ” ì¢…ë£Œë  ë•Œ SIGTERM, SIGKILL ì²˜ë¦¬ì™€ ì„œë¹„ìŠ¤ ì œì™¸ ì²˜ë¦¬ê°€ ë¹„ë™ê¸°ë¡œ ì²˜ë¦¬ë¨\nì„œë¹„ìŠ¤ê°€ ë¶„ë¦¬ë˜ê¸° ì „ì— Podì´ í´ë¼ì´ì–¸íŠ¸ ìš”ì²­ì— ì •ìƒì ìœ¼ë¡œ ì‘ë‹µí•  ìˆ˜ ì—†ì„ ìˆ˜ ìˆë‹¤.\nì¦‰, ì„œë¹„ìŠ¤ ë¶„ë¦¬ â†’ ì”ë¥˜í•˜ëŠ” ìš”ì²­ ì²˜ë¦¬ â†’ pod ì¢…ë£Œ ë¥¼ í†µí•´ Graceful Shutdownì´ ê°€ëŠ¥í•˜ë„ë¡ ì„¤ì •í•œë‹¤\ndeployment.yml ìˆ˜ì • ì‚¬í•­ ... lifecycle: preStop: exec: command: - /bin/sh - -c - sleep 40 # ì„œë¹„ìŠ¤ ë¶„ë¦¬ê°€ ë°œìƒí•œ í›„ 40ì´ˆ ë™ì•ˆ ëŒ€ê¸° ... ì»¨í…Œì´ë„ˆ ì¢…ë£Œ ìš”ì²­: Kubernetesê°€ Podì„ ì¢…ë£Œí•˜ê¸°ë¡œ ê²°ì •í•˜ë©´, ì»¨í…Œì´ë„ˆì— SIGTERM ì‹ í˜¸ preStop í›… ì‹¤í–‰: SIGTERM ì‹ í˜¸ê°€ ì „ì†¡ëœ í›„, sleep 40 ì‹¤í–‰, ì»¨í…Œì´ë„ˆê°€ 40ì´ˆ ë™ì•ˆ ëŒ€ê¸° ìœ ì˜ˆ ê¸°ê°„ ì‹œì‘ (terminationGracePeriodSeconds): preStop í›…ì´ ì‹¤í–‰ë˜ë©´ì„œ, ë™ì‹œì— terminationGracePeriodSecondsì— ì •ì˜ëœ ìœ ì˜ˆ ê¸°ê°„ì´ ì‹œì‘ ì´ ê¸°ê°„ ë™ì•ˆ KubernetesëŠ” ì»¨í…Œì´ë„ˆê°€ ì •ìƒì ìœ¼ë¡œ ì¢…ë£Œë˜ê¸°ë¥¼ ëŒ€ê¸° ì»¨í…Œì´ë„ˆ ì¢…ë£Œ: preStop í›…ì´ ì™„ë£Œë˜ê³ , ìœ ì˜ˆ ê¸°ê°„ì´ ëë‚˜ë©´ KubernetesëŠ” ì»¨í…Œì´ë„ˆë¥¼ ì¢…ë£Œ í…ŒìŠ¤íŠ¸ bombardier -c 200 -d 3m -l https://{endpoint} [================================================================================================================] 3m0s Done! Statistics Avg Stdev Max Reqs/sec 4205.05 1355.65 20756.97 Latency 47.92ms 8.71ms 2.07s Latency Distribution 50% 45.47ms 75% 49.26ms 90% 57.32ms 95% 64.39ms 99% 80.67ms HTTP codes: 1xx - 0, 2xx - 751239, 3xx - 0, 4xx - 0, 5xx - 3 others - 0 Throughput: 2.82MB/s ì—¬ì „íˆ 5XX ì—ëŸ¬ëŠ” ì¡´ì¬í•œë‹¤.\nterminationGracePeriodSeconds Pod ì¢…ë£Œ ì‹œë‚˜ë¦¬ì˜¤:\nKubernetesê°€ Podì„ ì¢…ë£Œí•˜ê¸°ë¡œ ê²°ì •í•˜ë©´, ë¨¼ì € Pod ë‚´ì˜ ì»¨í…Œì´ë„ˆì— SIGTERM ì‹ í˜¸ë¥¼ ë³´ëƒ„ SIGTERM ì‹ í˜¸ë¥¼ ë°›ì€ ì• í”Œë¦¬ì¼€ì´ì…˜ì€ í˜„ì¬ ì²˜ë¦¬ ì¤‘ì¸ ìš”ì²­ì„ ì™„ë£Œí•˜ê³ , í•„ìš”í•œ ì •ë¦¬ ì‘ì—…ì„ ìˆ˜í–‰ ê°€ëŠ¥ ìœ ì˜ˆ ê¸°ê°„ ì„¤ì •:\nterminationGracePeriodSecondsëŠ” ì´ ìœ ì˜ˆ ê¸°ê°„ì„ ì •ì˜. ì´ ê¸°ê°„ ë™ì•ˆ KubernetesëŠ” ì»¨í…Œì´ë„ˆê°€ ì •ìƒì ìœ¼ë¡œ ì¢…ë£Œë  ì‹œê°„ì„ ëŒ€ê¸° ê¸°ë³¸ê°’ì€ 30ì´ˆì…ë‹ˆë‹¤. ì´ ì‹œê°„ì´ ì§€ë‚˜ë©´ KubernetesëŠ” ì»¨í…Œì´ë„ˆê°€ ì—¬ì „íˆ ì‹¤í–‰ ì¤‘ì¸ ê²½ìš° ê°•ì œë¡œ ì¢…ë£Œ(SIGKILL) SIGKILL ì‹ í˜¸:\nterminationGracePeriodSeconds ê¸°ê°„ì´ ë§Œë£Œë˜ì—ˆì„ ë•Œë„ ì»¨í…Œì´ë„ˆê°€ ì¢…ë£Œë˜ì§€ ì•Šì•˜ë‹¤ë©´, KubernetesëŠ” SIGKILL ì‹ í˜¸ë¥¼ ì¤Œ, ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ê°•ì œ ì¢…ë£Œë¨ ì¼ì • lifecycle.preStop ì„¤ì •ì„ í†µí•´, 40ì´ˆì˜ ìœ ì˜ˆì‹œê°„ì„ ë‘ì–´ ì• í”Œë¦¬ì¼€ì´ì…˜ì— ì”ë¥˜í•˜ëŠ” ìš”ì²­ì„ ì‘ë‹µí•  ì‹œê°„ì„ ì£¼ì—ˆìŒ.\ní•˜ì§€ë§Œ terminationGracePeriodSeconds ëŠ” ê¸°ë³¸ 30ì´ˆë¡œ ì„¤ì •ë˜ê¸°ì— 30ì´ˆê°€ ì§€ë‚˜ë„ë¡ Podì´ ì‹¤í–‰ì¤‘ì¸ ê²½ìš° SIGKILLì„ ì „ì†¡í•˜ì—¬ íŒŒë“œë¥¼ ê°•ì œ ì¢…ë£Œì‹œí‚´\ndeployment.yml ìˆ˜ì • ì‚¬í•­ ... terminationGracePeriodSeconds: 50 ... INGRESSì™€ ì—°ê²°ëœ ALB ì†ì„±ì„ ê¼­ í™•ì¸í•˜ì! terminationGracePeriodSecondsê°€ ALB íƒ€ì„ì•„ì›ƒë³´ë‹¤ ê¸´ ê²½ìš°, íŠ¹ì • ì‹œë‚˜ë¦¬ì˜¤ì—ì„œ 504 Gateway Timeout ì˜¤ë¥˜ê°€ ë°œìƒí•  ìˆ˜ ìˆìŒ\nì˜ˆìƒ ë°œìƒ ì‹œë‚˜ë¦¬ì˜¤ : ìš”ì²­ ì¤‘ê°„ì— ì¢…ë£Œ ë°œìƒ â†’ ALB íƒ€ì„ì•„ì›ƒ ë„ë‹¬ â†’ ì‘ë‹µ ì „ Pod ì¢…ë£Œ\nì´ë¥¼ ì˜ˆë°©í•˜ê¸° ìœ„í•´, lifecycle.preStop (40s) \u003c terminationGracePeriodSeconds (50s) \u003c ALB Timeout (60s) ë¡œ ì§€ì •\ní…ŒìŠ¤íŠ¸ bombardier -c 200 -d 3m -l https://{endpoint} [================================================================================================================] 3m0s Done! Statistics Avg Stdev Max Reqs/sec 4293.51 1286.80 12924.64 Latency 46.74ms 8.94ms 547.25ms Latency Distribution 50% 44.48ms 75% 46.87ms 90% 54.16ms 95% 66.82ms 99% 81.69ms HTTP codes: 1xx - 0, 2xx - 770240, 3xx - 0, 4xx - 0, 5xx - 0 others - 0 Throughput: 2.89MB/s REF ì¹´ì¹´ì˜¤ í…Œí¬ k8s ë¬´ì¤‘ë‹¨ ë°°í¬ Pod ë¼ì´í”„ì‚¬ì´í´ ","wordCount":"855","inLanguage":"en","image":"https://dingyu.dev/posts/k8s-zero-downtime/img/kubernetes.png","datePublished":"2024-08-16T00:00:00Z","dateModified":"2024-08-16T00:00:00Z","author":{"@type":"Person","name":"dingyu"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://dingyu.dev/posts/k8s-zero-downtime/"},"publisher":{"@type":"Organization","name":"Ding's Coding Forge","logo":{"@type":"ImageObject","url":"https://dingyu.dev/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://dingyu.dev/ accesskey=h title="Ding's Coding Forge (Alt + H)"><img src=https://dingyu.dev/apple-touch-icon.png alt aria-label=logo height=35>Ding's Coding Forge</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://dingyu.dev/about/ title=About><span>About</span></a></li><li><a href=https://dingyu.dev/categories/ title=Categories><span>Categories</span></a></li><li><a href=https://dingyu.dev/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://dingyu.dev/archives/ title=Archives><span>Archives</span></a></li><li><a href=https://dingyu.dev/search/ title="ğŸ” (Alt + /)" accesskey=/><span>ğŸ”</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://dingyu.dev/>Home</a>&nbsp;Â»&nbsp;<a href=https://dingyu.dev/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">[Infra] ì¿ ë²„ë„¤í‹±ìŠ¤ ë¬´ì¤‘ë‹¨ ë°°í¬ ì„¤ì •í•˜ê¸°</h1><div class=post-description>During our migration from IDC to EKS, we encountered numerous challengesâ€”including security configurations, network settings, databases, and ultimately, application deployments. After each deployment, we frequently faced 502 and 504 errors without a clear solution. Since minimizing downtime was critical, Iâ€™ll share how we overcame these 502 and 504 issues.</div><div class=post-meta><span title='2024-08-16 00:00:00 +0000 UTC'>August 16, 2024</span>&nbsp;Â·&nbsp;5 min&nbsp;Â·&nbsp;855 words&nbsp;Â·&nbsp;dingyu&nbsp;|&nbsp;<a href=https://github.com/dings-things/blog/tree/main/content/posts/k8s-zero-downtime/index.md rel="noopener noreferrer" target=_blank>Suggest Changes</a></div></header><figure class=entry-cover><img loading=eager src=https://dingyu.dev/img/kubernetes.png alt></figure><aside id=toc-container class="toc-container wide"><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#%eb%b0%b0%ea%b2%bd aria-label=ë°°ê²½>ë°°ê²½</a></li><li><a href=#%ec%84%a4%ec%a0%95 aria-label=ì„¤ì •>ì„¤ì •</a><ul><li><a href=#%eb%b6%80%ed%95%98%ed%85%8c%ec%8a%a4%ed%8a%b8-%ed%88%b4-%ec%84%a4%ec%b9%98 aria-label="ë¶€í•˜í…ŒìŠ¤íŠ¸ íˆ´ ì„¤ì¹˜">ë¶€í•˜í…ŒìŠ¤íŠ¸ íˆ´ ì„¤ì¹˜</a></li><li><a href=#readniess-probe aria-label="Readniess Probe">Readniess Probe</a><ul><ul><li><a href=#deploymentyml-%ec%88%98%ec%a0%95-%ec%82%ac%ed%95%ad aria-label="deployment.yml ìˆ˜ì • ì‚¬í•­">deployment.yml ìˆ˜ì • ì‚¬í•­</a></li><li><a href=#%ed%85%8c%ec%8a%a4%ed%8a%b8 aria-label=í…ŒìŠ¤íŠ¸>í…ŒìŠ¤íŠ¸</a></li></ul></ul></li><li><a href=#lifecycle--prestop aria-label="lifecycle & preStop">lifecycle & preStop</a><ul><ul><li><a href=#deploymentyml-%ec%88%98%ec%a0%95-%ec%82%ac%ed%95%ad-1 aria-label="deployment.yml ìˆ˜ì • ì‚¬í•­">deployment.yml ìˆ˜ì • ì‚¬í•­</a></li><li><a href=#%ed%85%8c%ec%8a%a4%ed%8a%b8-1 aria-label=í…ŒìŠ¤íŠ¸>í…ŒìŠ¤íŠ¸</a></li></ul></ul></li><li><a href=#terminationgraceperiodseconds aria-label=terminationGracePeriodSeconds>terminationGracePeriodSeconds</a><ul><ul><li><a href=#deploymentyml-%ec%88%98%ec%a0%95-%ec%82%ac%ed%95%ad-2 aria-label="deployment.yml ìˆ˜ì • ì‚¬í•­">deployment.yml ìˆ˜ì • ì‚¬í•­</a></li><li><a href=#%ed%85%8c%ec%8a%a4%ed%8a%b8-2 aria-label=í…ŒìŠ¤íŠ¸>í…ŒìŠ¤íŠ¸</a></li></ul><li><a href=#ref aria-label=REF>REF</a></li></ul></li></ul></li></ul></div></details></div></aside><script>let activeElement,elements;window.addEventListener("DOMContentLoaded",function(){checkTocPosition(),elements=document.querySelectorAll("h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]"),activeElement=elements[0];const t=encodeURI(activeElement.getAttribute("id")).toLowerCase();document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active")},!1),window.addEventListener("resize",function(){checkTocPosition()},!1),window.addEventListener("scroll",()=>{activeElement=Array.from(elements).find(e=>{if(getOffsetTop(e)-window.pageYOffset>0&&getOffsetTop(e)-window.pageYOffset<window.innerHeight/2)return e})||activeElement,elements.forEach(e=>{const t=encodeURI(e.getAttribute("id")).toLowerCase();e===activeElement?document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active"):document.querySelector(`.inner ul li a[href="#${t}"]`).classList.remove("active")})},!1);const main=parseInt(getComputedStyle(document.body).getPropertyValue("--article-width"),10),toc=parseInt(getComputedStyle(document.body).getPropertyValue("--toc-width"),10),gap=parseInt(getComputedStyle(document.body).getPropertyValue("--gap"),10);function checkTocPosition(){const e=document.body.scrollWidth;e-main-toc*2-gap*4>0?document.getElementById("toc-container").classList.add("wide"):document.getElementById("toc-container").classList.remove("wide")}function getOffsetTop(e){if(!e.getClientRects().length)return 0;let t=e.getBoundingClientRect(),n=e.ownerDocument.defaultView;return t.top+n.pageYOffset}</script><div class=post-content><h1 id=ë°°ê²½>ë°°ê²½<a hidden class=anchor aria-hidden=true href=#ë°°ê²½>#</a></h1><hr><ul><li>k8s í™˜ê²½ Deploy í›„, ë¶€í•˜í…ŒìŠ¤íŠ¸ ê³¼ì •ì—ì„œ ê°„í—ì ìœ¼ë¡œ 502 / 504 ì—ëŸ¬ ë°œìƒ í™•ì¸</li><li>Podë“¤ì´ êµì²´ ë˜ë©´ì„œ ê¸°ì¡´ ìš”ì²­ì— ëŒ€í•œ ì‘ë‹µì„ ë°˜í™˜í•˜ì§€ ëª»í•œ ì±„ ì¢…ë£Œ ë¨ â†’ 504 Gateway Timeout</li><li>ì‹ ê·œ Podì´ ì˜¬ë¼ê°€ê³  ëŒ€ì²´ë˜ëŠ” Podì´ Terminate ë¨ â†’ 502 Bad Gateway</li></ul><p>ë¡¤ë§ì—…ë°ì´íŠ¸ê°€ ì§„í–‰ë˜ì§€ë§Œ <strong>Readiness Probe ì„¤ì • ì—†ì´ëŠ” ìˆœë‹¨ì´ ë°œìƒ</strong>í•  ì—¬ì§€ê°€ ìˆìŒì„ í™•ì¸</p><h1 id=ì„¤ì •>ì„¤ì •<a hidden class=anchor aria-hidden=true href=#ì„¤ì •>#</a></h1><hr><h2 id=ë¶€í•˜í…ŒìŠ¤íŠ¸-íˆ´-ì„¤ì¹˜>ë¶€í•˜í…ŒìŠ¤íŠ¸ íˆ´ ì„¤ì¹˜<a hidden class=anchor aria-hidden=true href=#ë¶€í•˜í…ŒìŠ¤íŠ¸-íˆ´-ì„¤ì¹˜>#</a></h2><p><a href=https://github.com/codesenberg/bombardier>bombardier</a> : ì‰½ê³  ê°„í¸í•œ go cli ë¶€í•˜í…ŒìŠ¤íŠ¸ íˆ´
<a href=https://github.com/tsenart/vegeta>vegeta</a> : ìŠ¤í¬ë¦½íŠ¸ ì‘ì„±ìœ¼ë¡œ ë³´ë‹¤ ìœ ì—°í•œ ìš”ì²­ ê°€ëŠ¥, status code ë¥¼ ìƒì„¸íˆ ì‘ë‹µí•˜ëŠ” íˆ´</p><p>ê° íˆ´ì˜ ìì„¸í•œ ì„¤ì¹˜ ê³¼ì •ì€ ìƒëµ í•©ë‹ˆë‹¤.</p><hr><h2 id=readniess-probe>Readniess Probe<a hidden class=anchor aria-hidden=true href=#readniess-probe>#</a></h2><blockquote><p>Podì´ ì„œë¹„ìŠ¤ íŠ¸ë˜í”½ì„ ì²˜ë¦¬í•  ì¤€ë¹„ê°€ ë˜ì—ˆëŠ”ì§€ë¥¼ íŒë‹¨í•˜ëŠ” ë° ì‚¬ìš©ë˜ëŠ” ë©”ì»¤ë‹ˆì¦˜</p><p>íŠ¹ì • ì»¨í…Œì´ë„ˆê°€ ì‹œì‘ëœ í›„ì—ë„ ì¼ë¶€ ì‘ì—…ì´ ì™„ë£Œë  ë•Œê¹Œì§€ ì™¸ë¶€ íŠ¸ë˜í”½ì„ ì²˜ë¦¬í•  ì¤€ë¹„ê°€ ë˜ì§€ ì•Šì•˜ì„ ìˆ˜ ìˆê¸° ë•Œë¬¸ì— ì´ë¥¼ í™•ì¸í•˜ëŠ” ì—­í• ì„ í•¨</p></blockquote><ol><li>íŠ¸ë˜í”½ ë¼ìš°íŒ… ì œì–´:<ul><li>Readiness Probeê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë  ë•Œê¹Œì§€ KubernetesëŠ” í•´ë‹¹ Podìœ¼ë¡œ íŠ¸ë˜í”½ì„ ë¼ìš°íŒ…í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ì´ëŠ” Podì´ ì¤€ë¹„ë˜ì§€ ì•Šì€ ìƒíƒœì—ì„œ ìš”ì²­ì„ ì²˜ë¦¬í•˜ì§€ ì•Šë„ë¡ ë³´ì¥í•©ë‹ˆë‹¤.</li><li>ì¤€ë¹„ê°€ ì™„ë£Œëœ í›„ì—ë§Œ íŠ¸ë˜í”½ì´ Podìœ¼ë¡œ ë¼ìš°íŒ…ë˜ê¸° ë•Œë¬¸ì—, Podì´ ì˜¬ë°”ë¥´ê²Œ ì„¤ì •ë˜ê³  í•„ìš”í•œ ë¦¬ì†ŒìŠ¤ë¥¼ í™•ë³´í•œ ìƒíƒœì—ì„œë§Œ ìš”ì²­ì„ ì²˜ë¦¬í•˜ê²Œ ë©ë‹ˆë‹¤.</li></ul></li></ol><blockquote></blockquote><ol start=2><li>Podì˜ ìƒíƒœ í™•ì¸:<ul><li>Readiness ProbeëŠ” íŠ¹ì • ì¡°ê±´ì´ ì¶©ì¡±ë  ë•Œê¹Œì§€ Kubernetesì— Podì´ íŠ¸ë˜í”½ì„ ë°›ì„ ì¤€ë¹„ê°€ ë˜ì§€ ì•Šì•˜ë‹¤ê³  ì•Œë¦¬ë©°, ì¤€ë¹„ê°€ ì™„ë£Œëœ í›„ì—ëŠ” íŠ¸ë˜í”½ì„ ë°›ì„ ì¤€ë¹„ê°€ ë˜ì—ˆìŒì„ ì•Œë¦½ë‹ˆë‹¤.</li><li>Podì´ ì¤€ë¹„ë˜ì§€ ì•Šì€ ê²½ìš°, KubernetesëŠ” Podì„ ì„œë¹„ìŠ¤ì˜ ì—”ë“œí¬ì¸íŠ¸ì—ì„œ ì œê±°í•©ë‹ˆë‹¤.</li></ul></li></ol><p>502ê°€ ë°œìƒí•˜ëŠ” ì›ì¸ ì¤‘ í•˜ë‚˜ì´ë‹¤</p><p>Readiness Probeë¥¼ ì§€ì •í•˜ì§€ ì•Šì€ ê²½ìš°, ì»¨í…Œì´ë„ˆê°€ ì˜¬ë¼ê°€ëŠ” ì‹œì ì—ì„œ íŠ¸ë˜í”½ì´ ë“¤ì–´ì˜¤ê²Œ ëœë‹¤.</p><p>ì´ë•Œì—, Pod ë‚´ë¶€ì˜ ì„œë²„ ì´ˆê¸°í™”ê°€ ì™„ì „íˆ ë˜ì§€ ì•Šì€ ì‹œì ì—ì„œ ìš”ì²­ì´ ì˜¨ ê²½ìš° â†’ 502 Bad Gatewayë¥¼ ì‘ë‹µí•œë‹¤</p><p><img loading=lazy src=/posts/k8s-zero-downtime/1.png></p><h4 id=deploymentyml-ìˆ˜ì •-ì‚¬í•­>deployment.yml ìˆ˜ì • ì‚¬í•­<a hidden class=anchor aria-hidden=true href=#deploymentyml-ìˆ˜ì •-ì‚¬í•­>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nn>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>readinessProbe</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>httpGet</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>8080</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/alive</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>scheme</span><span class=p>:</span><span class=w> </span><span class=l>HTTP  </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>initialDelaySeconds</span><span class=p>:</span><span class=w> </span><span class=m>30</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>periodSeconds</span><span class=p>:</span><span class=w> </span><span class=m>30</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>...</span><span class=w>
</span></span></span></code></pre></div><p>Healthcheck ì‘ë‹µìš© Endpointë¥¼ ìƒì„±í•´ë‘ê³  ì‘ë‹µ ìƒíƒœì½”ë“œê°€ 200ìœ¼ë¡œ ëŒì•„ì˜¤ë©´ ìš”ì²­ì„ ë°›ëŠ” í˜•ì‹ìœ¼ë¡œ ì„¤ì •</p><h4 id=í…ŒìŠ¤íŠ¸>í…ŒìŠ¤íŠ¸<a hidden class=anchor aria-hidden=true href=#í…ŒìŠ¤íŠ¸>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>bombardier -c <span class=m>200</span> -d 3m -l https://<span class=o>{</span>endpoint<span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>[================================================================================================================]</span> 3m0s
</span></span><span class=line><span class=cl>Done!
</span></span><span class=line><span class=cl>Statistics        Avg      Stdev        Max
</span></span><span class=line><span class=cl>  Reqs/sec      4205.76    1250.10   16927.12
</span></span><span class=line><span class=cl>  Latency       47.81ms    10.16ms      2.07s
</span></span><span class=line><span class=cl>  Latency Distribution
</span></span><span class=line><span class=cl>     50%    45.08ms
</span></span><span class=line><span class=cl>     75%    49.77ms
</span></span><span class=line><span class=cl>     90%    57.60ms
</span></span><span class=line><span class=cl>     95%    64.29ms
</span></span><span class=line><span class=cl>     99%    81.95ms
</span></span><span class=line><span class=cl>  HTTP codes:
</span></span><span class=line><span class=cl>    1xx - 0, 2xx - 0, 3xx - 0, 4xx - 753060, 5xx - <span class=m>12</span>
</span></span><span class=line><span class=cl>    others - <span class=m>0</span>
</span></span><span class=line><span class=cl>  Throughput:     3.24MB/s
</span></span></code></pre></div><p>ì—¬ì „íˆ <strong>5XX</strong> ì—ëŸ¬ëŠ” ì¡´ì¬í•œë‹¤.</p><hr><h2 id=lifecycle--prestop>lifecycle & preStop<a hidden class=anchor aria-hidden=true href=#lifecycle--prestop>#</a></h2><blockquote><p>lifecycle ì„¤ì •ì´ë€?
ì»¨í…Œì´ë„ˆì˜ ìƒëª…ì£¼ê¸° ë™ì•ˆ íŠ¹ì • ì‹œì ì— ì‹¤í–‰ë  ì‘ì—…ì„ ì •ì˜í•  ìˆ˜ ìˆëŠ” Kubernetesì˜ êµ¬ì„± ì˜µì…˜ (AOPì™€ ìœ ì‚¬&mldr;í•˜ë‹¤ëŠ” ìƒê°)</p></blockquote><ul><li>postStart: ì»¨í…Œì´ë„ˆê°€ ì‹œì‘ëœ ì§í›„ì— ì‹¤í–‰ë©ë‹ˆë‹¤. ì»¨í…Œì´ë„ˆê°€ ì‹œì‘ëœ í›„ ì¶”ê°€ì ì¸ ì´ˆê¸°í™” ì‘ì—…ì„ ìˆ˜í–‰í•˜ëŠ” ë° ì‚¬ìš©</li><li>preStop: ì»¨í…Œì´ë„ˆê°€ ì¢…ë£Œë˜ê¸° ì§ì „ì— ì‹¤í–‰ë©ë‹ˆë‹¤. ì¢…ë£Œ ì „ì— í•„ìš”í•œ ì‘ì—…ì„ ìˆ˜í–‰í•˜ë„ë¡ ì„¤ì • ê°€ëŠ¥</li></ul><blockquote></blockquote><p><strong>preStop</strong>
preStop í›…ì€ ì»¨í…Œì´ë„ˆê°€ ì¢…ë£Œë  ë•Œ ì‹¤í–‰ë˜ëŠ” ìŠ¤í¬ë¦½íŠ¸ë‚˜ ëª…ë ¹ì–´ë¥¼ ì§€ì •. ì´ í›…ì€ ì»¨í…Œì´ë„ˆê°€ ì¢…ë£Œë˜ê¸° ì „ì— ë°˜ë“œì‹œ ìˆ˜í–‰í•´ì•¼ í•˜ëŠ” ì‘ì—…ì´ ìˆì„ ë•Œ ë§¤ìš° ìœ ìš©</p><ul><li>íŠ¸ë˜í”½ ë¶„ë¦¬: Podì´ ì¢…ë£Œë˜ê¸° ì „ì— í•´ë‹¹ Podì„ ì„œë¹„ìŠ¤ íŠ¸ë˜í”½ì—ì„œ ì•ˆì „í•˜ê²Œ ë¶„ë¦¬í•˜ê¸° ìœ„í•´ ì‚¬ìš©ë©ë‹ˆë‹¤.</li><li>ì •ë¦¬ ì‘ì—…: ì¢…ë£Œ ì „ì— ë¦¬ì†ŒìŠ¤ ì •ë¦¬, ì—°ê²° ì¢…ë£Œ, íŒŒì¼ ì €ì¥ ë“±ì˜ ì‘ì—…ì„ ìˆ˜í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li><li>ëŒ€ê¸° ì‹œê°„ ì„¤ì •: ì»¨í…Œì´ë„ˆê°€ ì‹¤ì œë¡œ ì¢…ë£Œë˜ê¸° ì „ì— ì¼ì • ì‹œê°„ ë™ì•ˆ ëŒ€ê¸°í•˜ë„ë¡ ì„¤ì •í•˜ì—¬, í´ë¼ì´ì–¸íŠ¸ì™€ì˜ ì—°ê²°ì´ ì™„ì „íˆ ì¢…ë£Œë˜ë„ë¡ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li></ul><p>ì•ì„œ ì„¤ì •í•œ Readiness Probe ì„¤ì • ì´í›„ì—ë„, lifecycle ì„¤ì •ì„ í•˜ì§€ ì•ŠëŠ”ë‹¤ë©´ ê°„í—ì ì¸ 502 ì—ëŸ¬ê°€ ë°œìƒë  ìˆ˜ ìˆë‹¤</p><p>íŒŒë“œëŠ” ì¢…ë£Œë  ë•Œ SIGTERM, SIGKILL ì²˜ë¦¬ì™€ ì„œë¹„ìŠ¤ ì œì™¸ ì²˜ë¦¬ê°€ ë¹„ë™ê¸°ë¡œ ì²˜ë¦¬ë¨</p><p>ì„œë¹„ìŠ¤ê°€ ë¶„ë¦¬ë˜ê¸° ì „ì— Podì´ í´ë¼ì´ì–¸íŠ¸ ìš”ì²­ì— ì •ìƒì ìœ¼ë¡œ ì‘ë‹µí•  ìˆ˜ ì—†ì„ ìˆ˜ ìˆë‹¤.</p><p>ì¦‰, ì„œë¹„ìŠ¤ ë¶„ë¦¬ â†’ ì”ë¥˜í•˜ëŠ” ìš”ì²­ ì²˜ë¦¬ â†’ pod ì¢…ë£Œ ë¥¼ í†µí•´ Graceful Shutdownì´ ê°€ëŠ¥í•˜ë„ë¡ ì„¤ì •í•œë‹¤</p><p><img loading=lazy src=/posts/k8s-zero-downtime/2.png></p><h4 id=deploymentyml-ìˆ˜ì •-ì‚¬í•­-1>deployment.yml ìˆ˜ì • ì‚¬í•­<a hidden class=anchor aria-hidden=true href=#deploymentyml-ìˆ˜ì •-ì‚¬í•­-1>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>...
</span></span><span class=line><span class=cl>lifecycle:
</span></span><span class=line><span class=cl>    preStop:
</span></span><span class=line><span class=cl>        exec:
</span></span><span class=line><span class=cl>        command:
</span></span><span class=line><span class=cl>        - /bin/sh
</span></span><span class=line><span class=cl>        - -c
</span></span><span class=line><span class=cl>        - sleep <span class=m>40</span>  <span class=c1># ì„œë¹„ìŠ¤ ë¶„ë¦¬ê°€ ë°œìƒí•œ í›„ 40ì´ˆ ë™ì•ˆ ëŒ€ê¸°</span>
</span></span><span class=line><span class=cl>...
</span></span></code></pre></div><ol><li>ì»¨í…Œì´ë„ˆ ì¢…ë£Œ ìš”ì²­: Kubernetesê°€ Podì„ ì¢…ë£Œí•˜ê¸°ë¡œ ê²°ì •í•˜ë©´, ì»¨í…Œì´ë„ˆì— SIGTERM ì‹ í˜¸</li><li>preStop í›… ì‹¤í–‰: SIGTERM ì‹ í˜¸ê°€ ì „ì†¡ëœ í›„, sleep 40 ì‹¤í–‰, ì»¨í…Œì´ë„ˆê°€ 40ì´ˆ ë™ì•ˆ ëŒ€ê¸°</li><li>ìœ ì˜ˆ ê¸°ê°„ ì‹œì‘ (terminationGracePeriodSeconds): preStop í›…ì´ ì‹¤í–‰ë˜ë©´ì„œ, ë™ì‹œì— terminationGracePeriodSecondsì— ì •ì˜ëœ ìœ ì˜ˆ ê¸°ê°„ì´ ì‹œì‘
ì´ ê¸°ê°„ ë™ì•ˆ KubernetesëŠ” ì»¨í…Œì´ë„ˆê°€ ì •ìƒì ìœ¼ë¡œ ì¢…ë£Œë˜ê¸°ë¥¼ ëŒ€ê¸°</li><li>ì»¨í…Œì´ë„ˆ ì¢…ë£Œ: preStop í›…ì´ ì™„ë£Œë˜ê³ , ìœ ì˜ˆ ê¸°ê°„ì´ ëë‚˜ë©´ KubernetesëŠ” ì»¨í…Œì´ë„ˆë¥¼ ì¢…ë£Œ</li></ol><h4 id=í…ŒìŠ¤íŠ¸-1>í…ŒìŠ¤íŠ¸<a hidden class=anchor aria-hidden=true href=#í…ŒìŠ¤íŠ¸-1>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>bombardier -c <span class=m>200</span> -d 3m -l https://<span class=o>{</span>endpoint<span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>[================================================================================================================]</span> 3m0s
</span></span><span class=line><span class=cl>Done!
</span></span><span class=line><span class=cl>Statistics        Avg      Stdev        Max
</span></span><span class=line><span class=cl>  Reqs/sec      4205.05    1355.65   20756.97
</span></span><span class=line><span class=cl>  Latency       47.92ms     8.71ms      2.07s
</span></span><span class=line><span class=cl>  Latency Distribution
</span></span><span class=line><span class=cl>     50%    45.47ms
</span></span><span class=line><span class=cl>     75%    49.26ms
</span></span><span class=line><span class=cl>     90%    57.32ms
</span></span><span class=line><span class=cl>     95%    64.39ms
</span></span><span class=line><span class=cl>     99%    80.67ms
</span></span><span class=line><span class=cl>  HTTP codes:
</span></span><span class=line><span class=cl>    1xx - 0, 2xx - 751239, 3xx - 0, 4xx - 0, 5xx - <span class=m>3</span>
</span></span><span class=line><span class=cl>    others - <span class=m>0</span>
</span></span><span class=line><span class=cl>  Throughput:     2.82MB/s
</span></span></code></pre></div><p>ì—¬ì „íˆ <strong>5XX</strong> ì—ëŸ¬ëŠ” ì¡´ì¬í•œë‹¤.</p><hr><h2 id=terminationgraceperiodseconds>terminationGracePeriodSeconds<a hidden class=anchor aria-hidden=true href=#terminationgraceperiodseconds>#</a></h2><blockquote><p><strong>Pod ì¢…ë£Œ ì‹œë‚˜ë¦¬ì˜¤:</strong></p></blockquote><ul><li>Kubernetesê°€ Podì„ ì¢…ë£Œí•˜ê¸°ë¡œ ê²°ì •í•˜ë©´, ë¨¼ì € Pod ë‚´ì˜ ì»¨í…Œì´ë„ˆì— SIGTERM ì‹ í˜¸ë¥¼ ë³´ëƒ„</li><li>SIGTERM ì‹ í˜¸ë¥¼ ë°›ì€ ì• í”Œë¦¬ì¼€ì´ì…˜ì€ í˜„ì¬ ì²˜ë¦¬ ì¤‘ì¸ ìš”ì²­ì„ ì™„ë£Œí•˜ê³ , í•„ìš”í•œ ì •ë¦¬ ì‘ì—…ì„ ìˆ˜í–‰ ê°€ëŠ¥</li></ul><blockquote><p><strong>ìœ ì˜ˆ ê¸°ê°„ ì„¤ì •:</strong></p></blockquote><ul><li>terminationGracePeriodSecondsëŠ” ì´ ìœ ì˜ˆ ê¸°ê°„ì„ ì •ì˜. ì´ ê¸°ê°„ ë™ì•ˆ KubernetesëŠ” ì»¨í…Œì´ë„ˆê°€ ì •ìƒì ìœ¼ë¡œ ì¢…ë£Œë  ì‹œê°„ì„ ëŒ€ê¸°</li><li>ê¸°ë³¸ê°’ì€ 30ì´ˆì…ë‹ˆë‹¤. ì´ ì‹œê°„ì´ ì§€ë‚˜ë©´ KubernetesëŠ” ì»¨í…Œì´ë„ˆê°€ ì—¬ì „íˆ ì‹¤í–‰ ì¤‘ì¸ ê²½ìš° ê°•ì œë¡œ ì¢…ë£Œ(SIGKILL)</li></ul><blockquote><p><strong>SIGKILL ì‹ í˜¸:</strong></p></blockquote><ul><li>terminationGracePeriodSeconds ê¸°ê°„ì´ ë§Œë£Œë˜ì—ˆì„ ë•Œë„ ì»¨í…Œì´ë„ˆê°€ ì¢…ë£Œë˜ì§€ ì•Šì•˜ë‹¤ë©´, KubernetesëŠ” SIGKILL ì‹ í˜¸ë¥¼ ì¤Œ, ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ê°•ì œ ì¢…ë£Œë¨</li></ul><p>ì¼ì • lifecycle.preStop ì„¤ì •ì„ í†µí•´, 40ì´ˆì˜ ìœ ì˜ˆì‹œê°„ì„ ë‘ì–´ ì• í”Œë¦¬ì¼€ì´ì…˜ì— ì”ë¥˜í•˜ëŠ” ìš”ì²­ì„ ì‘ë‹µí•  ì‹œê°„ì„ ì£¼ì—ˆìŒ.</p><p>í•˜ì§€ë§Œ terminationGracePeriodSeconds ëŠ” ê¸°ë³¸ <strong>30ì´ˆë¡œ ì„¤ì •ë˜ê¸°ì— 30ì´ˆê°€ ì§€ë‚˜ë„ë¡ Podì´ ì‹¤í–‰ì¤‘ì¸ ê²½ìš° SIGKILLì„ ì „ì†¡</strong>í•˜ì—¬ íŒŒë“œë¥¼ ê°•ì œ ì¢…ë£Œì‹œí‚´</p><p><img loading=lazy src=/posts/k8s-zero-downtime/3.png></p><h4 id=deploymentyml-ìˆ˜ì •-ì‚¬í•­-2>deployment.yml ìˆ˜ì • ì‚¬í•­<a hidden class=anchor aria-hidden=true href=#deploymentyml-ìˆ˜ì •-ì‚¬í•­-2>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nn>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>terminationGracePeriodSeconds</span><span class=p>:</span><span class=w> </span><span class=m>50</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>...</span><span class=w>
</span></span></span></code></pre></div><p>INGRESSì™€ ì—°ê²°ëœ ALB ì†ì„±ì„ ê¼­ í™•ì¸í•˜ì!
<code>terminationGracePeriodSeconds</code>ê°€ ALB íƒ€ì„ì•„ì›ƒë³´ë‹¤ ê¸´ ê²½ìš°, íŠ¹ì • ì‹œë‚˜ë¦¬ì˜¤ì—ì„œ <strong>504 Gateway Timeout ì˜¤ë¥˜ê°€ ë°œìƒ</strong>í•  ìˆ˜ ìˆìŒ</p><p><strong>ì˜ˆìƒ ë°œìƒ ì‹œë‚˜ë¦¬ì˜¤</strong> : ìš”ì²­ ì¤‘ê°„ì— ì¢…ë£Œ ë°œìƒ â†’ ALB íƒ€ì„ì•„ì›ƒ ë„ë‹¬ â†’ ì‘ë‹µ ì „ Pod ì¢…ë£Œ</p><p>ì´ë¥¼ ì˜ˆë°©í•˜ê¸° ìœ„í•´, lifecycle.preStop (40s) &lt; terminationGracePeriodSeconds (50s) &lt; ALB Timeout (60s) ë¡œ ì§€ì •</p><h4 id=í…ŒìŠ¤íŠ¸-2>í…ŒìŠ¤íŠ¸<a hidden class=anchor aria-hidden=true href=#í…ŒìŠ¤íŠ¸-2>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>bombardier -c <span class=m>200</span> -d 3m -l https://<span class=o>{</span>endpoint<span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>[================================================================================================================]</span> 3m0s
</span></span><span class=line><span class=cl>Done!
</span></span><span class=line><span class=cl>Statistics        Avg      Stdev        Max
</span></span><span class=line><span class=cl>  Reqs/sec      4293.51    1286.80   12924.64
</span></span><span class=line><span class=cl>  Latency       46.74ms     8.94ms   547.25ms
</span></span><span class=line><span class=cl>  Latency Distribution
</span></span><span class=line><span class=cl>     50%    44.48ms
</span></span><span class=line><span class=cl>     75%    46.87ms
</span></span><span class=line><span class=cl>     90%    54.16ms
</span></span><span class=line><span class=cl>     95%    66.82ms
</span></span><span class=line><span class=cl>     99%    81.69ms
</span></span><span class=line><span class=cl>  HTTP codes:
</span></span><span class=line><span class=cl>    1xx - 0, 2xx - 770240, 3xx - 0, 4xx - 0, 5xx - <span class=m>0</span>
</span></span><span class=line><span class=cl>    others - <span class=m>0</span>
</span></span><span class=line><span class=cl>  Throughput:     2.89MB/s
</span></span></code></pre></div><hr><h3 id=ref>REF<a hidden class=anchor aria-hidden=true href=#ref>#</a></h3><ul><li><a href=https://tech.kakao.com/posts/360>ì¹´ì¹´ì˜¤ í…Œí¬ k8s ë¬´ì¤‘ë‹¨ ë°°í¬</a></li><li><a href=https://kubernetes.io/ko/docs/concepts/workloads/pods/pod-lifecycle/>Pod ë¼ì´í”„ì‚¬ì´í´</a></li></ul></div><footer class=post-footer><ul class=post-tags><li><a href=https://dingyu.dev/tags/k8s/>K8s</a></li><li><a href=https://dingyu.dev/tags/zero-downtime/>Zero-Downtime</a></li></ul><nav class=paginav><a class=prev href=https://dingyu.dev/posts/sentry/><span class=title>Â« Prev</span><br><span>[Third-Party] Sentry ì—°ë™</span>
</a><a class=next href=https://dingyu.dev/posts/aws-well-architected/><span class=title>Next Â»</span><br><span>[Infra] AWS Well Architected</span></a></nav></footer><div id=giscus_thread><script src=https://giscus.app/client.js data-repo=dings-things/blog data-repo-id=R_kgDON9IuAw data-category=Announcements data-category-id=DIC_kwDON9IuA84CnTai data-mapping=og:title data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=bottom data-theme=preferred_color_scheme data-lang=ko data-loading=lazy crossorigin=anonymous async></script></div></article></main><footer class=footer><span>&copy; 2025 <a href=https://dingyu.dev/>Ding's Coding Forge</a></span> Â·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>
<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>[Go] Worker Poolê³¼ ë¹„ë™ê¸° ì‘ì—…ì˜ ì„±ëŠ¥ í”„ë¡œíŒŒì¼ë§ | Ding's Coding Forge</title>
<meta name=keywords content="go,async,sync,pprof"><meta name=description content="This post explores profiling and optimizing worker pools vs. asynchronous execution in Go using pprof. It analyzes the performance impact of concurrent HTTP requests, comparing sync worker pools (10 vs. 100 workers) and a single async worker in terms of throughput, CPU overhead, and memory allocation. Profiling results reveal that worker pools suffer from high concurrency overhead, while asynchronous execution significantly improves throughput with minimal memory cost. Additionally, the post discusses when to use worker pools vs. async processing, highlighting key trade-offs for IO-bound vs. CPU-bound tasks."><meta name=author content="dingyu"><link rel=canonical href=https://dingyu.dev/posts/worker-pool-async/><meta name=google-site-verification content="8XY1hI6NVxQIrN7bQbnX-9TG9HHFw5HOQmlb6vcsFdQ"><meta name=yandex-verification content="XYZabc"><meta name=msvalidate.01 content="XYZabc"><link crossorigin=anonymous href=/assets/css/stylesheet.e27650c63b614184e0a53cd99f9c1786874e85906dabc733988929727960aa8d.css integrity="sha256-4nZQxjthQYTgpTzZn5wXhodOhZBtq8czmIkpcnlgqo0=" rel="preload stylesheet" as=style><link rel=icon href=https://dingyu.dev/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://dingyu.dev/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://dingyu.dev/favicon-32x32.png><link rel=apple-touch-icon href=https://dingyu.dev/apple-touch-icon.png><link rel=mask-icon href=https://dingyu.dev/%3Clink%20/%20abs%20url%3E><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://dingyu.dev/posts/worker-pool-async/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:url" content="https://dingyu.dev/posts/worker-pool-async/"><meta property="og:site_name" content="Ding's Coding Forge"><meta property="og:title" content="[Go] Worker Poolê³¼ ë¹„ë™ê¸° ì‘ì—…ì˜ ì„±ëŠ¥ í”„ë¡œíŒŒì¼ë§"><meta property="og:description" content="This post explores profiling and optimizing worker pools vs. asynchronous execution in Go using pprof. It analyzes the performance impact of concurrent HTTP requests, comparing sync worker pools (10 vs. 100 workers) and a single async worker in terms of throughput, CPU overhead, and memory allocation. Profiling results reveal that worker pools suffer from high concurrency overhead, while asynchronous execution significantly improves throughput with minimal memory cost. Additionally, the post discusses when to use worker pools vs. async processing, highlighting key trade-offs for IO-bound vs. CPU-bound tasks."><meta property="og:locale" content="en-us"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-10-27T00:00:00+00:00"><meta property="article:modified_time" content="2024-10-27T00:00:00+00:00"><meta property="article:tag" content="Go"><meta property="article:tag" content="Async"><meta property="article:tag" content="Sync"><meta property="article:tag" content="Pprof"><meta property="og:image" content="https://dingyu.dev/posts/worker-pool-async/img/go-thumbnail.png"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://dingyu.dev/posts/worker-pool-async/img/go-thumbnail.png"><meta name=twitter:title content="[Go] Worker Poolê³¼ ë¹„ë™ê¸° ì‘ì—…ì˜ ì„±ëŠ¥ í”„ë¡œíŒŒì¼ë§"><meta name=twitter:description content="This post explores profiling and optimizing worker pools vs. asynchronous execution in Go using pprof. It analyzes the performance impact of concurrent HTTP requests, comparing sync worker pools (10 vs. 100 workers) and a single async worker in terms of throughput, CPU overhead, and memory allocation. Profiling results reveal that worker pools suffer from high concurrency overhead, while asynchronous execution significantly improves throughput with minimal memory cost. Additionally, the post discusses when to use worker pools vs. async processing, highlighting key trade-offs for IO-bound vs. CPU-bound tasks."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://dingyu.dev/posts/"},{"@type":"ListItem","position":2,"name":"[Go] Worker Poolê³¼ ë¹„ë™ê¸° ì‘ì—…ì˜ ì„±ëŠ¥ í”„ë¡œíŒŒì¼ë§","item":"https://dingyu.dev/posts/worker-pool-async/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"[Go] Worker Poolê³¼ ë¹„ë™ê¸° ì‘ì—…ì˜ ì„±ëŠ¥ í”„ë¡œíŒŒì¼ë§","name":"[Go] Worker Poolê³¼ ë¹„ë™ê¸° ì‘ì—…ì˜ ì„±ëŠ¥ í”„ë¡œíŒŒì¼ë§","description":"This post explores profiling and optimizing worker pools vs. asynchronous execution in Go using pprof. It analyzes the performance impact of concurrent HTTP requests, comparing sync worker pools (10 vs. 100 workers) and a single async worker in terms of throughput, CPU overhead, and memory allocation. Profiling results reveal that worker pools suffer from high concurrency overhead, while asynchronous execution significantly improves throughput with minimal memory cost. Additionally, the post discusses when to use worker pools vs. async processing, highlighting key trade-offs for IO-bound vs. CPU-bound tasks.","keywords":["go","async","sync","pprof"],"articleBody":"\npprof ì ìš©ì€ pprofë¡œ GC íŠœë‹í•˜ê¸°ë¥¼ ì°¸ê³  í•´ì£¼ì„¸ìš”\në°°ê²½ ë¹„ì¦ˆë‹ˆìŠ¤ ìš”êµ¬ì‚¬í•­ì— ë”°ë¥¸ ì„œë¹„ìŠ¤ë¥¼ ìˆ˜í–‰í•˜ëŠ” ì„œë¹„ìŠ¤ ì„œë²„ë¥¼ **â€œì„œë¹„ìŠ¤ ì„œë²„â€**ë¼ ì¹­í•©ë‹ˆë‹¤\n[AS-IS] ì„œë¹„ìŠ¤ ì„œë²„ì—ì„œëŠ” ë§¤ë²ˆ ë‹¨ ê±´ì˜ HTTP Requestë¡œ ì„œë²„ë‚´ì—ì„œ ë°œìƒí•œ ì´ë²¤íŠ¸ë¥¼ ë°œí–‰í•˜ê³  ìˆì—ˆìŠµë‹ˆë‹¤ ë¹„ë™ê¸°ë¡œ HTTP ìš”ì²­ì„ ìˆ˜í–‰í•˜ê³ ëŠ” ìˆì—ˆì§€ë§Œ, HTTP ìš”ì²­ ìˆ˜ì— ë¹„ë¡€í•˜ì—¬ Batch Loader ì‘ë‹µì§€ì—° ì‹œê°„ì´ ë¦¬ë‹ˆì–´í•˜ê²Œ ì¦ê°€í•˜ê³  ìˆì—ˆìŠµë‹ˆë‹¤. ë¬¸ì œ ê³¼ë„í•œ ë„¤íŠ¸ì›Œí¬ ìš”ì²­ : ì´ë²¤íŠ¸ê°€ ë°œìƒí•  ë•Œë§ˆë‹¤ HTTP ìš”ì²­ì„ ë³´ë‚´ë¯€ë¡œ, ì´ë²¤íŠ¸ ë°œìƒ ë¹ˆë„ê°€ ë†’ì•„ì§ˆìˆ˜ë¡ ë„¤íŠ¸ì›Œí¬ íŠ¸ë˜í”½ì´ ê³¼ë„í•˜ê²Œ ì¦ê°€ ë ˆì´í„´ì‹œ ì¦ê°€ : ìš”ì²­ì´ ë§ì•„ì§€ë©´ íì‰ì´ ë°œìƒí•˜ì—¬ ì‘ë‹µ ì‹œê°„ ì§€ì—° í™•ì¥ì„± ë¶€ì¬ : ë‹¤ìˆ˜ì˜ ì„œë¹„ìŠ¤ì—ì„œ ì œê°ê°ì˜ êµ¬í˜„ ë°©ì‹ìœ¼ë¡œ Batch Loaderì— ì ì¬ì¤‘. HTTP ìš”ì²­ì´ ì•„ë‹Œ ì´ë²¤íŠ¸ ìŠ¤íŠ¸ë¦¬ë° ê¸°ë°˜ìœ¼ë¡œ í™•ì¥í•˜ì˜€ì„ ë•Œ, ë¶ˆí•„ìš”í•˜ê²Œ ë°˜ë³µì ì¸ ìˆ˜ì • ì‘ì—…ì„ ë‹¤ìˆ˜ì˜ ì„œë²„ì—ì„œ ì§„í–‰í•˜ê²Œ ë¨ [TO-BE] ë¬¸ì œ í•´ê²° ê³¼ë„í•œ ë„¤íŠ¸ì›Œí¬ ìš”ì²­ í•´ê²° : ì„œë¹„ìŠ¤ ì„œë²„ ë‚´ì—ì„œ ì´ë²¤íŠ¸ì— ëŒ€í•œ íë¥¼ ë‘ì–´, ìµœëŒ€ ë²„í¼ limitì„ ì´ˆê³¼ í•˜ê±°ë‚˜ Batch ì£¼ê¸°ì— ë„ë‹¬í•˜ëŠ” ê²½ìš°, bufferë¥¼ Batch Loaderë¡œ ì´ë²¤íŠ¸ ë°œí–‰. ì˜¤ë²„í—¤ë“œì¸ HTTP Request ë¥¼ ìµœì†Œí™” ë ˆì´í„´ì‹œ ì¦ê°€ í•´ê²° : ì„œë²„ì—ì„œ ì§€ì •í•´ë‘” Interval Durationì— ë”°ë¼ bufferë¥¼ ëª¨ì•„ ìš”ì²­í•˜ê¸°ì— íì‰ìœ¼ë¡œ ì¸í•œ ë ˆì´í„´ì‹œ ì¦ê°€ëŠ” í•´ê²°ë¨. í™•ì¥ì„± ì¦ê°€ : ì„œë¹„ìŠ¤ ì„œë²„ì—ì„œ ì‚¬ìš©í•  ê³µí†µ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ Repositoryë¡œ êµ¬ì¶•í•˜ì—¬, Batch Loader ì„œë²„ì˜ ë³€ê²½ ë˜ëŠ” í™•ì¥ì— ë”°ë¥¸ ì„œë¹„ìŠ¤ ì„œë²„ë“¤ì˜ ë°˜ë³µì ì¸ ìˆ˜ì • ì‘ì—…ì„ ìµœì†Œí™”. Batch Loader ì„œë²„ì™€ëŠ” ëŠìŠ¨í•œ ê²°í•©ì„ ê°–ë„ë¡ í•¨ í•´ê²° ë°©ì•ˆ Batch Loader ì„œë²„ì™€ëŠ” ëŠìŠ¨í•œ ê²°í•©ì„ ê°€ì§€ë„ë¡ ê³µí†µ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ êµ¬ì¶•í•˜ëŠ” ì˜ì‚¬ ê²°ì • ì™„ë£Œ ê³µí†µ ë¼ì´ë¸ŒëŸ¬ë¦¬ì—ì„œ ì´ë²¤íŠ¸ ë²„í¼ë¥¼ ëª¨ì•„ ìš”ì²­ì„ í•˜ëŠ” ëª¨ë“ˆì„ **â€œBatch Processorâ€**ë¼ ì¹­í•©ë‹ˆë‹¤.\nìš”êµ¬ì‚¬í•­ IO Bound Taskë¥¼ ìµœì†Œí™” goroutine ìƒëª…ì£¼ê¸°ë¥¼ ì œì–´ ê°€ëŠ¥í•´ì•¼ í•¨ 1ì•ˆ : Worker Pool ë°©ì•ˆ ì—¬ëŸ¬ê°œì˜ workerë“¤ì´ ê°ê°ì˜ Interval Duration ë™ì•ˆ ë‚´ë¶€ì ì¸ ë²„í¼ë¥¼ ì±„ì›Œ ë™ê¸°ì ìœ¼ë¡œ APIë¡œ ìš”ì²­í•˜ëŠ” ë°©ì•ˆ\nPros deep copyê°€ ë°œìƒë˜ì§€ ì•ŠëŠ”ë‹¤ ì„±ëŠ¥ ê°œì„ ì„ ìœ„í•´ Worker Poolì„ íŠœë‹í•  ìˆ˜ ìˆë‹¤ Cons Interval Duration ì£¼ê¸°ë¡œ Worse Case Worker Pool ìˆ˜ ë§Œí¼ HTTP Request ë°œìƒ ì„œë¹„ìŠ¤ ì„œë²„ëŠ” Worker Poolì˜ Magic Numberë¥¼ ì°¾ê¸° ìœ„í•´ í…ŒìŠ¤íŠ¸ë¥¼ ì§„í–‰í•´ì•¼í•¨ 2ì•ˆ : í•˜ë‚˜ì˜ Worker + Async HTTP Request Pros Interval Duration ë™ì•ˆ í•œë²ˆë§Œ HTTP Request ë°œìƒ Worker Pool Magic Numberë¥¼ ì°¾ê¸° ìœ„í•œ í…ŒìŠ¤íŠ¸ê°€ ë¶ˆí•„ìš” Cons deep copyë¡œ ì¸í•œ CPU ë¶€í•˜ ê°€ëŠ¥ì„± (byte array size ë§Œí¼ ìˆœíšŒí•˜ë©´ì„œ ê°’ í• ë‹¹) deep copyë¡œ ì¸í•œ Memory ë¶€í•˜ ê°€ëŠ¥ì„± (byte arrayë¥¼ copyí•˜ë©´ì„œ ì¶”ê°€ì ì¸ í™ í• ë‹¹) GC ë™ì‘ ë°©ì‹ì— ë”°ë¼, ë³µì‚¬ëœ buffer memoryë¡œ ì¸í•œ GC Trigger -\u003e Stop the World ë¡œ ì¸í•œ ì„œë¹„ìŠ¤ ì„œë²„ì˜ ì§€ì—° ê°€ëŠ¥ì„± ê³ ë ¤ ë‘ê°€ì§€ ë¹„êµêµ° ì¤‘, ê³µí†µ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ êµ¬ì„±í•˜ëŠ” ê²ƒì— ìˆì–´ ì‚¬ìš©ì„±ì´ ë³´ì¥ë˜ì–´ì•¼ í•˜ê¸°ì—, 2ì•ˆì´ ì í•©í•œ ë°©ì•ˆì´ë¼ê³  ìƒê°ë˜ì—ˆìŠµë‹ˆë‹¤.\ní•˜ì§€ë§Œ deep copyë¡œ ì¸í•œ CPU / memory ìƒì˜ ì˜¤ë²„í—¤ë“œê°€ ì–´ëŠì •ë„ì´ê³ , ì˜í–¥ë„ê°€ ì—†ì„ì§€ ê²€ì¦ì´ í•„ìš”í–ˆìŠµë‹ˆë‹¤.\ní”„ë¡œíŒŒì¼ë§ í”„ë¡œíŒŒì¼ë§ ëª©í‘œ ë¶„ë‹¹ ì²˜ë¦¬ëŸ‰: 1ë¶„ê°„ 2000 RPS ìš”ì²­ ì²˜ë¦¬ ê°€ëŠ¥ ìˆ˜ ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰: deepCopy()ë¡œ ì¸í•œ ë©”ëª¨ë¦¬ ë¶€í•˜ í™•ì¸ GC ë°œìƒ ì˜¤ë²„í—¤ë“œ: ë©”ëª¨ë¦¬ ë³µì‚¬ ê³¼ì •ì—ì„œì˜ GC í™•ì¸ deep copy ì½”ë“œ\nfunc deepCopy[T any](src []T) []T { if src == nil { return nil } dst := make([]T, len(src)) copy(dst, src) return dst } í…ŒìŠ¤íŠ¸ ë°©ë²• 10, 100ê°œì˜ Worker Pool + Sync IO ë°©ì•ˆê³¼ í•˜ë‚˜ì˜ Worker + Async IO ë°©ì•ˆì˜ í…ŒìŠ¤íŠ¸ë¥¼ ì§„í–‰í•©ë‹ˆë‹¤.\nê° ë¹„êµêµ°ì€ CPU Profileì„ í™œì„±í™”í•˜ì—¬ docker imageë¥¼ ë¹Œë“œí•©ë‹ˆë‹¤.\në¶„ë‹¹ ì²˜ë¦¬ëŸ‰ : 1ë¶„ê°„ 2000 RPSì˜ ìš”ì²­ì„ ëª‡ê°œê¹Œì§€ ì²˜ë¦¬ ê°€ëŠ¥í•œê°€? API í˜¸ì¶œ ì´í›„ í˜¸ì¶œëœ Eventì˜ ê°œìˆ˜ ë¡œê¹… ë©”ëª¨ë¦¬ : deepCopy()ë¡œ ì¸í•œ ë©”ëª¨ë¦¬ ë¶€í•˜ê°€ ì–¼ë§ˆë‚˜ ìƒê¸°ëŠ” ì§€ í™•ì¸ ë©”ëª¨ë¦¬ copy ê³¼ì •ì—ì„œ GC ë°œìƒìœ¼ë¡œ ì¸í•œ ì˜¤ë²„í—¤ë“œ í™•ì¸ heap Profileì„ í†µí•œ ê´€ì¸¡ curl {endpoint}/debug/pprof/heap\\?seconds\\=30 --output {output_path} ì²˜ë¦¬ëœ ê°œìˆ˜ëŠ” ì–´ë–»ê²Œ ì„¸ë‚˜ìš”? API send() ë©”ì„œë“œ ì¤‘ ë¡œê¹…ì„ í†µí•´ í™•ì¸\nfunc (q *BatchProcessor) send(payload []byte, traceIDs []string) { ... response, err := q.client.Do(request) ... q.logger.Info().Int(\"count\", len(traceIDs)).Send() } countë¥¼ íŒŒì‹±í•˜ì—¬ stop ì´ì „ì— ì²˜ë¦¬ëœ ê°œìˆ˜ë¥¼ í™•ì¸ í•©ë‹ˆë‹¤\n[e.g.] logfile ì˜ˆì‹œ\nlog file ( sum = â€¦ + 1020 + 1000 ) ... 2024-10-14T05:11:06Z INF count=1020 2024-10-14T05:11:07Z INF count=1000 2024-10-14T05:11:07Z INF stopping BatchProcessor, waiting for remaining events to be sent func=BatchProcessor.Stop 2024-10-14T05:11:07Z INF count=288 CPU Profile selectgo : select êµ¬ë¬¸ ì¤‘ ì—¬ëŸ¬ ì±„ë„ì—ì„œ ë°ì´í„°ë¥¼ ë™ì‹œì— ê¸°ë‹¤ë¦¬ë©´ì„œ ê·¸ ì¤‘ í•˜ë‚˜ê°€ ì¤€ë¹„ë˜ë©´ í•´ë‹¹ ì‘ì—…ì„ ìˆ˜í–‰í•˜ëŠ” ê¸°ëŠ¥\nì±„ë„ 1: queue ì—ì„œ Pop()í•˜ì—¬ stack bufferì— ì ì¬, buffer maxlimitì„ ì´ˆê³¼í•˜ëŠ” ê²½ìš° API ì „ì†¡ ë° buffer Flush ì±„ë„ 2: time.Ticker ì¼ì • ì‹œê°„ ë§ˆë‹¤ ë‚´ë¶€ ë²„í¼ ìŠ¤íƒìœ¼ë¡œ API ì „ì†¡ ë° Flush ì±„ë„ 3: ì¢…ë£Œ ì‹œê·¸ë„ì„ ë°›ì•„, ë‚¨ì•„ìˆëŠ” ë²„í¼ ìŠ¤íƒì„ API ì „ì†¡ ë° ê³ ë£¨í‹´ ì¢…ë£Œ Worker Pool (100) + Sync IO runWithSync() ë¶„ì„\nê° workerë“¤ì€ ê³µìœ  ìì›ì¸ queue ì±„ë„ì„ ì†Œë¹„í•˜ë©°, ì›Œì»¤ì˜ ìˆ˜ê°€ ë§ì•„ì§ˆ ìˆ˜ë¡ ë‚´ë¶€ì ì¸ lockê³¼ acquireSudog(ì±„ë„ ìˆ˜ì‹  ëŒ€ê¸°)ì— ë“œëŠ” ë¹„ìš©ì´ ë°œìƒ runtime ìŠ¤ì¼€ì¥´ëŸ¬ì— ì˜í•´, ë™ì‹œì„± ì²˜ë¦¬ì— ë“œëŠ” ë¹„ìš©ì´ ì˜ˆìƒì™¸ì˜ ì˜¤ë²„í—¤ë“œ selectgo ì¤‘, ì˜¤ë²„í—¤ë“œì¸ sellockê³¼ acquireSudogì˜ ë¹„ìœ¨ì€ 85% Worker Pool (10) + Sync IO runWithSync() ë¶„ì„\nsellock ë¹„ìœ¨ì´ 100 worker poolì— ë¹„í•´ í˜„ì €íˆ ê°ì†Œí•˜ëŠ” ê²ƒì„ í™•ì¸ selectgo ì¤‘, ì˜¤ë²„í—¤ë“œì¸ sellockê³¼ acquireSudogì˜ ë¹„ìœ¨ì€ 66% í•˜ë‚˜ì˜ Worker + Async IO run() ë¶„ì„\ndeepCopy(ê·¸ë¦¼ ì¤‘ runtime.memmove)ë¡œ ì¸í•œ ì˜¤ë²„í—¤ë“œëŠ” 10ms selectgo ì¤‘, ì˜¤ë²„í—¤ë“œì¸ runtime.recv (ì™¸ë¶€ API í˜¸ì¶œ ì‹œ, goroutine ì¤€ë¹„ ì‘ì—…)+ deep copyì˜ ë¹„ìœ¨ì€ 50% Heap Profile run() / runWithSync() í•¨ìˆ˜ê°€ ì‹¤í–‰ë˜ëŠ” ë™ì•ˆ ìˆ˜í–‰ë˜ëŠ” DeepCopyì— ì´ˆì ì„ ë§ì¶”ì–´ í”„ë¡œíŒŒì¼ë§\nWorker Pool deepCopy() ë¡œ ì¸í•œ ì˜¤ë²„í—¤ë“œ ì—†ìŒ\n100 workers ì¤‘ 8.2MB ì¤‘ HTTP Requestê°€ 7.7MB ì†Œëª¨ í•˜ë‚˜ì˜ Worker + Async IO ì´ 12.21MBì˜ run ê³¼ì • ì¤‘ ë‚´ë¶€ ë²„í¼ë¥¼ ì“°ëŠ” ì‘ì—…ì¸ Writeë¥¼ ì œì™¸í•œ ì˜¤ë²„í—¤ë“œë¥¼ ì‚°ì •\nworker run / Request ë¹„ìœ¨ 100 worker pool ì¤‘, 8.2MB:7.7MB 12.21MB ì¸ ê²½ìš° 11.4MBê°€ HTTP Requestì— ì‚¬ìš© deepCopyì— ë“œëŠ” ì˜¤ë²„í—¤ë“œëŠ” 150kB (1.22%) ë§¤ìš° ë¯¸ë¯¸í•œ ìˆ˜ì¤€ í…ŒìŠ¤íŠ¸ ê²°ê³¼ ë¶„ë¥˜ ë¶„ë‹¹ ì²˜ë¦¬ëŸ‰ CPU ì˜¤ë²„í—¤ë“œ ë©”ëª¨ë¦¬ ì˜¤ë²„í—¤ë“œ 10 worker 83,663 66% 0% 100 worker 84,042 85% 0% 1 worker + async 119,720 50% 1.22% ì •ë¦¬ Worker Poolì„ ì‚¬ìš©í•  ê²½ìš°, Queueì˜ ë™ì‹œì„± ì²˜ë¦¬ë¥¼ ìœ„í•´ ì‚¬ìš©ë˜ëŠ” ì˜¤ë²„í—¤ë“œê°€ ìƒë‹¹í•˜ë‹¤ Worker Numberë¥¼ ëŠ˜ë¦¬ë”ë¼ë„ ë™ì‹œì„± ì²˜ë¦¬ ì˜¤ë²„í—¤ë“œê°€ ìƒìŠ¹ë˜ê¸°ì— number of worker ì™€ ì²˜ë¦¬ëŸ‰ì€ ë¦¬ë‹ˆì–´í•˜ê²Œ ìƒìŠ¹í•˜ì§„ ì•ŠëŠ”ë‹¤ IO Bound Taskë¥¼ ìˆ˜í–‰í•  ê²½ìš°, Worker Pool ë³´ë‹¤ëŠ” ë¹„ë™ê¸°ë¡œ ì²˜ë¦¬í•˜ëŠ” ê²ƒì´ ì„±ëŠ¥ìƒì˜ ì´ì ì´ í¬ë‹¤ CPU Bound Taskì˜ ê²½ìš°, runtimeì— ì˜í•´ goroutine ì´ ìˆ˜í–‰ë˜ê¸° ê¹Œì§€ ëŒ€ê¸° ì‹œê°„ì´ ê±¸ë¦¬ê¸°ì— worker poolì„ ì‚¬ìš©í•˜ëŠ” ê²ƒì´ ì¢‹ë‹¤ ìˆœì„œê°€ ë³´ì¥ë˜ì–´ì•¼ í•˜ëŠ” ê²½ìš°ì—ëŠ” IO Bound Task ì¼ì§€ë¼ë„ Worker Poolì„ ì‚¬ìš©í•˜ëŠ” ê²ƒì´ ì¢‹ë‹¤ ","wordCount":"896","inLanguage":"en","image":"https://dingyu.dev/posts/worker-pool-async/img/go-thumbnail.png","datePublished":"2024-10-27T00:00:00Z","dateModified":"2024-10-27T00:00:00Z","author":{"@type":"Person","name":"dingyu"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://dingyu.dev/posts/worker-pool-async/"},"publisher":{"@type":"Organization","name":"Ding's Coding Forge","logo":{"@type":"ImageObject","url":"https://dingyu.dev/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://dingyu.dev/ accesskey=h title="Ding's Coding Forge (Alt + H)"><img src=https://dingyu.dev/apple-touch-icon.png alt aria-label=logo height=35>Ding's Coding Forge</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://dingyu.dev/about/ title=About><span>About</span></a></li><li><a href=https://dingyu.dev/categories/ title=Categories><span>Categories</span></a></li><li><a href=https://dingyu.dev/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://dingyu.dev/archives/ title=Archives><span>Archives</span></a></li><li><a href=https://dingyu.dev/search/ title="ğŸ” (Alt + /)" accesskey=/><span>ğŸ”</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://dingyu.dev/>Home</a>&nbsp;Â»&nbsp;<a href=https://dingyu.dev/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">[Go] Worker Poolê³¼ ë¹„ë™ê¸° ì‘ì—…ì˜ ì„±ëŠ¥ í”„ë¡œíŒŒì¼ë§</h1><div class=post-description>This post explores profiling and optimizing worker pools vs. asynchronous execution in Go using pprof. It analyzes the performance impact of concurrent HTTP requests, comparing sync worker pools (10 vs. 100 workers) and a single async worker in terms of throughput, CPU overhead, and memory allocation. Profiling results reveal that worker pools suffer from high concurrency overhead, while asynchronous execution significantly improves throughput with minimal memory cost. Additionally, the post discusses when to use worker pools vs. async processing, highlighting key trade-offs for IO-bound vs. CPU-bound tasks.</div><div class=post-meta><span title='2024-10-27 00:00:00 +0000 UTC'>October 27, 2024</span>&nbsp;Â·&nbsp;5 min&nbsp;Â·&nbsp;896 words&nbsp;Â·&nbsp;dingyu&nbsp;|&nbsp;<a href=https://github.com/dings-things/blog/tree/main/content/posts/worker-pool-async/index.md rel="noopener noreferrer" target=_blank>Suggest Changes</a></div></header><figure class=entry-cover><img loading=eager src=https://dingyu.dev/img/go-thumbnail.png alt></figure><aside id=toc-container class="toc-container wide"><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#%eb%b0%b0%ea%b2%bd aria-label=ë°°ê²½>ë°°ê²½</a><ul><li><a href=#as-is aria-label=[AS-IS]>[AS-IS]</a><ul><li><a href=#%eb%ac%b8%ec%a0%9c aria-label=ë¬¸ì œ>ë¬¸ì œ</a></li></ul></li><li><a href=#to-be aria-label=[TO-BE]>[TO-BE]</a><ul><li><a href=#%eb%ac%b8%ec%a0%9c-%ed%95%b4%ea%b2%b0 aria-label="ë¬¸ì œ í•´ê²°">ë¬¸ì œ í•´ê²°</a></li></ul></li></ul></li><li><a href=#%ed%95%b4%ea%b2%b0-%eb%b0%a9%ec%95%88 aria-label="í•´ê²° ë°©ì•ˆ">í•´ê²° ë°©ì•ˆ</a><ul><ul><li><a href=#%ec%9a%94%ea%b5%ac%ec%82%ac%ed%95%ad aria-label=ìš”êµ¬ì‚¬í•­>ìš”êµ¬ì‚¬í•­</a></li><li><a href=#1%ec%95%88--worker-pool-%eb%b0%a9%ec%95%88 aria-label="1ì•ˆ : Worker Pool ë°©ì•ˆ">1ì•ˆ : Worker Pool ë°©ì•ˆ</a><ul><li><a href=#pros aria-label=Pros>Pros</a></li><li><a href=#cons aria-label=Cons>Cons</a></li></ul></li><li><a href=#2%ec%95%88--%ed%95%98%eb%82%98%ec%9d%98-worker--async-http-request aria-label="2ì•ˆ : í•˜ë‚˜ì˜ Worker + Async HTTP Request">2ì•ˆ : í•˜ë‚˜ì˜ Worker + Async HTTP Request</a><ul><li><a href=#pros-1 aria-label=Pros>Pros</a></li><li><a href=#cons-1 aria-label=Cons>Cons</a></li></ul></li></ul></ul></li><li><a href=#%ed%94%84%eb%a1%9c%ed%8c%8c%ec%9d%bc%eb%a7%81 aria-label=í”„ë¡œíŒŒì¼ë§>í”„ë¡œíŒŒì¼ë§</a><ul><li><a href=#%ed%94%84%eb%a1%9c%ed%8c%8c%ec%9d%bc%eb%a7%81-%eb%aa%a9%ed%91%9c aria-label="í”„ë¡œíŒŒì¼ë§ ëª©í‘œ">í”„ë¡œíŒŒì¼ë§ ëª©í‘œ</a></li><li><a href=#%ed%85%8c%ec%8a%a4%ed%8a%b8-%eb%b0%a9%eb%b2%95 aria-label="í…ŒìŠ¤íŠ¸ ë°©ë²•">í…ŒìŠ¤íŠ¸ ë°©ë²•</a><ul><ul><li><a href=#%ec%b2%98%eb%a6%ac%eb%90%9c-%ea%b0%9c%ec%88%98%eb%8a%94-%ec%96%b4%eb%96%bb%ea%b2%8c-%ec%84%b8%eb%82%98%ec%9a%94 aria-label="ì²˜ë¦¬ëœ ê°œìˆ˜ëŠ” ì–´ë–»ê²Œ ì„¸ë‚˜ìš”?">ì²˜ë¦¬ëœ ê°œìˆ˜ëŠ” ì–´ë–»ê²Œ ì„¸ë‚˜ìš”?</a></li></ul></ul></li><li><a href=#cpu-profile aria-label="CPU Profile">CPU Profile</a><ul><ul><li><a href=#worker-pool-100--sync-io aria-label="Worker Pool (100) + Sync IO">Worker Pool (100) + Sync IO</a></li><li><a href=#worker-pool-10--sync-io aria-label="Worker Pool (10) + Sync IO">Worker Pool (10) + Sync IO</a></li><li><a href=#%ed%95%98%eb%82%98%ec%9d%98-worker--async-io aria-label="í•˜ë‚˜ì˜ Worker + Async IO">í•˜ë‚˜ì˜ Worker + Async IO</a></li></ul></ul></li><li><a href=#heap-profile aria-label="Heap Profile">Heap Profile</a><ul><ul><li><a href=#worker-pool aria-label="Worker Pool">Worker Pool</a></li><li><a href=#%ed%95%98%eb%82%98%ec%9d%98-worker--async-io-1 aria-label="í•˜ë‚˜ì˜ Worker + Async IO">í•˜ë‚˜ì˜ Worker + Async IO</a></li></ul></ul></li></ul></li><li><a href=#%ed%85%8c%ec%8a%a4%ed%8a%b8-%ea%b2%b0%ea%b3%bc aria-label="í…ŒìŠ¤íŠ¸ ê²°ê³¼">í…ŒìŠ¤íŠ¸ ê²°ê³¼</a><ul><li><a href=#%ec%a0%95%eb%a6%ac aria-label=ì •ë¦¬>ì •ë¦¬</a></li></ul></li></ul></div></details></div></aside><script>let activeElement,elements;window.addEventListener("DOMContentLoaded",function(){checkTocPosition(),elements=document.querySelectorAll("h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]"),activeElement=elements[0];const t=encodeURI(activeElement.getAttribute("id")).toLowerCase();document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active")},!1),window.addEventListener("resize",function(){checkTocPosition()},!1),window.addEventListener("scroll",()=>{activeElement=Array.from(elements).find(e=>{if(getOffsetTop(e)-window.pageYOffset>0&&getOffsetTop(e)-window.pageYOffset<window.innerHeight/2)return e})||activeElement,elements.forEach(e=>{const t=encodeURI(e.getAttribute("id")).toLowerCase();e===activeElement?document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active"):document.querySelector(`.inner ul li a[href="#${t}"]`).classList.remove("active")})},!1);const main=parseInt(getComputedStyle(document.body).getPropertyValue("--article-width"),10),toc=parseInt(getComputedStyle(document.body).getPropertyValue("--toc-width"),10),gap=parseInt(getComputedStyle(document.body).getPropertyValue("--gap"),10);function checkTocPosition(){const e=document.body.scrollWidth;e-main-toc*2-gap*4>0?document.getElementById("toc-container").classList.add("wide"):document.getElementById("toc-container").classList.remove("wide")}function getOffsetTop(e){if(!e.getClientRects().length)return 0;let t=e.getBoundingClientRect(),n=e.ownerDocument.defaultView;return t.top+n.pageYOffset}</script><div class=post-content><p><img loading=lazy src=/posts/worker-pool-async/image.png></p><blockquote><p><strong>pprof ì ìš©</strong>ì€
<a href=https://velog.io/@wjddn3711/pprof%EB%A1%9C-GC-%ED%8A%9C%EB%8B%9D%ED%95%98%EA%B8%B0>pprofë¡œ GC íŠœë‹í•˜ê¸°</a>ë¥¼ ì°¸ê³  í•´ì£¼ì„¸ìš”</p></blockquote><h1 id=ë°°ê²½>ë°°ê²½<a hidden class=anchor aria-hidden=true href=#ë°°ê²½>#</a></h1><hr><blockquote><p>ë¹„ì¦ˆë‹ˆìŠ¤ ìš”êµ¬ì‚¬í•­ì— ë”°ë¥¸ ì„œë¹„ìŠ¤ë¥¼ ìˆ˜í–‰í•˜ëŠ” ì„œë¹„ìŠ¤ ì„œë²„ë¥¼ **&ldquo;ì„œë¹„ìŠ¤ ì„œë²„&rdquo;**ë¼ ì¹­í•©ë‹ˆë‹¤</p></blockquote><h2 id=as-is>[AS-IS]<a hidden class=anchor aria-hidden=true href=#as-is>#</a></h2><p>ì„œë¹„ìŠ¤ ì„œë²„ì—ì„œëŠ” ë§¤ë²ˆ ë‹¨ ê±´ì˜ HTTP Requestë¡œ ì„œë²„ë‚´ì—ì„œ ë°œìƒí•œ ì´ë²¤íŠ¸ë¥¼ ë°œí–‰í•˜ê³  ìˆì—ˆìŠµë‹ˆë‹¤
ë¹„ë™ê¸°ë¡œ HTTP ìš”ì²­ì„ ìˆ˜í–‰í•˜ê³ ëŠ” ìˆì—ˆì§€ë§Œ, HTTP ìš”ì²­ ìˆ˜ì— ë¹„ë¡€í•˜ì—¬ Batch Loader ì‘ë‹µì§€ì—° ì‹œê°„ì´ ë¦¬ë‹ˆì–´í•˜ê²Œ ì¦ê°€í•˜ê³  ìˆì—ˆìŠµë‹ˆë‹¤.
<img loading=lazy src=/posts/worker-pool-async/image-1.png></p><h3 id=ë¬¸ì œ>ë¬¸ì œ<a hidden class=anchor aria-hidden=true href=#ë¬¸ì œ>#</a></h3><ol><li><strong>ê³¼ë„í•œ ë„¤íŠ¸ì›Œí¬ ìš”ì²­</strong> : ì´ë²¤íŠ¸ê°€ ë°œìƒí•  ë•Œë§ˆë‹¤ HTTP ìš”ì²­ì„ ë³´ë‚´ë¯€ë¡œ, ì´ë²¤íŠ¸ ë°œìƒ ë¹ˆë„ê°€ ë†’ì•„ì§ˆìˆ˜ë¡ ë„¤íŠ¸ì›Œí¬ íŠ¸ë˜í”½ì´ ê³¼ë„í•˜ê²Œ ì¦ê°€</li><li><strong>ë ˆì´í„´ì‹œ ì¦ê°€</strong> : ìš”ì²­ì´ ë§ì•„ì§€ë©´ íì‰ì´ ë°œìƒí•˜ì—¬ ì‘ë‹µ ì‹œê°„ ì§€ì—°</li><li><strong>í™•ì¥ì„± ë¶€ì¬</strong> : ë‹¤ìˆ˜ì˜ ì„œë¹„ìŠ¤ì—ì„œ ì œê°ê°ì˜ êµ¬í˜„ ë°©ì‹ìœ¼ë¡œ Batch Loaderì— ì ì¬ì¤‘. HTTP ìš”ì²­ì´ ì•„ë‹Œ ì´ë²¤íŠ¸ ìŠ¤íŠ¸ë¦¬ë° ê¸°ë°˜ìœ¼ë¡œ í™•ì¥í•˜ì˜€ì„ ë•Œ, ë¶ˆí•„ìš”í•˜ê²Œ ë°˜ë³µì ì¸ ìˆ˜ì • ì‘ì—…ì„ ë‹¤ìˆ˜ì˜ ì„œë²„ì—ì„œ ì§„í–‰í•˜ê²Œ ë¨</li></ol><h2 id=to-be>[TO-BE]<a hidden class=anchor aria-hidden=true href=#to-be>#</a></h2><p><img loading=lazy src=/posts/worker-pool-async/image-2.png></p><h3 id=ë¬¸ì œ-í•´ê²°>ë¬¸ì œ í•´ê²°<a hidden class=anchor aria-hidden=true href=#ë¬¸ì œ-í•´ê²°>#</a></h3><ol><li><strong>ê³¼ë„í•œ ë„¤íŠ¸ì›Œí¬ ìš”ì²­ í•´ê²°</strong> : ì„œë¹„ìŠ¤ ì„œë²„ ë‚´ì—ì„œ ì´ë²¤íŠ¸ì— ëŒ€í•œ íë¥¼ ë‘ì–´, ìµœëŒ€ ë²„í¼ limitì„ ì´ˆê³¼ í•˜ê±°ë‚˜ Batch ì£¼ê¸°ì— ë„ë‹¬í•˜ëŠ” ê²½ìš°, bufferë¥¼ Batch Loaderë¡œ ì´ë²¤íŠ¸ ë°œí–‰.<ul><li>ì˜¤ë²„í—¤ë“œì¸ HTTP Request ë¥¼ ìµœì†Œí™”</li></ul></li><li><strong>ë ˆì´í„´ì‹œ ì¦ê°€ í•´ê²°</strong> : ì„œë²„ì—ì„œ ì§€ì •í•´ë‘” <code>Interval Duration</code>ì— ë”°ë¼ bufferë¥¼ ëª¨ì•„ ìš”ì²­í•˜ê¸°ì— íì‰ìœ¼ë¡œ ì¸í•œ ë ˆì´í„´ì‹œ ì¦ê°€ëŠ” í•´ê²°ë¨.</li><li><strong>í™•ì¥ì„± ì¦ê°€</strong> : ì„œë¹„ìŠ¤ ì„œë²„ì—ì„œ ì‚¬ìš©í•  ê³µí†µ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ Repositoryë¡œ êµ¬ì¶•í•˜ì—¬, Batch Loader ì„œë²„ì˜ ë³€ê²½ ë˜ëŠ” í™•ì¥ì— ë”°ë¥¸ ì„œë¹„ìŠ¤ ì„œë²„ë“¤ì˜ ë°˜ë³µì ì¸ ìˆ˜ì • ì‘ì—…ì„ ìµœì†Œí™”. Batch Loader ì„œë²„ì™€ëŠ” <strong>ëŠìŠ¨í•œ ê²°í•©</strong>ì„ ê°–ë„ë¡ í•¨</li></ol><h1 id=í•´ê²°-ë°©ì•ˆ>í•´ê²° ë°©ì•ˆ<a hidden class=anchor aria-hidden=true href=#í•´ê²°-ë°©ì•ˆ>#</a></h1><hr><blockquote><p>Batch Loader ì„œë²„ì™€ëŠ” ëŠìŠ¨í•œ ê²°í•©ì„ ê°€ì§€ë„ë¡ ê³µí†µ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ êµ¬ì¶•í•˜ëŠ” ì˜ì‚¬ ê²°ì • ì™„ë£Œ
ê³µí†µ ë¼ì´ë¸ŒëŸ¬ë¦¬ì—ì„œ ì´ë²¤íŠ¸ ë²„í¼ë¥¼ ëª¨ì•„ ìš”ì²­ì„ í•˜ëŠ” ëª¨ë“ˆì„ **&ldquo;Batch Processor&rdquo;**ë¼ ì¹­í•©ë‹ˆë‹¤.</p></blockquote><h3 id=ìš”êµ¬ì‚¬í•­>ìš”êµ¬ì‚¬í•­<a hidden class=anchor aria-hidden=true href=#ìš”êµ¬ì‚¬í•­>#</a></h3><ul><li><strong>IO Bound Task</strong>ë¥¼ ìµœì†Œí™”</li><li><code>goroutine</code> ìƒëª…ì£¼ê¸°ë¥¼ ì œì–´ ê°€ëŠ¥í•´ì•¼ í•¨</li></ul><h3 id=1ì•ˆ--worker-pool-ë°©ì•ˆ>1ì•ˆ : Worker Pool ë°©ì•ˆ<a hidden class=anchor aria-hidden=true href=#1ì•ˆ--worker-pool-ë°©ì•ˆ>#</a></h3><p><img loading=lazy src=/posts/worker-pool-async/image-3.png></p><p>ì—¬ëŸ¬ê°œì˜ workerë“¤ì´ ê°ê°ì˜ <code>Interval Duration</code> ë™ì•ˆ ë‚´ë¶€ì ì¸ ë²„í¼ë¥¼ ì±„ì›Œ ë™ê¸°ì ìœ¼ë¡œ APIë¡œ ìš”ì²­í•˜ëŠ” ë°©ì•ˆ</p><h4 id=pros>Pros<a hidden class=anchor aria-hidden=true href=#pros>#</a></h4><ul><li>deep copyê°€ ë°œìƒë˜ì§€ ì•ŠëŠ”ë‹¤</li><li>ì„±ëŠ¥ ê°œì„ ì„ ìœ„í•´ Worker Poolì„ íŠœë‹í•  ìˆ˜ ìˆë‹¤</li></ul><h4 id=cons>Cons<a hidden class=anchor aria-hidden=true href=#cons>#</a></h4><ul><li><code>Interval Duration</code> ì£¼ê¸°ë¡œ Worse Case Worker Pool ìˆ˜ ë§Œí¼ HTTP Request ë°œìƒ</li><li>ì„œë¹„ìŠ¤ ì„œë²„ëŠ” Worker Poolì˜ Magic Numberë¥¼ ì°¾ê¸° ìœ„í•´ í…ŒìŠ¤íŠ¸ë¥¼ ì§„í–‰í•´ì•¼í•¨</li></ul><h3 id=2ì•ˆ--í•˜ë‚˜ì˜-worker--async-http-request>2ì•ˆ : í•˜ë‚˜ì˜ Worker + Async HTTP Request<a hidden class=anchor aria-hidden=true href=#2ì•ˆ--í•˜ë‚˜ì˜-worker--async-http-request>#</a></h3><p><img loading=lazy src=/posts/worker-pool-async/image-4.png></p><h4 id=pros-1>Pros<a hidden class=anchor aria-hidden=true href=#pros-1>#</a></h4><ul><li>Interval Duration ë™ì•ˆ í•œë²ˆë§Œ HTTP Request ë°œìƒ</li><li>Worker Pool Magic Numberë¥¼ ì°¾ê¸° ìœ„í•œ í…ŒìŠ¤íŠ¸ê°€ ë¶ˆí•„ìš”</li></ul><h4 id=cons-1>Cons<a hidden class=anchor aria-hidden=true href=#cons-1>#</a></h4><ul><li>deep copyë¡œ ì¸í•œ CPU ë¶€í•˜ ê°€ëŠ¥ì„± (byte array size ë§Œí¼ ìˆœíšŒí•˜ë©´ì„œ ê°’ í• ë‹¹)</li><li>deep copyë¡œ ì¸í•œ Memory ë¶€í•˜ ê°€ëŠ¥ì„± (byte arrayë¥¼ copyí•˜ë©´ì„œ ì¶”ê°€ì ì¸ í™ í• ë‹¹)<ul><li>GC ë™ì‘ ë°©ì‹ì— ë”°ë¼, ë³µì‚¬ëœ buffer memoryë¡œ ì¸í•œ GC Trigger -> <code>Stop the World</code> ë¡œ ì¸í•œ ì„œë¹„ìŠ¤ ì„œë²„ì˜ ì§€ì—° ê°€ëŠ¥ì„± ê³ ë ¤</li></ul></li></ul><p>ë‘ê°€ì§€ ë¹„êµêµ° ì¤‘, ê³µí†µ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ êµ¬ì„±í•˜ëŠ” ê²ƒì— ìˆì–´ <strong>ì‚¬ìš©ì„±</strong>ì´ ë³´ì¥ë˜ì–´ì•¼ í•˜ê¸°ì—, 2ì•ˆì´ ì í•©í•œ ë°©ì•ˆì´ë¼ê³  ìƒê°ë˜ì—ˆìŠµë‹ˆë‹¤.</p><p>í•˜ì§€ë§Œ <code>deep copy</code>ë¡œ ì¸í•œ CPU / memory ìƒì˜ ì˜¤ë²„í—¤ë“œê°€ ì–´ëŠì •ë„ì´ê³ , ì˜í–¥ë„ê°€ ì—†ì„ì§€ ê²€ì¦ì´ í•„ìš”í–ˆìŠµë‹ˆë‹¤.</p><h1 id=í”„ë¡œíŒŒì¼ë§>í”„ë¡œíŒŒì¼ë§<a hidden class=anchor aria-hidden=true href=#í”„ë¡œíŒŒì¼ë§>#</a></h1><hr><h2 id=í”„ë¡œíŒŒì¼ë§-ëª©í‘œ>í”„ë¡œíŒŒì¼ë§ ëª©í‘œ<a hidden class=anchor aria-hidden=true href=#í”„ë¡œíŒŒì¼ë§-ëª©í‘œ>#</a></h2><hr><ul><li><strong>ë¶„ë‹¹ ì²˜ë¦¬ëŸ‰</strong>: 1ë¶„ê°„ 2000 RPS ìš”ì²­ ì²˜ë¦¬ ê°€ëŠ¥ ìˆ˜</li><li><strong>ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰</strong>: <code>deepCopy()</code>ë¡œ ì¸í•œ ë©”ëª¨ë¦¬ ë¶€í•˜ í™•ì¸</li><li><strong>GC ë°œìƒ ì˜¤ë²„í—¤ë“œ</strong>: ë©”ëª¨ë¦¬ ë³µì‚¬ ê³¼ì •ì—ì„œì˜ GC í™•ì¸</li></ul><blockquote><p><strong>deep copy ì½”ë“œ</strong></p></blockquote><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nx>deepCopy</span><span class=p>[</span><span class=nx>T</span> <span class=kt>any</span><span class=p>](</span><span class=nx>src</span> <span class=p>[]</span><span class=nx>T</span><span class=p>)</span> <span class=p>[]</span><span class=nx>T</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>src</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nx>dst</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>([]</span><span class=nx>T</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=nx>src</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=nb>copy</span><span class=p>(</span><span class=nx>dst</span><span class=p>,</span> <span class=nx>src</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>dst</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h2 id=í…ŒìŠ¤íŠ¸-ë°©ë²•>í…ŒìŠ¤íŠ¸ ë°©ë²•<a hidden class=anchor aria-hidden=true href=#í…ŒìŠ¤íŠ¸-ë°©ë²•>#</a></h2><hr><p><strong>10, 100ê°œì˜ Worker Pool + Sync IO ë°©ì•ˆ</strong>ê³¼ <strong>í•˜ë‚˜ì˜ Worker + Async IO ë°©ì•ˆ</strong>ì˜ í…ŒìŠ¤íŠ¸ë¥¼ ì§„í–‰í•©ë‹ˆë‹¤.</p><p>ê° ë¹„êµêµ°ì€ CPU Profileì„ í™œì„±í™”í•˜ì—¬ docker imageë¥¼ ë¹Œë“œí•©ë‹ˆë‹¤.</p><ul><li><strong>ë¶„ë‹¹ ì²˜ë¦¬ëŸ‰</strong> : 1ë¶„ê°„ 2000 RPSì˜ ìš”ì²­ì„ ëª‡ê°œê¹Œì§€ ì²˜ë¦¬ ê°€ëŠ¥í•œê°€?<ul><li>API í˜¸ì¶œ ì´í›„ í˜¸ì¶œëœ Eventì˜ ê°œìˆ˜ ë¡œê¹…</li></ul></li><li><strong>ë©”ëª¨ë¦¬</strong> : deepCopy()ë¡œ ì¸í•œ ë©”ëª¨ë¦¬ ë¶€í•˜ê°€ ì–¼ë§ˆë‚˜ ìƒê¸°ëŠ” ì§€ í™•ì¸<ul><li>ë©”ëª¨ë¦¬ copy ê³¼ì •ì—ì„œ GC ë°œìƒìœ¼ë¡œ ì¸í•œ ì˜¤ë²„í—¤ë“œ í™•ì¸</li><li>heap Profileì„ í†µí•œ ê´€ì¸¡</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>curl <span class=o>{</span>endpoint<span class=o>}</span>/debug/pprof/heap<span class=se>\?</span>seconds<span class=se>\=</span><span class=m>30</span> --output <span class=o>{</span>output_path<span class=o>}</span>
</span></span></code></pre></div></li></ul><blockquote><h4 id=ì²˜ë¦¬ëœ-ê°œìˆ˜ëŠ”-ì–´ë–»ê²Œ-ì„¸ë‚˜ìš”>ì²˜ë¦¬ëœ ê°œìˆ˜ëŠ” ì–´ë–»ê²Œ ì„¸ë‚˜ìš”?<a hidden class=anchor aria-hidden=true href=#ì²˜ë¦¬ëœ-ê°œìˆ˜ëŠ”-ì–´ë–»ê²Œ-ì„¸ë‚˜ìš”>#</a></h4></blockquote><p>API send() ë©”ì„œë“œ ì¤‘ ë¡œê¹…ì„ í†µí•´ í™•ì¸</p><blockquote></blockquote><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>q</span> <span class=o>*</span><span class=nx>BatchProcessor</span><span class=p>)</span> <span class=nf>send</span><span class=p>(</span><span class=nx>payload</span> <span class=p>[]</span><span class=kt>byte</span><span class=p>,</span> <span class=nx>traceIDs</span> <span class=p>[]</span><span class=kt>string</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=nx>response</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>q</span><span class=p>.</span><span class=nx>client</span><span class=p>.</span><span class=nf>Do</span><span class=p>(</span><span class=nx>request</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=nx>q</span><span class=p>.</span><span class=nx>logger</span><span class=p>.</span><span class=nf>Info</span><span class=p>().</span><span class=nf>Int</span><span class=p>(</span><span class=s>&#34;count&#34;</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=nx>traceIDs</span><span class=p>)).</span><span class=nf>Send</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><blockquote><p>countë¥¼ íŒŒì‹±í•˜ì—¬ stop ì´ì „ì— ì²˜ë¦¬ëœ ê°œìˆ˜ë¥¼ í™•ì¸ í•©ë‹ˆë‹¤</p></blockquote><p><strong>[e.g.] logfile ì˜ˆì‹œ</strong></p><ul><li>log file ( sum = &mldr; + 1020 + 1000 )</li></ul><blockquote></blockquote><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>...
</span></span><span class=line><span class=cl>2024-10-14T05:11:06Z INF count=1020
</span></span><span class=line><span class=cl>2024-10-14T05:11:07Z INF count=1000
</span></span><span class=line><span class=cl>2024-10-14T05:11:07Z INF stopping BatchProcessor, waiting for remaining events to be sent func=BatchProcessor.Stop
</span></span><span class=line><span class=cl>2024-10-14T05:11:07Z INF count=288
</span></span></code></pre></div><h2 id=cpu-profile>CPU Profile<a hidden class=anchor aria-hidden=true href=#cpu-profile>#</a></h2><hr><blockquote><p>selectgo : select êµ¬ë¬¸ ì¤‘ ì—¬ëŸ¬ ì±„ë„ì—ì„œ ë°ì´í„°ë¥¼ ë™ì‹œì— ê¸°ë‹¤ë¦¬ë©´ì„œ ê·¸ ì¤‘ í•˜ë‚˜ê°€ ì¤€ë¹„ë˜ë©´ í•´ë‹¹ ì‘ì—…ì„ ìˆ˜í–‰í•˜ëŠ” ê¸°ëŠ¥</p></blockquote><ul><li>ì±„ë„ 1: queue ì—ì„œ Pop()í•˜ì—¬ stack bufferì— ì ì¬, buffer maxlimitì„ ì´ˆê³¼í•˜ëŠ” ê²½ìš° API ì „ì†¡ ë° buffer Flush</li><li>ì±„ë„ 2: <code>time.Ticker</code> ì¼ì • ì‹œê°„ ë§ˆë‹¤ ë‚´ë¶€ ë²„í¼ ìŠ¤íƒìœ¼ë¡œ API ì „ì†¡ ë° Flush</li><li>ì±„ë„ 3: ì¢…ë£Œ ì‹œê·¸ë„ì„ ë°›ì•„, ë‚¨ì•„ìˆëŠ” ë²„í¼ ìŠ¤íƒì„ API ì „ì†¡ ë° ê³ ë£¨í‹´ ì¢…ë£Œ</li></ul><h4 id=worker-pool-100--sync-io>Worker Pool (100) + Sync IO<a hidden class=anchor aria-hidden=true href=#worker-pool-100--sync-io>#</a></h4><p><img loading=lazy src=/posts/worker-pool-async/image-5.png></p><p><code>runWithSync()</code> ë¶„ì„</p><ul><li>ê° workerë“¤ì€ ê³µìœ  ìì›ì¸ queue ì±„ë„ì„ ì†Œë¹„í•˜ë©°, ì›Œì»¤ì˜ ìˆ˜ê°€ ë§ì•„ì§ˆ ìˆ˜ë¡ ë‚´ë¶€ì ì¸ lockê³¼ acquireSudog(ì±„ë„ ìˆ˜ì‹  ëŒ€ê¸°)ì— ë“œëŠ” ë¹„ìš©ì´ ë°œìƒ</li><li>runtime ìŠ¤ì¼€ì¥´ëŸ¬ì— ì˜í•´, ë™ì‹œì„± ì²˜ë¦¬ì— ë“œëŠ” ë¹„ìš©ì´ ì˜ˆìƒì™¸ì˜ ì˜¤ë²„í—¤ë“œ</li><li>selectgo ì¤‘, ì˜¤ë²„í—¤ë“œì¸ sellockê³¼ acquireSudogì˜ ë¹„ìœ¨ì€ <strong>85%</strong></li></ul><h4 id=worker-pool-10--sync-io>Worker Pool (10) + Sync IO<a hidden class=anchor aria-hidden=true href=#worker-pool-10--sync-io>#</a></h4><p><img loading=lazy src=/posts/worker-pool-async/image-6.png></p><p><code>runWithSync()</code> ë¶„ì„</p><ul><li>sellock ë¹„ìœ¨ì´ 100 worker poolì— ë¹„í•´ í˜„ì €íˆ ê°ì†Œí•˜ëŠ” ê²ƒì„ í™•ì¸</li><li>selectgo ì¤‘, ì˜¤ë²„í—¤ë“œì¸ sellockê³¼ acquireSudogì˜ ë¹„ìœ¨ì€ <strong>66%</strong></li></ul><h4 id=í•˜ë‚˜ì˜-worker--async-io>í•˜ë‚˜ì˜ Worker + Async IO<a hidden class=anchor aria-hidden=true href=#í•˜ë‚˜ì˜-worker--async-io>#</a></h4><p><img loading=lazy src=/posts/worker-pool-async/image-7.png></p><p><code>run()</code> ë¶„ì„</p><ul><li>deepCopy(ê·¸ë¦¼ ì¤‘ runtime.memmove)ë¡œ ì¸í•œ ì˜¤ë²„í—¤ë“œëŠ” 10ms</li><li>selectgo ì¤‘, ì˜¤ë²„í—¤ë“œì¸ runtime.recv (ì™¸ë¶€ API í˜¸ì¶œ ì‹œ, goroutine ì¤€ë¹„ ì‘ì—…)+ deep copyì˜ ë¹„ìœ¨ì€ <strong>50%</strong></li></ul><h2 id=heap-profile>Heap Profile<a hidden class=anchor aria-hidden=true href=#heap-profile>#</a></h2><hr><p><code>run()</code> / <code>runWithSync()</code> í•¨ìˆ˜ê°€ ì‹¤í–‰ë˜ëŠ” ë™ì•ˆ ìˆ˜í–‰ë˜ëŠ” DeepCopyì— ì´ˆì ì„ ë§ì¶”ì–´ í”„ë¡œíŒŒì¼ë§</p><h4 id=worker-pool>Worker Pool<a hidden class=anchor aria-hidden=true href=#worker-pool>#</a></h4><p><img loading=lazy src=/posts/worker-pool-async/image-8.png>
deepCopy() ë¡œ ì¸í•œ ì˜¤ë²„í—¤ë“œ ì—†ìŒ</p><ul><li>100 workers ì¤‘ 8.2MB ì¤‘ HTTP Requestê°€ 7.7MB ì†Œëª¨</li></ul><h4 id=í•˜ë‚˜ì˜-worker--async-io-1>í•˜ë‚˜ì˜ Worker + Async IO<a hidden class=anchor aria-hidden=true href=#í•˜ë‚˜ì˜-worker--async-io-1>#</a></h4><p><img loading=lazy src=/posts/worker-pool-async/image-9.png>
ì´ 12.21MBì˜ run ê³¼ì • ì¤‘ ë‚´ë¶€ ë²„í¼ë¥¼ ì“°ëŠ” ì‘ì—…ì¸ Writeë¥¼ ì œì™¸í•œ ì˜¤ë²„í—¤ë“œë¥¼ ì‚°ì •</p><ul><li>worker run / Request ë¹„ìœ¨<ul><li>100 worker pool ì¤‘, 8.2MB:7.7MB</li><li><strong>12.21MB ì¸ ê²½ìš° 11.4MBê°€ HTTP Requestì— ì‚¬ìš©</strong></li></ul></li><li>deepCopyì— ë“œëŠ” ì˜¤ë²„í—¤ë“œëŠ” 150kB (1.22%) ë§¤ìš° ë¯¸ë¯¸í•œ ìˆ˜ì¤€</li></ul><h1 id=í…ŒìŠ¤íŠ¸-ê²°ê³¼>í…ŒìŠ¤íŠ¸ ê²°ê³¼<a hidden class=anchor aria-hidden=true href=#í…ŒìŠ¤íŠ¸-ê²°ê³¼>#</a></h1><hr><table><thead><tr><th>ë¶„ë¥˜</th><th>ë¶„ë‹¹ ì²˜ë¦¬ëŸ‰</th><th>CPU ì˜¤ë²„í—¤ë“œ</th><th>ë©”ëª¨ë¦¬ ì˜¤ë²„í—¤ë“œ</th></tr></thead><tbody><tr><td>10 worker</td><td>83,663</td><td>66%</td><td>0%</td></tr><tr><td>100 worker</td><td>84,042</td><td>85%</td><td>0%</td></tr><tr><td>1 worker + async</td><td>119,720</td><td>50%</td><td>1.22%</td></tr></tbody></table><h2 id=ì •ë¦¬>ì •ë¦¬<a hidden class=anchor aria-hidden=true href=#ì •ë¦¬>#</a></h2><ul><li>Worker Poolì„ ì‚¬ìš©í•  ê²½ìš°, Queueì˜ ë™ì‹œì„± ì²˜ë¦¬ë¥¼ ìœ„í•´ ì‚¬ìš©ë˜ëŠ” ì˜¤ë²„í—¤ë“œê°€ ìƒë‹¹í•˜ë‹¤</li><li>Worker Numberë¥¼ ëŠ˜ë¦¬ë”ë¼ë„ ë™ì‹œì„± ì²˜ë¦¬ ì˜¤ë²„í—¤ë“œê°€ ìƒìŠ¹ë˜ê¸°ì— number of worker ì™€ ì²˜ë¦¬ëŸ‰ì€ ë¦¬ë‹ˆì–´í•˜ê²Œ ìƒìŠ¹í•˜ì§„ ì•ŠëŠ”ë‹¤</li><li>IO Bound Taskë¥¼ ìˆ˜í–‰í•  ê²½ìš°, Worker Pool ë³´ë‹¤ëŠ” ë¹„ë™ê¸°ë¡œ ì²˜ë¦¬í•˜ëŠ” ê²ƒì´ ì„±ëŠ¥ìƒì˜ ì´ì ì´ í¬ë‹¤</li><li>CPU Bound Taskì˜ ê²½ìš°, runtimeì— ì˜í•´ goroutine ì´ ìˆ˜í–‰ë˜ê¸° ê¹Œì§€ ëŒ€ê¸° ì‹œê°„ì´ ê±¸ë¦¬ê¸°ì— worker poolì„ ì‚¬ìš©í•˜ëŠ” ê²ƒì´ ì¢‹ë‹¤</li><li>ìˆœì„œê°€ ë³´ì¥ë˜ì–´ì•¼ í•˜ëŠ” ê²½ìš°ì—ëŠ” IO Bound Task ì¼ì§€ë¼ë„ Worker Poolì„ ì‚¬ìš©í•˜ëŠ” ê²ƒì´ ì¢‹ë‹¤</li></ul></div><footer class=post-footer><ul class=post-tags><li><a href=https://dingyu.dev/tags/go/>Go</a></li><li><a href=https://dingyu.dev/tags/async/>Async</a></li><li><a href=https://dingyu.dev/tags/sync/>Sync</a></li><li><a href=https://dingyu.dev/tags/pprof/>Pprof</a></li></ul><nav class=paginav><a class=prev href=https://dingyu.dev/posts/gopher-con-2024-kubernetes-programing/><span class=title>Â« Prev</span><br><span>[Go] Gophercon 2024 - ì¿ ë²„ë„¤í‹°ìŠ¤ í”Œë«í¼ í”„ë¡œê·¸ë˜ë°</span>
</a><a class=next href=https://dingyu.dev/posts/coffee-pal/><span class=title>Next Â»</span><br><span>[DX] ì‚¬ë‚´ ì»¤í”¼ ì±— ìŠ¬ë™ ë´‡ ê°œë°œê¸°</span></a></nav></footer><div id=giscus_thread><script src=https://giscus.app/client.js data-repo=dings-things/blog data-repo-id=R_kgDON9IuAw data-category=Announcements data-category-id=DIC_kwDON9IuA84CnTai data-mapping=og:title data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=bottom data-theme=preferred_color_scheme data-lang=ko data-loading=lazy crossorigin=anonymous async></script></div></article></main><footer class=footer><span>&copy; 2025 <a href=https://dingyu.dev/>Ding's Coding Forge</a></span> Â·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>